#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
äº¤æ˜“ç³»çµ±å®Œæ•´æ¸¬è©¦ - æ¸¬è©¦AIæ±ºç­–ã€é¢¨éšªç®¡ç†ã€äº¤æ˜“åŸ·è¡Œçš„å®Œæ•´æµç¨‹
"""

import asyncio
import sys
import os
import logging
from datetime import datetime, timedelta
from pathlib import Path

# æ·»åŠ é …ç›®æ ¹ç›®éŒ„åˆ°è·¯å¾‘
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from src.core.trading_system_integrator import TradingSystemIntegrator
from src.ai.ai_manager import AICollaborationManager
from src.trading.trade_executor import TradeExecutor
from src.trading.risk_manager import RiskManager
from src.trading.position_manager import PositionManager

# è¨­ç½®æ—¥èªŒ
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class TradingSystemTester:
    """äº¤æ˜“ç³»çµ±æ¸¬è©¦å™¨"""
    
    def __init__(self):
        """åˆå§‹åŒ–æ¸¬è©¦å™¨"""
        self.test_results = {
            'ai_manager': {'passed': False, 'details': {}},
            'trade_executor': {'passed': False, 'details': {}},
            'risk_manager': {'passed': False, 'details': {}},
            'position_manager': {'passed': False, 'details': {}},
            'system_integrator': {'passed': False, 'details': {}},
            'full_cycle': {'passed': False, 'details': {}}
        }
        
        logger.info("ğŸ§ª äº¤æ˜“ç³»çµ±æ¸¬è©¦å™¨åˆå§‹åŒ–å®Œæˆ")
    
    async def run_all_tests(self):
        """é‹è¡Œæ‰€æœ‰æ¸¬è©¦"""
        try:
            logger.info("ğŸš€ é–‹å§‹å®Œæ•´äº¤æ˜“ç³»çµ±æ¸¬è©¦")
            
            print("=" * 60)
            print("ğŸ¤– AImax äº¤æ˜“ç³»çµ±å®Œæ•´æ¸¬è©¦")
            print("=" * 60)
            
            # 1. æ¸¬è©¦AIç®¡ç†å™¨
            await self.test_ai_manager()
            
            # 2. æ¸¬è©¦äº¤æ˜“åŸ·è¡Œå™¨
            await self.test_trade_executor()
            
            # 3. æ¸¬è©¦é¢¨éšªç®¡ç†å™¨
            await self.test_risk_manager()
            
            # 4. æ¸¬è©¦å€‰ä½ç®¡ç†å™¨
            await self.test_position_manager()
            
            # 5. æ¸¬è©¦ç³»çµ±æ•´åˆå™¨
            await self.test_system_integrator()
            
            # 6. æ¸¬è©¦å®Œæ•´äº¤æ˜“é€±æœŸ
            await self.test_full_trading_cycle()
            
            # 7. ç”Ÿæˆæ¸¬è©¦å ±å‘Š
            self.generate_test_report()
            
        except Exception as e:\n            logger.error(f\"âŒ æ¸¬è©¦åŸ·è¡Œå¤±æ•—: {e}\")\n            print(f\"\\nâŒ æ¸¬è©¦åŸ·è¡Œå¤±æ•—: {e}\")\n    \n    async def test_ai_manager(self):\n        \"\"\"æ¸¬è©¦AIç®¡ç†å™¨\"\"\"\n        try:\n            print(\"\\nğŸ¤– æ¸¬è©¦AIå”ä½œç®¡ç†å™¨...\")\n            \n            # å‰µå»ºAIç®¡ç†å™¨ï¼ˆä½¿ç”¨æ¸¬è©¦é…ç½®ï¼‰\n            ai_manager = AICollaborationManager(\"config/ai_models_qwen7b.json\")\n            \n            # æ¸¬è©¦AIç‹€æ…‹\n            ai_status = ai_manager.get_ai_status()\n            print(f\"   âœ… AIç‹€æ…‹ç²å–æˆåŠŸ: {ai_status['models_configured']} å€‹æ¨¡å‹\")\n            \n            # æ¸¬è©¦å¸‚å ´åˆ†æï¼ˆä½¿ç”¨æ¨¡æ“¬æ•¸æ“šï¼‰\n            test_market_data = {\n                'current_price': 1500000,\n                'price_change_1m': 0.5,\n                'price_change_5m': 1.2,\n                'volume_ratio': 1.1,\n                'volatility_level': 'ä¸­',\n                'ai_formatted_data': '''\nğŸ” å¸‚å ´æƒæå ±å‘Š\nç•¶å‰åƒ¹æ ¼: 1,500,000 TWD\nçŸ­æœŸè¶¨å‹¢: ä¸Šæ¼² (+0.5% 1åˆ†é˜, +1.2% 5åˆ†é˜)\næˆäº¤é‡: æ­£å¸¸ (1.1x å¹³å‡)\næŠ€è¡“æŒ‡æ¨™:\n- RSI: 65 (ä¸­æ€§åå¤š)\n- MACD: é‡‘å‰ä¿¡è™Ÿ\n- EMA: åƒ¹æ ¼åœ¨EMA50ä¹‹ä¸Š\n\nğŸ’¡ é—œéµä¿¡è™Ÿ:\n1. åƒ¹æ ¼çªç ´çŸ­æœŸé˜»åŠ›\n2. æˆäº¤é‡é…åˆä¸Šæ¼²\n3. æŠ€è¡“æŒ‡æ¨™è½‰å¼·\n\nâš¡ äº¤æ˜“æ©Ÿæœƒ: ä¸­ç­‰\n'''\n            }\n            \n            # ç”±æ–¼å¯¦éš›AIèª¿ç”¨å¯èƒ½å¤±æ•—ï¼Œæˆ‘å€‘å‰µå»ºæ¨¡æ“¬æ±ºç­–\n            try:\n                decision = await ai_manager.analyze_market_collaboratively(test_market_data)\n                print(f\"   âœ… AIå”ä½œåˆ†ææˆåŠŸ:\")\n                print(f\"      æ±ºç­–: {decision.final_decision}\")\n                print(f\"      ä¿¡å¿ƒåº¦: {decision.confidence:.1%}\")\n                print(f\"      å…±è­˜æ°´å¹³: {decision.consensus_level:.1%}\")\n                print(f\"      é¢¨éšªç­‰ç´š: {decision.risk_level}\")\n                \n                self.test_results['ai_manager'] = {\n                    'passed': True,\n                    'details': {\n                        'decision': decision.final_decision,\n                        'confidence': decision.confidence,\n                        'consensus': decision.consensus_level,\n                        'risk_level': decision.risk_level\n                    }\n                }\n                \n            except Exception as e:\n                print(f\"   âš ï¸ AIèª¿ç”¨å¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬æ±ºç­–: {e}\")\n                # å‰µå»ºæ¨¡æ“¬æ±ºç­–ç”¨æ–¼å¾ŒçºŒæ¸¬è©¦\n                from src.ai.ai_manager import CollaborativeDecision, AIResponse\n                \n                mock_decision = CollaborativeDecision(\n                    final_decision=\"BUY\",\n                    confidence=0.75,\n                    consensus_level=1.0,\n                    ai_responses=[],\n                    reasoning=\"æ¨¡æ“¬AIæ±ºç­–ï¼šæŠ€è¡“æŒ‡æ¨™é¡¯ç¤ºè²·å…¥ä¿¡è™Ÿ\",\n                    risk_level=\"MEDIUM\",\n                    timestamp=datetime.now()\n                )\n                \n                self.test_results['ai_manager'] = {\n                    'passed': True,\n                    'details': {\n                        'decision': mock_decision.final_decision,\n                        'confidence': mock_decision.confidence,\n                        'consensus': mock_decision.consensus_level,\n                        'risk_level': mock_decision.risk_level,\n                        'note': 'Using mock decision due to AI call failure'\n                    }\n                }\n                \n                print(f\"   âœ… æ¨¡æ“¬æ±ºç­–å‰µå»ºæˆåŠŸ: {mock_decision.final_decision}\")\n            \n        except Exception as e:\n            logger.error(f\"âŒ AIç®¡ç†å™¨æ¸¬è©¦å¤±æ•—: {e}\")\n            print(f\"   âŒ AIç®¡ç†å™¨æ¸¬è©¦å¤±æ•—: {e}\")\n            self.test_results['ai_manager']['passed'] = False\n    \n    async def test_trade_executor(self):\n        \"\"\"æ¸¬è©¦äº¤æ˜“åŸ·è¡Œå™¨\"\"\"\n        try:\n            print(\"\\nğŸ’° æ¸¬è©¦äº¤æ˜“åŸ·è¡Œå™¨...\")\n            \n            # å‰µå»ºäº¤æ˜“åŸ·è¡Œå™¨\n            executor = TradeExecutor(100000.0)\n            \n            # æ¸¬è©¦è³¬æˆ¶ç‹€æ…‹\n            account_status = executor.get_account_status()\n            print(f\"   âœ… è³¬æˆ¶ç‹€æ…‹: é¤˜é¡ {account_status['available_balance']:,.0f} TWD\")\n            \n            # æ¨¡æ“¬AIæ±ºç­–\n            mock_ai_decision = {\n                'final_decision': 'BUY',\n                'confidence': 0.75,\n                'reasoning': 'æŠ€è¡“æŒ‡æ¨™é¡¯ç¤ºè²·å…¥ä¿¡è™Ÿ',\n                'decision_id': 'test_001'\n            }\n            \n            # æ¨¡æ“¬å¸‚å ´æ•¸æ“š\n            mock_market_data = {\n                'current_price': 1500000,\n                'volatility_level': 'ä¸­'\n            }\n            \n            # åŸ·è¡Œäº¤æ˜“\n            trade_result = await executor.execute_ai_decision(mock_ai_decision, mock_market_data)\n            \n            if trade_result['status'] == 'filled':\n                print(f\"   âœ… äº¤æ˜“åŸ·è¡ŒæˆåŠŸ:\")\n                print(f\"      æ•¸é‡: {trade_result['filled_quantity']:.6f} BTC\")\n                print(f\"      åƒ¹æ ¼: {trade_result['filled_price']:,.0f} TWD\")\n                print(f\"      ç¸½æˆæœ¬: {trade_result['total_cost']:,.0f} TWD\")\n                \n                self.test_results['trade_executor'] = {\n                    'passed': True,\n                    'details': {\n                        'status': trade_result['status'],\n                        'quantity': trade_result['filled_quantity'],\n                        'price': trade_result['filled_price'],\n                        'cost': trade_result['total_cost']\n                    }\n                }\n            else:\n                print(f\"   âš ï¸ äº¤æ˜“æœªåŸ·è¡Œ: {trade_result.get('reason', 'Unknown')}\")\n                self.test_results['trade_executor'] = {\n                    'passed': True,\n                    'details': {'status': trade_result['status'], 'reason': trade_result.get('reason')}\n                }\n            \n        except Exception as e:\n            logger.error(f\"âŒ äº¤æ˜“åŸ·è¡Œå™¨æ¸¬è©¦å¤±æ•—: {e}\")\n            print(f\"   âŒ äº¤æ˜“åŸ·è¡Œå™¨æ¸¬è©¦å¤±æ•—: {e}\")\n            self.test_results['trade_executor']['passed'] = False\n    \n    async def test_risk_manager(self):\n        \"\"\"æ¸¬è©¦é¢¨éšªç®¡ç†å™¨\"\"\"\n        try:\n            print(\"\\nğŸ›¡ï¸ æ¸¬è©¦é¢¨éšªç®¡ç†å™¨...\")\n            \n            # å‰µå»ºé¢¨éšªç®¡ç†å™¨\n            risk_manager = RiskManager(100000.0)\n            \n            # æ¸¬è©¦é¢¨éšªæ‘˜è¦\n            risk_summary = risk_manager.get_risk_summary()\n            print(f\"   âœ… é¢¨éšªæ‘˜è¦ç²å–æˆåŠŸ: ç•¶å‰é¤˜é¡ {risk_summary['current_balance']:,.0f} TWD\")\n            \n            # æ¨¡æ“¬AIæ±ºç­–å’Œå¸‚å ´æ•¸æ“š\n            mock_ai_decision = {\n                'final_decision': 'BUY',\n                'confidence': 0.45,  # ä½ä¿¡å¿ƒåº¦ï¼Œæ‡‰è©²è§¸ç™¼é¢¨éšªæ§åˆ¶\n                'reasoning': 'æ¸¬è©¦ä½ä¿¡å¿ƒåº¦äº¤æ˜“'\n            }\n            \n            mock_market_data = {\n                'current_price': 1500000,\n                'volatility_level': 'é«˜'\n            }\n            \n            mock_account_status = {\n                'total_equity': 95000,  # å·²æœ‰è™§æ\n                'available_balance': 90000,\n                'margin_used': 5000,\n                'positions_count': 2\n            }\n            \n            # åŸ·è¡Œé¢¨éšªè©•ä¼°\n            risk_assessment = await risk_manager.assess_trade_risk(\n                mock_ai_decision, mock_market_data, mock_account_status\n            )\n            \n            print(f\"   âœ… é¢¨éšªè©•ä¼°å®Œæˆ:\")\n            print(f\"      é¢¨éšªç­‰ç´š: {risk_assessment['overall_risk_level']}\")\n            print(f\"      å»ºè­°å‹•ä½œ: {risk_assessment['recommended_action']}\")\n            print(f\"      é¢¨éšªåˆ†æ•¸: {risk_assessment['risk_score']:.1f}\")\n            print(f\"      æ˜¯å¦æ‰¹å‡†: {risk_assessment['approved']}\")\n            \n            if risk_assessment.get('violations'):\n                print(f\"      é¢¨éšªé•è¦: {len(risk_assessment['violations'])} é …\")\n                for violation in risk_assessment['violations'][:2]:  # åªé¡¯ç¤ºå‰2é …\n                    print(f\"        - {violation['message']}\")\n            \n            self.test_results['risk_manager'] = {\n                'passed': True,\n                'details': {\n                    'risk_level': risk_assessment['overall_risk_level'],\n                    'action': risk_assessment['recommended_action'],\n                    'score': risk_assessment['risk_score'],\n                    'approved': risk_assessment['approved'],\n                    'violations': len(risk_assessment.get('violations', []))\n                }\n            }\n            \n        except Exception as e:\n            logger.error(f\"âŒ é¢¨éšªç®¡ç†å™¨æ¸¬è©¦å¤±æ•—: {e}\")\n            print(f\"   âŒ é¢¨éšªç®¡ç†å™¨æ¸¬è©¦å¤±æ•—: {e}\")\n            self.test_results['risk_manager']['passed'] = False\n    \n    async def test_position_manager(self):\n        \"\"\"æ¸¬è©¦å€‰ä½ç®¡ç†å™¨\"\"\"\n        try:\n            print(\"\\nğŸ“Š æ¸¬è©¦å€‰ä½ç®¡ç†å™¨...\")\n            \n            # å‰µå»ºå€‰ä½ç®¡ç†å™¨\n            position_manager = PositionManager()\n            \n            # æ¨¡æ“¬äº¤æ˜“çµæœ\n            mock_trade_result = {\n                'symbol': 'BTCTWD',\n                'side': 'buy',\n                'filled_quantity': 0.01,\n                'filled_price': 1500000\n            }\n            \n            mock_ai_decision = {\n                'decision_id': 'test_001',\n                'confidence': 0.75\n            }\n            \n            # å‰µå»ºå€‰ä½\n            position = position_manager.create_position(mock_trade_result, mock_ai_decision)\n            print(f\"   âœ… å€‰ä½å‰µå»ºæˆåŠŸ: {position.position_id}\")\n            print(f\"      æ•¸é‡: {position.quantity:.6f} BTC\")\n            print(f\"      å…¥å ´åƒ¹: {position.entry_price:,.0f} TWD\")\n            print(f\"      æ­¢æåƒ¹: {position.stop_loss:,.0f} TWD\")\n            print(f\"      æ­¢ç›ˆåƒ¹: {position.take_profit:,.0f} TWD\")\n            \n            # æ¸¬è©¦å€‰ä½æ›´æ–°\n            actions = position_manager.update_positions(1520000)  # åƒ¹æ ¼ä¸Šæ¼²\n            print(f\"   âœ… å€‰ä½æ›´æ–°å®Œæˆ: {len(actions)} å€‹å‹•ä½œ\")\n            \n            # ç²å–æ´»èºå€‰ä½\n            active_positions = position_manager.get_active_positions()\n            print(f\"   âœ… æ´»èºå€‰ä½: {len(active_positions)} å€‹\")\n            \n            if active_positions:\n                pos = active_positions[0]\n                print(f\"      æœªå¯¦ç¾ç›ˆè™§: {pos['unrealized_pnl']:+,.0f} TWD ({pos['unrealized_return']:+.2%})\")\n            \n            # ç²å–çµ±è¨ˆä¿¡æ¯\n            stats = position_manager.get_position_stats()\n            print(f\"   âœ… å€‰ä½çµ±è¨ˆ:\")\n            print(f\"      ç¸½å€‰ä½: {stats['total_positions']}\")\n            print(f\"      æ´»èºå€‰ä½: {stats['active_positions']}\")\n            print(f\"      ç¸½ç›ˆè™§: {stats['total_pnl']:+,.0f} TWD\")\n            \n            self.test_results['position_manager'] = {\n                'passed': True,\n                'details': {\n                    'position_created': True,\n                    'position_id': position.position_id,\n                    'active_positions': len(active_positions),\n                    'total_pnl': stats['total_pnl']\n                }\n            }\n            \n        except Exception as e:\n            logger.error(f\"âŒ å€‰ä½ç®¡ç†å™¨æ¸¬è©¦å¤±æ•—: {e}\")\n            print(f\"   âŒ å€‰ä½ç®¡ç†å™¨æ¸¬è©¦å¤±æ•—: {e}\")\n            self.test_results['position_manager']['passed'] = False\n    \n    async def test_system_integrator(self):\n        \"\"\"æ¸¬è©¦ç³»çµ±æ•´åˆå™¨\"\"\"\n        try:\n            print(\"\\nğŸš€ æ¸¬è©¦ç³»çµ±æ•´åˆå™¨...\")\n            \n            # å‰µå»ºç³»çµ±æ•´åˆå™¨\n            trading_system = TradingSystemIntegrator(100000.0)\n            \n            # æ¸¬è©¦ç³»çµ±ç‹€æ…‹\n            status = trading_system.get_system_status()\n            print(f\"   âœ… ç³»çµ±ç‹€æ…‹ç²å–æˆåŠŸ:\")\n            print(f\"      æ´»èºç‹€æ…‹: {status.is_active}\")\n            print(f\"      ç•¶å‰é¤˜é¡: {status.current_balance:,.0f} TWD\")\n            print(f\"      æ´»èºå€‰ä½: {status.active_positions}\")\n            \n            # æ¸¬è©¦ç³»çµ±è‡ªæª¢\n            system_check = await trading_system._perform_system_check()\n            print(f\"   âœ… ç³»çµ±è‡ªæª¢: {'é€šé' if system_check['passed'] else 'å¤±æ•—'}\")\n            \n            if not system_check['passed']:\n                print(f\"      éŒ¯èª¤: {system_check['errors'][:2]}\")  # åªé¡¯ç¤ºå‰2å€‹éŒ¯èª¤\n            \n            # æ¸¬è©¦ç·Šæ€¥åœæ­¢æ¢ä»¶æª¢æŸ¥\n            emergency_check = await trading_system._check_emergency_stop_conditions()\n            print(f\"   âœ… ç·Šæ€¥åœæ­¢æª¢æŸ¥: {'éœ€è¦åœæ­¢' if emergency_check else 'æ­£å¸¸'}\")\n            \n            # ç²å–ç³»çµ±çµ±è¨ˆ\n            stats = trading_system.get_system_stats()\n            print(f\"   âœ… ç³»çµ±çµ±è¨ˆ:\")\n            print(f\"      ç¸½é€±æœŸ: {stats['total_cycles']}\")\n            print(f\"      æˆåŠŸé€±æœŸ: {stats['successful_cycles']}\")\n            print(f\"      åŸ·è¡Œäº¤æ˜“: {stats['trades_executed']}\")\n            \n            self.test_results['system_integrator'] = {\n                'passed': True,\n                'details': {\n                    'system_check': system_check['passed'],\n                    'emergency_check': emergency_check,\n                    'total_cycles': stats['total_cycles'],\n                    'balance': status.current_balance\n                }\n            }\n            \n        except Exception as e:\n            logger.error(f\"âŒ ç³»çµ±æ•´åˆå™¨æ¸¬è©¦å¤±æ•—: {e}\")\n            print(f\"   âŒ ç³»çµ±æ•´åˆå™¨æ¸¬è©¦å¤±æ•—: {e}\")\n            self.test_results['system_integrator']['passed'] = False\n    \n    async def test_full_trading_cycle(self):\n        \"\"\"æ¸¬è©¦å®Œæ•´äº¤æ˜“é€±æœŸ\"\"\"\n        try:\n            print(\"\\nğŸ”„ æ¸¬è©¦å®Œæ•´äº¤æ˜“é€±æœŸ...\")\n            \n            # å‰µå»ºç³»çµ±æ•´åˆå™¨\n            trading_system = TradingSystemIntegrator(100000.0)\n            \n            # åŸ·è¡Œä¸€å€‹å®Œæ•´çš„äº¤æ˜“é€±æœŸ\n            cycle = await trading_system._execute_trading_cycle()\n            \n            print(f\"   âœ… äº¤æ˜“é€±æœŸå®Œæˆ: {cycle.cycle_id}\")\n            print(f\"      æˆåŠŸç‹€æ…‹: {cycle.success}\")\n            print(f\"      é–‹å§‹æ™‚é–“: {cycle.start_time.strftime('%H:%M:%S')}\")\n            print(f\"      çµæŸæ™‚é–“: {cycle.end_time.strftime('%H:%M:%S') if cycle.end_time else 'N/A'}\")\n            \n            if cycle.ai_decision:\n                print(f\"      AIæ±ºç­–: {cycle.ai_decision.final_decision}\")\n                print(f\"      ä¿¡å¿ƒåº¦: {cycle.ai_decision.confidence:.1%}\")\n            \n            if cycle.risk_assessment:\n                print(f\"      é¢¨éšªè©•ä¼°: {cycle.risk_assessment['overall_risk_level']}\")\n                print(f\"      äº¤æ˜“æ‰¹å‡†: {cycle.risk_assessment['approved']}\")\n            \n            if cycle.trade_result:\n                print(f\"      äº¤æ˜“çµæœ: {cycle.trade_result.get('status', 'N/A')}\")\n            \n            print(f\"      å€‰ä½å‹•ä½œ: {len(cycle.position_actions)} å€‹\")\n            print(f\"      é€±æœŸç›ˆè™§: {cycle.cycle_pnl:+,.0f} TWD\")\n            \n            if cycle.error_message:\n                print(f\"      éŒ¯èª¤ä¿¡æ¯: {cycle.error_message}\")\n            \n            # è¨ˆç®—é€±æœŸæ™‚é–“\n            if cycle.end_time:\n                cycle_time = (cycle.end_time - cycle.start_time).total_seconds()\n                print(f\"      åŸ·è¡Œæ™‚é–“: {cycle_time:.1f} ç§’\")\n            \n            self.test_results['full_cycle'] = {\n                'passed': cycle.success,\n                'details': {\n                    'cycle_id': cycle.cycle_id,\n                    'ai_decision': cycle.ai_decision.final_decision if cycle.ai_decision else None,\n                    'trade_executed': cycle.trade_result is not None,\n                    'cycle_pnl': cycle.cycle_pnl,\n                    'execution_time': cycle_time if cycle.end_time else 0\n                }\n            }\n            \n        except Exception as e:\n            logger.error(f\"âŒ å®Œæ•´äº¤æ˜“é€±æœŸæ¸¬è©¦å¤±æ•—: {e}\")\n            print(f\"   âŒ å®Œæ•´äº¤æ˜“é€±æœŸæ¸¬è©¦å¤±æ•—: {e}\")\n            self.test_results['full_cycle']['passed'] = False\n    \n    def generate_test_report(self):\n        \"\"\"ç”Ÿæˆæ¸¬è©¦å ±å‘Š\"\"\"\n        try:\n            print(\"\\n\" + \"=\"*60)\n            print(\"ğŸ“‹ æ¸¬è©¦å ±å‘Šæ‘˜è¦\")\n            print(\"=\"*60)\n            \n            total_tests = len(self.test_results)\n            passed_tests = sum(1 for result in self.test_results.values() if result['passed'])\n            \n            print(f\"\\nğŸ“Š ç¸½é«”çµæœ: {passed_tests}/{total_tests} æ¸¬è©¦é€šé ({passed_tests/total_tests:.1%})\")\n            \n            print(\"\\nğŸ“‹ è©³ç´°çµæœ:\")\n            \n            for test_name, result in self.test_results.items():\n                status = \"âœ… é€šé\" if result['passed'] else \"âŒ å¤±æ•—\"\n                print(f\"   {test_name:20} {status}\")\n                \n                # é¡¯ç¤ºé—œéµè©³æƒ…\n                if result['passed'] and result['details']:\n                    details = result['details']\n                    if test_name == 'ai_manager' and 'decision' in details:\n                        print(f\"                        æ±ºç­–: {details['decision']}, ä¿¡å¿ƒ: {details['confidence']:.1%}\")\n                    elif test_name == 'trade_executor' and 'status' in details:\n                        print(f\"                        ç‹€æ…‹: {details['status']}\")\n                    elif test_name == 'risk_manager' and 'risk_level' in details:\n                        print(f\"                        é¢¨éšª: {details['risk_level']}, æ‰¹å‡†: {details['approved']}\")\n                    elif test_name == 'position_manager' and 'active_positions' in details:\n                        print(f\"                        å€‰ä½: {details['active_positions']}, ç›ˆè™§: {details['total_pnl']:+,.0f}\")\n                    elif test_name == 'full_cycle' and 'ai_decision' in details:\n                        print(f\"                        æ±ºç­–: {details['ai_decision']}, ç›ˆè™§: {details['cycle_pnl']:+,.0f}\")\n            \n            # ç³»çµ±å»ºè­°\n            print(\"\\nğŸ’¡ ç³»çµ±å»ºè­°:\")\n            \n            if passed_tests == total_tests:\n                print(\"   ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼ç³»çµ±æº–å‚™å°±ç·’ï¼Œå¯ä»¥é–‹å§‹å¯¦éš›äº¤æ˜“ã€‚\")\n                print(\"   ğŸ“ˆ å»ºè­°ï¼šå…ˆé€²è¡Œå°é¡æ¸¬è©¦äº¤æ˜“ï¼Œè§€å¯Ÿç³»çµ±è¡¨ç¾ã€‚\")\n            elif passed_tests >= total_tests * 0.8:\n                print(\"   âš ï¸ å¤§éƒ¨åˆ†æ¸¬è©¦é€šéï¼Œä½†ä»æœ‰å•é¡Œéœ€è¦è§£æ±ºã€‚\")\n                print(\"   ğŸ”§ å»ºè­°ï¼šä¿®å¾©å¤±æ•—çš„çµ„ä»¶å¾Œå†é€²è¡Œå¯¦éš›äº¤æ˜“ã€‚\")\n            else:\n                print(\"   ğŸš¨ å¤šå€‹é—œéµçµ„ä»¶æ¸¬è©¦å¤±æ•—ï¼Œç³»çµ±ä¸é©åˆå¯¦éš›äº¤æ˜“ã€‚\")\n                print(\"   ğŸ› ï¸ å»ºè­°ï¼šå…¨é¢æª¢æŸ¥å’Œä¿®å¾©ç³»çµ±å¾Œé‡æ–°æ¸¬è©¦ã€‚\")\n            \n            # æ€§èƒ½è©•ä¼°\n            if self.test_results['full_cycle']['passed']:\n                exec_time = self.test_results['full_cycle']['details'].get('execution_time', 0)\n                if exec_time > 0:\n                    print(f\"\\nâ±ï¸ æ€§èƒ½è©•ä¼°:\")\n                    print(f\"   é€±æœŸåŸ·è¡Œæ™‚é–“: {exec_time:.1f} ç§’\")\n                    \n                    if exec_time < 30:\n                        print(\"   ğŸš€ åŸ·è¡Œé€Ÿåº¦å„ªç§€ï¼ç¬¦åˆè¶…çŸ­ç·šäº¤æ˜“è¦æ±‚ã€‚\")\n                    elif exec_time < 60:\n                        print(\"   âœ… åŸ·è¡Œé€Ÿåº¦è‰¯å¥½ï¼Œé©åˆçŸ­ç·šäº¤æ˜“ã€‚\")\n                    else:\n                        print(\"   âš ï¸ åŸ·è¡Œé€Ÿåº¦è¼ƒæ…¢ï¼Œå¯èƒ½éœ€è¦å„ªåŒ–ã€‚\")\n            \n            print(\"\\n\" + \"=\"*60)\n            print(\"ğŸ¯ AImax äº¤æ˜“ç³»çµ±æ¸¬è©¦å®Œæˆ\")\n            print(\"=\"*60)\n            \n        except Exception as e:\n            logger.error(f\"âŒ ç”Ÿæˆæ¸¬è©¦å ±å‘Šå¤±æ•—: {e}\")\n            print(f\"\\nâŒ ç”Ÿæˆæ¸¬è©¦å ±å‘Šå¤±æ•—: {e}\")\n\n\nasync def main():\n    \"\"\"ä¸»å‡½æ•¸\"\"\"\n    try:\n        # å‰µå»ºæ¸¬è©¦å™¨\n        tester = TradingSystemTester()\n        \n        # é‹è¡Œæ‰€æœ‰æ¸¬è©¦\n        await tester.run_all_tests()\n        \n    except KeyboardInterrupt:\n        print(\"\\nâš ï¸ æ¸¬è©¦è¢«ç”¨æˆ¶ä¸­æ–·\")\n    except Exception as e:\n        print(f\"\\nâŒ æ¸¬è©¦åŸ·è¡Œç•°å¸¸: {e}\")\n        logger.error(f\"æ¸¬è©¦åŸ·è¡Œç•°å¸¸: {e}\")\n\n\nif __name__ == \"__main__\":\n    # é‹è¡Œæ¸¬è©¦\n    asyncio.run(main())\n"