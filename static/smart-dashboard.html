<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AImax æ™ºèƒ½å¹³è¡¡äº¤æ˜“å„€è¡¨æ¿ - 83.3%å‹ç‡ç­–ç•¥</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #6c5ce7;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .data-source-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .source-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        .source-dot.static { background: #ffc107; }
        .source-dot.fallback { background: #dc3545; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }
        
        .price-display {
            font-size: 2.5em;
            font-weight: 700;
            color: #00b894;
            margin: 15px 0;
            text-align: center;
        }
        
        .price-change {
            text-align: center;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        .price-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .detail-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .detail-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: #333;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .last-update {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 15px;
        }
        
        .system-status {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .system-status h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .status-item {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
        }
        
        .status-value {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .status-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .refresh-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5a4fcf;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn.secondary {
            background: #74b9ff;
        }
        
        .btn.secondary:hover {
            background: #0984e3;
        }
        
        .error-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #ffeaa7;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6c5ce7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .price-display {
                font-size: 2em;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .price-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AImax æ™ºèƒ½å¹³è¡¡äº¤æ˜“å„€è¡¨æ¿</h1>
            <p>83.3%å‹ç‡ç­–ç•¥ v1.0-smart-balanced - æ··åˆæ•¸æ“šæº</p>
            <div class="data-source-indicator" id="dataSourceIndicator">
                <span class="source-dot" id="sourceDot"></span>
                <span id="sourceText">æ­£åœ¨è¼‰å…¥...</span>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <!-- BTCåƒ¹æ ¼å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">ğŸ’° BTC/TWD åƒ¹æ ¼</span>
                </div>
                
                <div class="price-display" id="priceDisplay">
                    <span class="loading"></span> è¼‰å…¥ä¸­...
                </div>
                
                <div class="price-change" id="priceChange">æ­£åœ¨ç²å–æ•¸æ“š...</div>
                
                <div class="price-details">
                    <div class="detail-item">
                        <div class="detail-label">è²·å…¥åƒ¹</div>
                        <div class="detail-value" id="buyPrice">--</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è³£å‡ºåƒ¹</div>
                        <div class="detail-value" id="sellPrice">--</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">24å°æ™‚æœ€é«˜</div>
                        <div class="detail-value" id="highPrice">--</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">24å°æ™‚æœ€ä½</div>
                        <div class="detail-value" id="lowPrice">--</div>
                    </div>
                </div>
                
                <div class="refresh-controls">
                    <button class="btn" id="refreshBtn" onclick="updatePrice()">
                        ğŸ”„ åˆ·æ–°åƒ¹æ ¼
                    </button>
                    <button class="btn secondary" id="switchSourceBtn" onclick="switchDataSource()">
                        ğŸ”€ åˆ‡æ›æ•¸æ“šæº
                    </button>
                </div>
                
                <div class="last-update" id="lastUpdate">ç­‰å¾…æ•¸æ“š...</div>
                
                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </div>
            
            <!-- ç³»çµ±ç‹€æ…‹å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">ğŸ“Š ç³»çµ±ç‹€æ…‹</span>
                </div>
                
                <div class="system-status">
                    <h3>ğŸ¯ 85%å‹ç‡ç­–ç•¥é‹è¡Œä¸­</h3>
                    <p>æ™ºèƒ½é »ç‡æ§åˆ¶ + é«˜é »äº¤æ˜“ç³»çµ±</p>
                    
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-value" id="systemStatus">é‹è¡Œæ­£å¸¸</div>
                            <div class="status-label">ç³»çµ±ç‹€æ…‹</div>
                        </div>
                        <div class="status-item">
                            <div class="status-value" id="dataFreshness">å¯¦æ™‚</div>
                            <div class="status-label">æ•¸æ“šæ–°é®®åº¦</div>
                        </div>
                        <div class="status-item">
                            <div class="status-value" id="apiCalls">0</div>
                            <div class="status-label">ä»Šæ—¥APIèª¿ç”¨</div>
                        </div>
                        <div class="status-item">
                            <div class="status-value" id="uptime">è¨ˆç®—ä¸­</div>
                            <div class="status-label">é‹è¡Œæ™‚é–“</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ™ºèƒ½æ•¸æ“šæºç®¡ç†å™¨
        class SmartDataSourceManager {
            constructor() {
                this.currentSource = 'auto'; // auto, static, realtime
                this.staticApiUrl = '/api/btc-price.json';
                this.corsProxyUrl = 'https://api.allorigins.win/get?url=';
                this.maxApiUrl = 'https://max-api.maicoin.com/api/v2/tickers/btctwd';
                this.lastSuccessfulSource = null;
                this.apiCallCount = 0;
                this.startTime = new Date();
                
                this.updateSourceIndicator('æ­£åœ¨åˆå§‹åŒ–...');
            }
            
            updateSourceIndicator(text, type = 'loading') {
                const indicator = document.getElementById('dataSourceIndicator');
                const dot = document.getElementById('sourceDot');
                const textEl = document.getElementById('sourceText');
                
                dot.className = `source-dot ${type}`;
                textEl.textContent = text;
            }
            
            async fetchStaticData() {
                try {
                    console.log('ğŸ“Š å˜—è©¦ç²å–éœæ…‹APIæ•¸æ“š...');
                    
                    const response = await fetch(this.staticApiUrl + '?t=' + Date.now(), {
                        cache: 'no-cache'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`éœæ…‹APIéŸ¿æ‡‰éŒ¯èª¤: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        this.updateSourceIndicator('GitHub Actions éœæ…‹æ•¸æ“š', 'static');
                        this.lastSuccessfulSource = 'static';
                        
                        // è¨ˆç®—æ•¸æ“šå¹´é½¡
                        const dataTime = new Date(data.timestamp);
                        const ageSeconds = (new Date() - dataTime) / 1000;
                        
                        return {
                            ...data.data,
                            _meta: {
                                source: 'GitHub Actions (éœæ…‹)',
                                data_age_seconds: Math.floor(ageSeconds),
                                fetch_method: 'static_api',
                                response_time_ms: data.meta?.api_response_time_ms || 0
                            }
                        };
                    } else {
                        throw new Error('éœæ…‹æ•¸æ“šæ ¼å¼ç„¡æ•ˆ');
                    }
                    
                } catch (error) {
                    console.warn('âš ï¸ éœæ…‹APIç²å–å¤±æ•—:', error.message);
                    throw error;
                }
            }
            
            async fetchRealtimeData() {
                try {
                    console.log('ğŸ“¡ å˜—è©¦ç²å–å¯¦æ™‚APIæ•¸æ“š...');
                    this.apiCallCount++;
                    
                    const proxyUrl = this.corsProxyUrl + encodeURIComponent(this.maxApiUrl);
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) {
                        throw new Error(`CORSä»£ç†éŸ¿æ‡‰éŒ¯èª¤: ${response.status}`);
                    }
                    
                    const proxyData = await response.json();
                    
                    if (proxyData.status.http_code === 200) {
                        const data = JSON.parse(proxyData.contents);
                        
                        if (data && data.last) {
                            this.updateSourceIndicator('MAX API å¯¦æ™‚æ•¸æ“š', 'realtime');
                            this.lastSuccessfulSource = 'realtime';
                            
                            // è¨ˆç®—24å°æ™‚è®ŠåŒ–
                            const price = parseFloat(data.last);
                            const open = parseFloat(data.open || price);
                            const change24h = ((price - open) / open) * 100;
                            
                            return {
                                price: price,
                                buy_price: parseFloat(data.buy || price),
                                sell_price: parseFloat(data.sell || price),
                                volume: parseFloat(data.vol || 0),
                                high_24h: parseFloat(data.high || price),
                                low_24h: parseFloat(data.low || price),
                                open_24h: open,
                                formatted_price: `NT$${price.toLocaleString()}`,
                                price_change_24h: price - open,
                                price_change_percent_24h: change24h,
                                _meta: {
                                    source: 'MAX API v2 (å¯¦æ™‚)',
                                    data_age_seconds: 0,
                                    fetch_method: 'cors_proxy',
                                    response_time_ms: 0
                                }
                            };
                        }
                    }
                    
                    throw new Error('å¯¦æ™‚APIæ•¸æ“šæ ¼å¼ç„¡æ•ˆ');
                    
                } catch (error) {
                    console.warn('âš ï¸ å¯¦æ™‚APIç²å–å¤±æ•—:', error.message);
                    throw error;
                }
            }
            
            async fetchData() {
                const errors = [];
                
                // æ™ºèƒ½é¸æ“‡æ•¸æ“šæº
                const sources = this.currentSource === 'auto' 
                    ? ['static', 'realtime'] 
                    : [this.currentSource];
                
                for (const source of sources) {
                    try {
                        if (source === 'static') {
                            return await this.fetchStaticData();
                        } else if (source === 'realtime') {
                            return await this.fetchRealtimeData();
                        }
                    } catch (error) {
                        errors.push(`${source}: ${error.message}`);
                        continue;
                    }
                }
                
                // å¦‚æœéƒ½å¤±æ•—äº†ï¼Œå˜—è©¦ä½¿ç”¨ä¸Šæ¬¡æˆåŠŸçš„æº
                if (this.lastSuccessfulSource && !sources.includes(this.lastSuccessfulSource)) {
                    try {
                        if (this.lastSuccessfulSource === 'static') {
                            return await this.fetchStaticData();
                        } else if (this.lastSuccessfulSource === 'realtime') {
                            return await this.fetchRealtimeData();
                        }
                    } catch (error) {
                        errors.push(`fallback: ${error.message}`);
                    }
                }
                
                this.updateSourceIndicator('æ‰€æœ‰æ•¸æ“šæºå¤±æ•—', 'fallback');
                throw new Error('æ‰€æœ‰æ•¸æ“šæºéƒ½ä¸å¯ç”¨: ' + errors.join(', '));
            }
            
            switchSource() {
                const sources = ['auto', 'static', 'realtime'];
                const currentIndex = sources.indexOf(this.currentSource);
                this.currentSource = sources[(currentIndex + 1) % sources.length];
                
                const sourceNames = {
                    'auto': 'è‡ªå‹•é¸æ“‡',
                    'static': 'éœæ…‹æ•¸æ“š',
                    'realtime': 'å¯¦æ™‚æ•¸æ“š'
                };
                
                console.log(`ğŸ”€ åˆ‡æ›åˆ°æ•¸æ“šæº: ${sourceNames[this.currentSource]}`);
                return this.currentSource;
            }
        }
        
        // å…¨å±€è®Šé‡
        const dataManager = new SmartDataSourceManager();
        let updateTimer = null;
        let currentPrice = null;
        
        // æ›´æ–°åƒ¹æ ¼å‡½æ•¸
        async function updatePrice() {
            const priceDisplay = document.getElementById('priceDisplay');
            const priceChange = document.getElementById('priceChange');
            const lastUpdate = document.getElementById('lastUpdate');
            const errorMessage = document.getElementById('errorMessage');
            const refreshBtn = document.getElementById('refreshBtn');
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<span class=\"loading\"></span> æ›´æ–°ä¸­...';
            errorMessage.style.display = 'none';
            
            try {
                const data = await dataManager.fetchData();
                
                if (data && data.price) {
                    const newPrice = data.price;
                    const oldPrice = currentPrice;
                    
                    // æ›´æ–°åƒ¹æ ¼é¡¯ç¤º
                    priceDisplay.textContent = data.formatted_price || `NT$${newPrice.toLocaleString()}`;
                    priceDisplay.style.color = '#00b894';
                    
                    // æ›´æ–°è©³ç´°ä¿¡æ¯
                    document.getElementById('buyPrice').textContent = 
                        data.buy_price ? `NT$${data.buy_price.toLocaleString()}` : '--';
                    document.getElementById('sellPrice').textContent = 
                        data.sell_price ? `NT$${data.sell_price.toLocaleString()}` : '--';
                    document.getElementById('highPrice').textContent = 
                        data.high_24h ? `NT$${data.high_24h.toLocaleString()}` : '--';
                    document.getElementById('lowPrice').textContent = 
                        data.low_24h ? `NT$${data.low_24h.toLocaleString()}` : '--';
                    
                    // é¡¯ç¤º24å°æ™‚è®ŠåŒ–
                    const change24h = data.price_change_percent_24h || 0;
                    const changeElement = document.getElementById('priceChange');
                    changeElement.textContent = `24å°æ™‚è®ŠåŒ–: ${change24h >= 0 ? '+' : ''}${change24h.toFixed(2)}%`;
                    changeElement.style.color = change24h >= 0 ? '#00b894' : '#e17055';
                    
                    // æ›´æ–°ç³»çµ±ç‹€æ…‹
                    const dataAge = data._meta?.data_age_seconds || 0;
                    document.getElementById('dataFreshness').textContent = 
                        dataAge < 60 ? 'å¯¦æ™‚' : `${Math.floor(dataAge/60)}åˆ†é˜å‰`;
                    document.getElementById('apiCalls').textContent = dataManager.apiCallCount;
                    
                    // è¨ˆç®—é‹è¡Œæ™‚é–“
                    const uptime = Math.floor((new Date() - dataManager.startTime) / 1000 / 60);
                    document.getElementById('uptime').textContent = `${uptime}åˆ†é˜`;
                    
                    currentPrice = newPrice;
                    lastUpdate.textContent = `æœ€å¾Œæ›´æ–°: ${new Date().toLocaleString('zh-TW')} (${data._meta?.source || 'æœªçŸ¥'})`;
                    
                    console.log(`âœ… åƒ¹æ ¼æ›´æ–°æˆåŠŸ: ${data.formatted_price}`);
                    console.log(`ğŸ“Š æ•¸æ“šä¾†æº: ${data._meta?.source}`);
                    
                } else {
                    throw new Error('ç²å–çš„æ•¸æ“šæ ¼å¼ç„¡æ•ˆ');
                }
                
            } catch (error) {
                console.error('âŒ åƒ¹æ ¼æ›´æ–°å¤±æ•—:', error);
                
                priceDisplay.textContent = 'ç„¡æ³•ç²å–åƒ¹æ ¼';
                priceDisplay.style.color = '#e17055';
                priceChange.textContent = `éŒ¯èª¤: ${error.message}`;
                priceChange.style.color = '#e17055';
                
                errorMessage.textContent = `é€£æ¥å¤±æ•—: ${error.message}`;
                errorMessage.style.display = 'block';
                
                lastUpdate.textContent = `éŒ¯èª¤æ™‚é–“: ${new Date().toLocaleString('zh-TW')}`;
            }
            
            // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = 'ğŸ”„ åˆ·æ–°åƒ¹æ ¼';
        }
        
        // åˆ‡æ›æ•¸æ“šæº
        function switchDataSource() {
            const newSource = dataManager.switchSource();
            const sourceNames = {
                'auto': 'è‡ªå‹•é¸æ“‡',
                'static': 'éœæ…‹æ•¸æ“š',
                'realtime': 'å¯¦æ™‚æ•¸æ“š'
            };
            
            alert(`å·²åˆ‡æ›åˆ°: ${sourceNames[newSource]}`);
            updatePrice();
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ AImax æ™ºèƒ½å„€è¡¨æ¿å•Ÿå‹•...');
            
            // ç«‹å³æ›´æ–°ä¸€æ¬¡
            updatePrice();
            
            // æ¯30ç§’è‡ªå‹•æ›´æ–°
            updateTimer = setInterval(updatePrice, 30000);
            
            console.log('âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼Œæ¯30ç§’è‡ªå‹•æ›´æ–°');
        });
        
        // é é¢å¸è¼‰æ™‚æ¸…ç†å®šæ™‚å™¨
        window.addEventListener('beforeunload', function() {
            if (updateTimer) {
                clearInterval(updateTimer);
            }
        });
    </script>
</body>
</html>