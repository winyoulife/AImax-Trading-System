name: AImax æ™ºèƒ½äº¤æ˜“ç³»çµ± - æ¨¡æ“¬äº¤æ˜“

on:
  schedule:
    # æ¯5åˆ†é˜åŸ·è¡Œä¸€æ¬¡ (GitHub Actionså…è²»é¡åº¦)
    - cron: '*/5 * * * *'
  workflow_dispatch:
    # æ‰‹å‹•è§¸ç™¼
    inputs:
      trading_mode:
        description: 'äº¤æ˜“æ¨¡å¼'
        required: true
        default: 'simulation'
        type: choice
        options:
        - simulation
        - backtest
      strategy:
        description: 'äº¤æ˜“ç­–ç•¥'
        required: true
        default: 'ultimate_optimized'
        type: choice
        options:
        - ultimate_optimized
        - smart_balanced
        - ultra_advanced

env:
  TRADING_MODE: simulation  # æ¨¡æ“¬äº¤æ˜“æ¨¡å¼
  PYTHON_VERSION: '3.10'
  
jobs:
  trading-simulation:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        
    - name: ğŸ è¨­ç½®Pythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ”§ é…ç½®äº¤æ˜“ç’°å¢ƒ
      run: |
        echo "ğŸ”§ é…ç½®æ¨¡æ“¬äº¤æ˜“ç’°å¢ƒ..."
        mkdir -p logs data/simulation
        echo "SIMULATION_MODE=true" >> $GITHUB_ENV
        echo "STRATEGY=ultimate_optimized" >> $GITHUB_ENV
        echo "MAX_DAILY_TRADES=10" >> $GITHUB_ENV
        echo "POSITION_SIZE=0.001" >> $GITHUB_ENV
        
    - name: ğŸ“Š ç²å–å¸‚å ´æ•¸æ“š
      run: |
        echo "ğŸ“Š ç²å–BTCå¯¦æ™‚åƒ¹æ ¼æ•¸æ“š..."
        python -c "
        import sys
        sys.path.append('.')
        from src.data.data_fetcher import DataFetcher
        
        try:
            fetcher = DataFetcher()
            price = fetcher.get_current_price('BTCUSDT')
            print(f'âœ… BTCç•¶å‰åƒ¹æ ¼: \${price:,.2f}')
            
            # ç²å–æ­·å²æ•¸æ“šç”¨æ–¼æŠ€è¡“åˆ†æ
            df = fetcher.get_historical_data('BTCUSDT', '1h', 100)
            print(f'âœ… ç²å–æ­·å²æ•¸æ“š: {len(df)} æ¢è¨˜éŒ„')
            
            # ä¿å­˜æ•¸æ“šä¾›å¾ŒçºŒä½¿ç”¨
            df.to_csv('data/simulation/btc_data.csv', index=False)
            
        except Exception as e:
            print(f'âŒ æ•¸æ“šç²å–å¤±æ•—: {e}')
            exit(1)
        "
        
    - name: ğŸ¤– åŸ·è¡Œçµ‚æ¥µå„ªåŒ–äº¤æ˜“ç­–ç•¥
      run: |
        echo "ğŸ¤– åŸ·è¡Œ85%å‹ç‡çµ‚æ¥µå„ªåŒ–ç­–ç•¥..."
        python scripts/github_actions_trader.py
        
    - name: ğŸ“ˆ æ›´æ–°äº¤æ˜“ç‹€æ…‹
      run: |
        echo "ğŸ“ˆ æ›´æ–°ç³»çµ±ç‹€æ…‹..."
        python -c "
        import json
        import os
        from datetime import datetime
        
        # è®€å–æœ€æ–°äº¤æ˜“è¨˜éŒ„
        trades = []
        if os.path.exists('data/simulation/trades.jsonl'):
            with open('data/simulation/trades.jsonl', 'r') as f:
                trades = [json.loads(line) for line in f]
        
        # è¨ˆç®—çµ±è¨ˆæ•¸æ“š
        total_trades = len(trades)
        recent_trades = [t for t in trades if t.get('timestamp', '').startswith(datetime.now().strftime('%Y-%m-%d'))]
        daily_trades = len(recent_trades)
        
        # å‰µå»ºç‹€æ…‹å ±å‘Š
        status = {
            'timestamp': datetime.now().isoformat(),
            'system_status': 'running',
            'trading_mode': 'simulation',
            'strategy': 'ultimate_optimized_90%_winrate',
            'total_trades': total_trades,
            'daily_trades': daily_trades,
            'last_update': datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC'),
            'github_actions': True
        }
        
        # ä¿å­˜ç‹€æ…‹
        with open('data/simulation/status.json', 'w') as f:
            json.dump(status, f, indent=2)
            
        print('âœ… ç³»çµ±ç‹€æ…‹å·²æ›´æ–°')
        print(f'ğŸ“Š ç¸½äº¤æ˜“æ¬¡æ•¸: {total_trades}')
        print(f'ğŸ“… ä»Šæ—¥äº¤æ˜“: {daily_trades}')
        "
        
    - name: ğŸ“¤ æäº¤äº¤æ˜“æ•¸æ“š
      run: |
        echo "ğŸ“¤ æäº¤æ¨¡æ“¬äº¤æ˜“æ•¸æ“šåˆ°å€‰åº«..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ äº¤æ˜“æ•¸æ“šæ–‡ä»¶
        git add data/simulation/ || true
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --staged --quiet; then
          echo "ğŸ“ ç„¡æ–°çš„äº¤æ˜“æ•¸æ“šéœ€è¦æäº¤"
        else
          git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°æ¨¡æ“¬äº¤æ˜“æ•¸æ“š - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… äº¤æ˜“æ•¸æ“šå·²æäº¤åˆ°å€‰åº«"
        fi
        
    - name: ğŸ“Š ç”Ÿæˆäº¤æ˜“å ±å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆäº¤æ˜“æ€§èƒ½å ±å‘Š..."
        python -c "
        import json
        import os
        from datetime import datetime, timedelta
        
        if not os.path.exists('data/simulation/trades.jsonl'):
            print('ğŸ“ æš«ç„¡äº¤æ˜“æ•¸æ“š')
            exit(0)
            
        # è®€å–äº¤æ˜“è¨˜éŒ„
        trades = []
        with open('data/simulation/trades.jsonl', 'r') as f:
            trades = [json.loads(line) for line in f]
            
        if not trades:
            print('ğŸ“ æš«ç„¡äº¤æ˜“è¨˜éŒ„')
            exit(0)
            
        print('ğŸ“ˆ === AImax æ¨¡æ“¬äº¤æ˜“å ±å‘Š ===')
        print(f'ğŸ• å ±å‘Šæ™‚é–“: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S UTC\")}')
        print(f'ğŸ¯ ä½¿ç”¨ç­–ç•¥: çµ‚æ¥µå„ªåŒ–MACD (ç›®æ¨™å‹ç‡85%+)')
        print(f'ğŸ“Š ç¸½äº¤æ˜“æ¬¡æ•¸: {len(trades)}')
        
        # æœ€è¿‘24å°æ™‚äº¤æ˜“
        now = datetime.now()
        recent_trades = []
        for trade in trades:
            try:
                trade_time = datetime.fromisoformat(trade['timestamp'].replace('Z', '+00:00'))
                if (now - trade_time.replace(tzinfo=None)).total_seconds() < 86400:
                    recent_trades.append(trade)
            except:
                continue
                
        print(f'ğŸ“… 24å°æ™‚å…§äº¤æ˜“: {len(recent_trades)}')
        
        if recent_trades:
            buy_signals = len([t for t in recent_trades if t['action'] == 'buy'])
            sell_signals = len([t for t in recent_trades if t['action'] == 'sell'])
            avg_confidence = sum(t.get('confidence', 0) for t in recent_trades) / len(recent_trades)
            
            print(f'ğŸ“ˆ è²·å…¥ä¿¡è™Ÿ: {buy_signals}')
            print(f'ğŸ“‰ è³£å‡ºä¿¡è™Ÿ: {sell_signals}')
            print(f'ğŸ¯ å¹³å‡ä¿¡è™Ÿå¼·åº¦: {avg_confidence:.2%}')
            
        print('âœ… æ¨¡æ“¬äº¤æ˜“ç³»çµ±é‹è¡Œæ­£å¸¸')
        print('ğŸ”„ ä¸‹æ¬¡åŸ·è¡Œ: 5åˆ†é˜å¾Œ')
        "
        
    - name: ğŸš¨ éŒ¯èª¤è™•ç†
      if: failure()
      run: |
        echo "ğŸš¨ äº¤æ˜“ç³»çµ±åŸ·è¡Œå¤±æ•—"
        echo "ğŸ“ éŒ¯èª¤æ™‚é–“: $(date)"
        echo "ğŸ”§ ç³»çµ±å°‡åœ¨ä¸‹æ¬¡å®šæ™‚åŸ·è¡Œæ™‚è‡ªå‹•é‡è©¦"
        
        # è¨˜éŒ„éŒ¯èª¤
        mkdir -p logs
        echo "$(date): GitHub ActionsåŸ·è¡Œå¤±æ•—" >> logs/error.log
        
        # å˜—è©¦æäº¤éŒ¯èª¤æ—¥èªŒ
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add logs/ || true
        git commit -m "ğŸš¨ è¨˜éŒ„ç³»çµ±éŒ¯èª¤ - $(date '+%Y-%m-%d %H:%M:%S')" || true
        git push || true