name: ğŸ”„ æ›´æ–°BTCåƒ¹æ ¼æ•¸æ“š

on:
  schedule:
    # æ¯5åˆ†é˜æ›´æ–°ä¸€æ¬¡BTCåƒ¹æ ¼
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼·åˆ¶æ›´æ–°'
        required: false
        default: 'false'

jobs:
  update-btc-price:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ è¨­ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: |
          pip install requests
      
      - name: ğŸ’° ç²å–BTCåƒ¹æ ¼
        run: |
          python -c "
          import requests
          import json
          import os
          from datetime import datetime
          
          try:
              # ç›´æ¥èª¿ç”¨MAX API
              response = requests.get('https://max-api.maicoin.com/api/v2/tickers/btctwd', timeout=10)
              
              if response.status_code == 200:
                  data = response.json()
                  
                  if 'last' in data:
                      price = float(data['last'])
                      
                      # å‰µå»ºåƒ¹æ ¼æ•¸æ“š
                      price_data = {
                          'price': price,
                          'timestamp': datetime.now().isoformat(),
                          'source': 'MAX_API_DIRECT',
                          'currency': 'TWD',
                          'symbol': 'BTCTWD',
                          'additional_data': {
                              'buy': float(data.get('buy', 0)),
                              'sell': float(data.get('sell', 0)),
                              'high': float(data.get('high', 0)),
                              'low': float(data.get('low', 0)),
                              'vol': float(data.get('vol', 0))
                          }
                      }
                      
                      # ç¢ºä¿ç›®éŒ„å­˜åœ¨
                      os.makedirs('data', exist_ok=True)
                      
                      # ä¿å­˜åƒ¹æ ¼æ•¸æ“š
                      with open('data/latest_btc_price.json', 'w', encoding='utf-8') as f:
                          json.dump(price_data, f, indent=2, ensure_ascii=False)
                      
                      print(f'âœ… BTCåƒ¹æ ¼å·²æ›´æ–°: NT$ {price:,.0f}')
                      
                      # è¨­ç½®ç’°å¢ƒè®Šé‡ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
                      with open(os.environ['GITHUB_ENV'], 'a') as f:
                          f.write(f'BTC_PRICE={price}\n')
                          f.write(f'UPDATE_SUCCESS=true\n')
                  else:
                      print('âŒ APIéŸ¿æ‡‰æ ¼å¼éŒ¯èª¤')
                      with open(os.environ['GITHUB_ENV'], 'a') as f:
                          f.write('UPDATE_SUCCESS=false\n')
              else:
                  print(f'âŒ APIèª¿ç”¨å¤±æ•—: {response.status_code}')
                  with open(os.environ['GITHUB_ENV'], 'a') as f:
                      f.write('UPDATE_SUCCESS=false\n')
                      
          except Exception as e:
              print(f'âŒ ç²å–åƒ¹æ ¼å¤±æ•—: {e}')
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write('UPDATE_SUCCESS=false\n')
          "
      
      - name: ğŸ“Š æ›´æ–°å„€è¡¨æ¿ç‹€æ…‹
        if: env.UPDATE_SUCCESS == 'true'
        run: |
          python -c "
          import json
          import os
          from datetime import datetime
          
          # è®€å–åƒ¹æ ¼æ•¸æ“š
          with open('data/latest_btc_price.json', 'r', encoding='utf-8') as f:
              price_data = json.load(f)
          
          price = price_data['price']
          
          # æ›´æ–°å„€è¡¨æ¿æ–‡ä»¶ä¸­çš„å‚™ç”¨åƒ¹æ ¼
          dashboard_file = 'static/smart-balanced-dashboard.html'
          
          if os.path.exists(dashboard_file):
              with open(dashboard_file, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # æ›´æ–°å‚™ç”¨åƒ¹æ ¼
              old_fallback = 'const fallbackPrice = 3491828;'
              new_fallback = f'const fallbackPrice = {int(price)};'
              content = content.replace(old_fallback, new_fallback)
              
              # æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
              timestamp = datetime.now().strftime('%Y/%m/%d %H:%M')
              content = content.replace(
                  'æœ€å¾Œæª¢æŸ¥: 2025/08/08 07:02',
                  f'æœ€å¾Œæª¢æŸ¥: {timestamp} (GitHub Actions)'
              )
              
              with open(dashboard_file, 'w', encoding='utf-8') as f:
                  f.write(content)
              
              print(f'âœ… å„€è¡¨æ¿å‚™ç”¨åƒ¹æ ¼å·²æ›´æ–°: NT$ {price:,.0f}')
          "
      
      - name: ğŸ“ æäº¤æ›´æ–°
        if: env.UPDATE_SUCCESS == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add data/latest_btc_price.json
          git add static/smart-balanced-dashboard.html
          
          if git diff --staged --quiet; then
            echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
          else
            git commit -m "ğŸ”„ è‡ªå‹•æ›´æ–°BTCåƒ¹æ ¼: NT$ ${{ env.BTC_PRICE }} - $(date)"
            git push
            echo "âœ… BTCåƒ¹æ ¼æ•¸æ“šå·²æ¨é€åˆ°å€‰åº«"
          fi
      
      - name: ğŸ“Š æ›´æ–°æ‘˜è¦
        run: |
          if [ "${{ env.UPDATE_SUCCESS }}" = "true" ]; then
            echo "âœ… BTCåƒ¹æ ¼æ›´æ–°æˆåŠŸ: NT$ ${{ env.BTC_PRICE }}"
            echo "ğŸ¯ 83.3%å‹ç‡ç­–ç•¥ç¾åœ¨åŸºæ–¼æœ€æ–°çœŸå¯¦æ•¸æ“šé‹è¡Œ"
            echo "ğŸ”„ ä¸‹æ¬¡æ›´æ–°: 5åˆ†é˜å¾Œ"
          else
            echo "âŒ BTCåƒ¹æ ¼æ›´æ–°å¤±æ•—"
            echo "âš ï¸ å°‡ä½¿ç”¨ä¸Šæ¬¡æˆåŠŸçš„åƒ¹æ ¼æ•¸æ“š"
          fi