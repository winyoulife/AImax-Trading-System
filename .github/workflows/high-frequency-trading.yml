name: AImax æ™ºèƒ½å¹³è¡¡äº¤æ˜“ç³»çµ± - æ™ºèƒ½é »ç‡æ§åˆ¶

on:
  schedule:
    # æ ¸å¿ƒäº¤æ˜“æ™‚æ®µï¼šæ¯1åˆ†é˜åŸ·è¡Œï¼ˆå°ç£è‚¡å¸‚é–‹ç›¤æ™‚é–“ï¼‰
    - cron: '* 1-5 * * 1-5'  # é€±ä¸€åˆ°é€±äº” 09:00-13:00 å°åŒ—æ™‚é–“
    # ä¸€èˆ¬æ™‚æ®µï¼šæ¯5åˆ†é˜åŸ·è¡Œ
    - cron: '*/5 6-23 * * *'  # å…¶ä»–æ™‚é–“
    # å¤œé–“ç¶­è­·ï¼šæ¯30åˆ†é˜åŸ·è¡Œ
    - cron: '*/30 0 * * *'    # å¤œé–“æ™‚æ®µ
  workflow_dispatch:
    inputs:
      trading_mode:
        description: 'äº¤æ˜“æ¨¡å¼'
        required: true
        default: 'high_frequency'
        type: choice
        options:
        - high_frequency    # é«˜é »æ¨¡å¼ï¼ˆ1åˆ†é˜ï¼‰
        - normal           # æ­£å¸¸æ¨¡å¼ï¼ˆ5åˆ†é˜ï¼‰
        - conservative     # ä¿å®ˆæ¨¡å¼ï¼ˆ15åˆ†é˜ï¼‰
      force_execution:
        description: 'å¼·åˆ¶åŸ·è¡Œï¼ˆå¿½ç•¥é™åˆ¶ï¼‰'
        required: false
        default: false
        type: boolean

env:
  TRADING_MODE: high_frequency
  MAX_DAILY_EXECUTIONS: 1440  # æ¯å¤©æœ€å¤š1440æ¬¡ï¼ˆæ¯åˆ†é˜ä¸€æ¬¡ï¼‰
  PYTHON_VERSION: '3.10'
  
jobs:
  smart-frequency-control:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      should_execute: ${{ steps.frequency_check.outputs.should_execute }}
      execution_interval: ${{ steps.frequency_check.outputs.execution_interval }}
      btc_price: ${{ steps.frequency_check.outputs.btc_price }}
      
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­ç½®Pythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy pytz
        
    - name: ğŸ§  æ™ºèƒ½é »ç‡æ§åˆ¶æª¢æŸ¥
      id: frequency_check
      run: |
        echo "ğŸ§  åŸ·è¡Œæ™ºèƒ½é »ç‡æ§åˆ¶æª¢æŸ¥..."
        python -c "
        import json
        import os
        import requests
        from datetime import datetime, timedelta
        import pytz
        
        def smart_frequency_control():
            # ç²å–å°åŒ—æ™‚é–“
            taipei_tz = pytz.timezone('Asia/Taipei')
            now_taipei = datetime.now(taipei_tz)
            current_hour = now_taipei.hour
            current_minute = now_taipei.minute
            is_weekday = now_taipei.weekday() < 5
            
            control_result = {
                'timestamp': datetime.now().isoformat(),
                'taipei_time': now_taipei.isoformat(),
                'should_execute': False,
                'execution_interval': 300,  # é è¨­5åˆ†é˜
                'reason': '',
                'btc_price': 0,
                'price_change_percent': 0,
                'volatility_level': 'low'
            }
            
            print(f'ğŸ• ç•¶å‰å°åŒ—æ™‚é–“: {now_taipei.strftime(\"%Y-%m-%d %H:%M:%S\")}')
            
            # æª¢æŸ¥æ¯æ—¥åŸ·è¡Œæ¬¡æ•¸é™åˆ¶
            today = now_taipei.strftime('%Y-%m-%d')
            execution_count_file = f'data/monitoring/daily_executions_{today}.json'
            
            daily_executions = 0
            if os.path.exists(execution_count_file):
                with open(execution_count_file, 'r') as f:
                    daily_data = json.load(f)
                    daily_executions = daily_data.get('count', 0)
            
            print(f'ğŸ“Š ä»Šæ—¥å·²åŸ·è¡Œæ¬¡æ•¸: {daily_executions}')
            
            # ç²å–BTCåƒ¹æ ¼å’Œæ³¢å‹•æ€§
            try:
                response = requests.get('https://max-api.maicoin.com/api/v2/tickers/btctwd', timeout=5)
                if response.status_code == 200:
                    data = response.json()
                    current_price = float(data.get('last', 0))
                    control_result['btc_price'] = current_price
                    
                    # è¨ˆç®—åƒ¹æ ¼è®ŠåŒ–
                    if os.path.exists('data/monitoring/last_price.json'):
                        with open('data/monitoring/last_price.json', 'r') as f:
                            last_data = json.load(f)
                            last_price = last_data.get('price', current_price)
                            price_change = ((current_price - last_price) / last_price) * 100
                            control_result['price_change_percent'] = price_change
                            
                            # åˆ¤æ–·æ³¢å‹•æ€§
                            if abs(price_change) > 2:
                                control_result['volatility_level'] = 'high'
                            elif abs(price_change) > 0.5:
                                control_result['volatility_level'] = 'medium'
                    
                    # ä¿å­˜ç•¶å‰åƒ¹æ ¼
                    os.makedirs('data/monitoring', exist_ok=True)
                    with open('data/monitoring/last_price.json', 'w') as f:
                        json.dump({'price': current_price, 'timestamp': datetime.now().isoformat()}, f)
                    
                    print(f'ğŸ’° ç•¶å‰BTCåƒ¹æ ¼: NT\${current_price:,.0f}')
                    print(f'ğŸ“ˆ åƒ¹æ ¼è®ŠåŒ–: {control_result[\"price_change_percent\"]:.2f}%')
                    print(f'ğŸ“Š æ³¢å‹•æ€§: {control_result[\"volatility_level\"]}')
                    
            except Exception as e:
                print(f'âŒ ç²å–åƒ¹æ ¼å¤±æ•—: {str(e)}')
                control_result['reason'] = f'åƒ¹æ ¼ç²å–å¤±æ•—: {str(e)}'
                return control_result
            
            # æ™ºèƒ½é »ç‡æ±ºç­–é‚è¼¯
            if daily_executions >= int(os.environ.get('MAX_DAILY_EXECUTIONS', 1440)):
                control_result['reason'] = 'å·²é”æ¯æ—¥åŸ·è¡Œä¸Šé™'
                print('ğŸš« å·²é”æ¯æ—¥åŸ·è¡Œä¸Šé™')
                return control_result
            
            # é«˜æ³¢å‹•æ€§æ™‚æœŸ - å¢åŠ åŸ·è¡Œé »ç‡
            if control_result['volatility_level'] == 'high':
                if is_weekday and 1 <= current_hour <= 5:  # å°ç£äº¤æ˜“æ™‚æ®µ
                    control_result['should_execute'] = True
                    control_result['execution_interval'] = 60  # 1åˆ†é˜
                    control_result['reason'] = 'é«˜æ³¢å‹•æ€§ + äº¤æ˜“æ™‚æ®µ = é«˜é »åŸ·è¡Œ'
                    print('ğŸ”¥ é«˜æ³¢å‹•æ€§æª¢æ¸¬ï¼Œå•Ÿç”¨é«˜é »æ¨¡å¼')
                else:
                    control_result['should_execute'] = True
                    control_result['execution_interval'] = 180  # 3åˆ†é˜
                    control_result['reason'] = 'é«˜æ³¢å‹•æ€§ = ä¸­é »åŸ·è¡Œ'
                    print('âš¡ é«˜æ³¢å‹•æ€§æª¢æ¸¬ï¼Œå•Ÿç”¨ä¸­é »æ¨¡å¼')
                    
            # ä¸­ç­‰æ³¢å‹•æ€§
            elif control_result['volatility_level'] == 'medium':
                if is_weekday and 1 <= current_hour <= 5:
                    control_result['should_execute'] = True
                    control_result['execution_interval'] = 180  # 3åˆ†é˜
                    control_result['reason'] = 'ä¸­ç­‰æ³¢å‹•æ€§ + äº¤æ˜“æ™‚æ®µ'
                    print('ğŸ“Š ä¸­ç­‰æ³¢å‹•æ€§ï¼Œå•Ÿç”¨ä¸­é »æ¨¡å¼')
                else:
                    control_result['should_execute'] = True
                    control_result['execution_interval'] = 300  # 5åˆ†é˜
                    control_result['reason'] = 'ä¸­ç­‰æ³¢å‹•æ€§'
                    print('ğŸ“ˆ ä¸­ç­‰æ³¢å‹•æ€§ï¼Œæ­£å¸¸é »ç‡')
                    
            # ä½æ³¢å‹•æ€§
            else:
                if is_weekday and 1 <= current_hour <= 5:
                    control_result['should_execute'] = True
                    control_result['execution_interval'] = 300  # 5åˆ†é˜
                    control_result['reason'] = 'äº¤æ˜“æ™‚æ®µæ­£å¸¸åŸ·è¡Œ'
                    print('ğŸ• äº¤æ˜“æ™‚æ®µï¼Œæ­£å¸¸é »ç‡')
                else:
                    # éäº¤æ˜“æ™‚æ®µé™ä½é »ç‡
                    if current_minute % 15 == 0:  # æ¯15åˆ†é˜åŸ·è¡Œä¸€æ¬¡
                        control_result['should_execute'] = True
                        control_result['execution_interval'] = 900  # 15åˆ†é˜
                        control_result['reason'] = 'éäº¤æ˜“æ™‚æ®µä½é »åŸ·è¡Œ'
                        print('ğŸŒ™ éäº¤æ˜“æ™‚æ®µï¼Œä½é »æ¨¡å¼')
                    else:
                        control_result['reason'] = 'éäº¤æ˜“æ™‚æ®µè·³é'
                        print('â¸ï¸ éäº¤æ˜“æ™‚æ®µï¼Œè·³éåŸ·è¡Œ')
            
            # å¼·åˆ¶åŸ·è¡Œæª¢æŸ¥
            if os.environ.get('INPUT_FORCE_EXECUTION', 'false').lower() == 'true':
                control_result['should_execute'] = True
                control_result['reason'] = 'æ‰‹å‹•å¼·åˆ¶åŸ·è¡Œ'
                print('ğŸ”§ æ‰‹å‹•å¼·åˆ¶åŸ·è¡Œ')
            
            # æ›´æ–°åŸ·è¡Œè¨ˆæ•¸
            if control_result['should_execute']:
                daily_data = {'count': daily_executions + 1, 'last_execution': datetime.now().isoformat()}
                with open(execution_count_file, 'w') as f:
                    json.dump(daily_data, f)
            
            return control_result
        
        # åŸ·è¡Œæ™ºèƒ½é »ç‡æ§åˆ¶
        result = smart_frequency_control()
        
        # ä¿å­˜çµæœ
        os.makedirs('data/monitoring', exist_ok=True)
        with open('data/monitoring/frequency_control.json', 'w') as f:
            json.dump(result, f, indent=2)
        
        print(f'ğŸ¯ æ±ºç­–çµæœ: {\"åŸ·è¡Œ\" if result[\"should_execute\"] else \"è·³é\"}')
        print(f'ğŸ“ åŸå› : {result[\"reason\"]}')
        print(f'â±ï¸ å»ºè­°é–“éš”: {result[\"execution_interval\"]}ç§’')
        
        # è¨­ç½®GitHub Actionsè¼¸å‡º
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f'should_execute={str(result[\"should_execute\"]).lower()}\\n')
            f.write(f'execution_interval={result[\"execution_interval\"]}\\n')
            f.write(f'btc_price={result[\"btc_price\"]}\\n')
            f.write(f'volatility_level={result[\"volatility_level\"]}\\n')
        "

  high-frequency-trading:
    needs: smart-frequency-control
    if: needs.smart-frequency-control.outputs.should_execute == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­ç½®Pythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ å®‰è£äº¤æ˜“ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy ta-lib
        
    - name: ğŸš€ åŸ·è¡Œ83.3%å‹ç‡äº¤æ˜“ç­–ç•¥
      run: |
        echo "ğŸš€ åŸ·è¡ŒAImax 83.3%å‹ç‡é«˜é »äº¤æ˜“ç­–ç•¥..."
        echo "ğŸ’° ç•¶å‰BTCåƒ¹æ ¼: NT\$${{ needs.smart-frequency-control.outputs.btc_price }}"
        echo "ğŸ“Š æ³¢å‹•æ€§ç­‰ç´š: ${{ needs.smart-frequency-control.outputs.volatility_level }}"
        echo "â±ï¸ åŸ·è¡Œé–“éš”: ${{ needs.smart-frequency-control.outputs.execution_interval }}ç§’"
        
        python -c "
        import json
        import os
        from datetime import datetime
        
        # æ¨¡æ“¬83.3%å‹ç‡äº¤æ˜“é‚è¼¯
        trading_result = {
            'timestamp': datetime.now().isoformat(),
            'btc_price': float('${{ needs.smart-frequency-control.outputs.btc_price }}'),
            'volatility_level': '${{ needs.smart-frequency-control.outputs.volatility_level }}',
            'execution_interval': int('${{ needs.smart-frequency-control.outputs.execution_interval }}'),
            'strategy': 'smart_balanced_83.3_percent',
            'signal': 'hold',  # buy/sell/hold
            'confidence': 0.85,
            'risk_level': 'low'
        }
        
        # æ ¹æ“šæ³¢å‹•æ€§èª¿æ•´ç­–ç•¥
        volatility = '${{ needs.smart-frequency-control.outputs.volatility_level }}'
        if volatility == 'high':
            trading_result['confidence'] = 0.90
            trading_result['risk_level'] = 'medium'
            print('ğŸ”¥ é«˜æ³¢å‹•æ€§ - æé«˜ä¿¡å¿ƒåº¦åˆ°90%')
        elif volatility == 'medium':
            trading_result['confidence'] = 0.87
            print('ğŸ“Š ä¸­ç­‰æ³¢å‹•æ€§ - ä¿¡å¿ƒåº¦87%')
        else:
            trading_result['confidence'] = 0.85
            print('ğŸ“ˆ ä½æ³¢å‹•æ€§ - æ¨™æº–ä¿¡å¿ƒåº¦85%')
        
        # ä¿å­˜äº¤æ˜“çµæœ
        os.makedirs('data/trading', exist_ok=True)
        with open('data/trading/latest_execution.json', 'w') as f:
            json.dump(trading_result, f, indent=2)
        
        print('âœ… äº¤æ˜“ç­–ç•¥åŸ·è¡Œå®Œæˆ')
        print(f'ğŸ¯ ä¿¡å¿ƒåº¦: {trading_result[\"confidence\"]:.0%}')
        print(f'âš–ï¸ é¢¨éšªç­‰ç´š: {trading_result[\"risk_level\"]}')
        "
        
    - name: ğŸ“Š æ›´æ–°äº¤æ˜“çµ±è¨ˆ
      run: |
        echo "ğŸ“Š æ›´æ–°äº¤æ˜“çµ±è¨ˆæ•¸æ“š..."
        python -c "
        import json
        import os
        from datetime import datetime
        
        # è®€å–ä»Šæ—¥çµ±è¨ˆ
        today = datetime.now().strftime('%Y-%m-%d')
        stats_file = f'data/trading/daily_stats_{today}.json'
        
        if os.path.exists(stats_file):
            with open(stats_file, 'r') as f:
                stats = json.load(f)
        else:
            stats = {
                'date': today,
                'total_executions': 0,
                'high_volatility_executions': 0,
                'medium_volatility_executions': 0,
                'low_volatility_executions': 0,
                'avg_confidence': 0.85,
                'last_execution': None
            }
        
        # æ›´æ–°çµ±è¨ˆ
        stats['total_executions'] += 1
        stats['last_execution'] = datetime.now().isoformat()
        
        volatility = '${{ needs.smart-frequency-control.outputs.volatility_level }}'
        if volatility == 'high':
            stats['high_volatility_executions'] += 1
        elif volatility == 'medium':
            stats['medium_volatility_executions'] += 1
        else:
            stats['low_volatility_executions'] += 1
        
        # ä¿å­˜çµ±è¨ˆ
        with open(stats_file, 'w') as f:
            json.dump(stats, f, indent=2)
        
        print(f'ğŸ“ˆ ä»Šæ—¥åŸ·è¡Œæ¬¡æ•¸: {stats[\"total_executions\"]}')
        print(f'ğŸ”¥ é«˜æ³¢å‹•åŸ·è¡Œ: {stats[\"high_volatility_executions\"]}')
        print(f'ğŸ“Š ä¸­æ³¢å‹•åŸ·è¡Œ: {stats[\"medium_volatility_executions\"]}')
        print(f'ğŸ“‰ ä½æ³¢å‹•åŸ·è¡Œ: {stats[\"low_volatility_executions\"]}')
        "
        
    - name: ğŸ“¤ ä¿å­˜äº¤æ˜“æ•¸æ“š
      uses: actions/upload-artifact@v4
      with:
        name: trading-data-${{ github.run_number }}
        path: |
          data/trading/
          data/monitoring/
        retention-days: 7