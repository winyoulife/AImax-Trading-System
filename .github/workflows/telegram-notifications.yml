name: AImax Telegramé€šçŸ¥ç³»çµ±

on:
  schedule:
    # æ¯å°æ™‚ç™¼é€ç³»çµ±ç‹€æ…‹æ‘˜è¦
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      notification_type:
        description: 'é€šçŸ¥é¡å‹'
        required: true
        default: 'system_status'
        type: choice
        options:
        - system_status     # ç³»çµ±ç‹€æ…‹
        - trading_summary   # äº¤æ˜“æ‘˜è¦
        - emergency_alert   # ç·Šæ€¥è­¦å ±
        - test_message      # æ¸¬è©¦æ¶ˆæ¯
        - daily_report      # æ¯æ—¥å ±å‘Š
      custom_message:
        description: 'è‡ªå®šç¾©æ¶ˆæ¯å…§å®¹'
        required: false
        type: string

env:
  TELEGRAM_ENABLED: true
  PYTHON_VERSION: '3.10'
  
jobs:
  telegram-notification:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­ç½®Pythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ å®‰è£é€šçŸ¥ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install requests aiohttp pytz
        
    - name: ğŸ“± ç™¼é€Telegramé€šçŸ¥
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "ğŸ“± æº–å‚™ç™¼é€Telegramé€šçŸ¥..."
        python -c "
        import json
        import os
        import requests
        from datetime import datetime, timedelta
        import pytz
        
        class TelegramNotifier:
            def __init__(self, bot_token, chat_id):
                self.bot_token = bot_token
                self.chat_id = chat_id
                self.base_url = f'https://api.telegram.org/bot{bot_token}'
            
            def send_message(self, message, parse_mode='HTML'):
                try:
                    url = f'{self.base_url}/sendMessage'
                    data = {
                        'chat_id': self.chat_id,
                        'text': message,
                        'parse_mode': parse_mode
                    }
                    
                    response = requests.post(url, data=data, timeout=10)
                    
                    if response.status_code == 200:
                        print('âœ… Telegramæ¶ˆæ¯ç™¼é€æˆåŠŸ')
                        return True
                    else:
                        print(f'âŒ Telegramæ¶ˆæ¯ç™¼é€å¤±æ•—: {response.status_code}')
                        print(f'éŸ¿æ‡‰å…§å®¹: {response.text}')
                        return False
                        
                except Exception as e:
                    print(f'âŒ ç™¼é€Telegramæ¶ˆæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}')
                    return False
            
            def send_system_status(self):
                taipei_tz = pytz.timezone('Asia/Taipei')
                now_taipei = datetime.now(taipei_tz)
                
                # è®€å–ç³»çµ±ç‹€æ…‹
                system_data = {}
                try:
                    if os.path.exists('data/states/current_trading_state.json'):
                        with open('data/states/current_trading_state.json', 'r') as f:
                            system_data = json.load(f)
                except:
                    pass
                
                # è®€å–ä»Šæ—¥çµ±è¨ˆ
                today = now_taipei.strftime('%Y-%m-%d')
                daily_stats = {}
                try:
                    stats_file = f'data/analytics/daily_stats_{today}.json'
                    if os.path.exists(stats_file):
                        with open(stats_file, 'r') as f:
                            daily_stats = json.load(f)
                except:
                    pass
                
                # è®€å–æœ€æ–°åƒ¹æ ¼
                current_price = 0
                try:
                    if os.path.exists('data/monitoring/last_price.json'):
                        with open('data/monitoring/last_price.json', 'r') as f:
                            price_data = json.load(f)
                            current_price = price_data.get('price', 0)
                except:
                    pass
                
                # æ§‹å»ºç‹€æ…‹æ¶ˆæ¯
                trading_active = system_data.get('trading_status', {}).get('is_active', False)
                executions_today = system_data.get('trading_status', {}).get('total_executions_today', 0)
                strategy = system_data.get('trading_status', {}).get('current_strategy', 'unknown')
                volatility = system_data.get('market_data', {}).get('volatility_level', 'unknown')
                
                status_emoji = 'ğŸŸ¢' if trading_active else 'ğŸ”´'
                
                message = f'''
ğŸ¤– <b>AImax ç³»çµ±ç‹€æ…‹å ±å‘Š</b>
                
{status_emoji} <b>äº¤æ˜“ç‹€æ…‹</b>: {'é‹è¡Œä¸­' if trading_active else 'å·²åœæ­¢'}
ğŸ“Š <b>ç­–ç•¥</b>: {strategy.replace('_', ' ').title()}
ğŸ”„ <b>ä»Šæ—¥åŸ·è¡Œ</b>: {executions_today} æ¬¡
ğŸ“ˆ <b>æ³¢å‹•æ€§</b>: {volatility.upper()}

ğŸ’° <b>ç•¶å‰BTCåƒ¹æ ¼</b>: NT${current_price:,.0f}
ğŸ• <b>å°åŒ—æ™‚é–“</b>: {now_taipei.strftime('%Y-%m-%d %H:%M:%S')}

ğŸ“Š <b>ä»Šæ—¥çµ±è¨ˆ</b>:
â€¢ ç¸½åŸ·è¡Œ: {daily_stats.get('total_executions', 0)} æ¬¡
â€¢ é«˜æ³¢å‹•: {daily_stats.get('high_volatility_executions', 0)} æ¬¡
â€¢ ä¸­æ³¢å‹•: {daily_stats.get('medium_volatility_executions', 0)} æ¬¡
â€¢ ä½æ³¢å‹•: {daily_stats.get('low_volatility_executions', 0)} æ¬¡

ğŸ¯ <b>å¹³å‡ä¿¡å¿ƒåº¦</b>: {daily_stats.get('average_confidence', 0.85):.0%}
ğŸ’ <b>å‹ç‡ç›®æ¨™</b>: 85%+

â˜ï¸ <b>é›²ç«¯ç‹€æ…‹</b>: GitHub Actions æ­£å¸¸
ğŸ”„ <b>ä¸‹æ¬¡æ›´æ–°</b>: 1å°æ™‚å¾Œ

<i>ğŸš€ AImax æ™ºèƒ½äº¤æ˜“ç³»çµ± v3.0</i>
                '''.strip()
                
                return self.send_message(message)
            
            def send_trading_summary(self):
                taipei_tz = pytz.timezone('Asia/Taipei')
                now_taipei = datetime.now(taipei_tz)
                today = now_taipei.strftime('%Y-%m-%d')
                
                # è®€å–äº¤æ˜“åŸ·è¡Œè¨˜éŒ„
                executions = []
                try:
                    exec_file = f'data/trading/execution_log_{today}.jsonl'
                    if os.path.exists(exec_file):
                        with open(exec_file, 'r') as f:
                            for line in f:
                                if line.strip():
                                    executions.append(json.loads(line.strip()))
                except:
                    pass
                
                # åˆ†æåŸ·è¡Œæ•¸æ“š
                total_executions = len(executions)
                high_vol_count = sum(1 for e in executions if e.get('volatility_level') == 'high')
                medium_vol_count = sum(1 for e in executions if e.get('volatility_level') == 'medium')
                low_vol_count = sum(1 for e in executions if e.get('volatility_level') == 'low')
                
                successful_count = sum(1 for e in executions if e.get('status') == 'success')
                win_rate = (successful_count / total_executions * 100) if total_executions > 0 else 0
                
                avg_confidence = sum(e.get('confidence', 0.85) for e in executions) / total_executions if total_executions > 0 else 0.85
                
                message = f'''
ğŸ“ˆ <b>AImax äº¤æ˜“åŸ·è¡Œæ‘˜è¦</b>

ğŸ“… <b>æ—¥æœŸ</b>: {today}
ğŸ• <b>æ›´æ–°æ™‚é–“</b>: {now_taipei.strftime('%H:%M:%S')}

ğŸ”„ <b>åŸ·è¡Œçµ±è¨ˆ</b>:
â€¢ ç¸½åŸ·è¡Œæ¬¡æ•¸: {total_executions}
â€¢ æˆåŠŸåŸ·è¡Œ: {successful_count}
â€¢ åŸ·è¡ŒæˆåŠŸç‡: {win_rate:.1f}%

ğŸ“Š <b>æ³¢å‹•æ€§åˆ†å¸ƒ</b>:
â€¢ ğŸ”¥ é«˜æ³¢å‹•: {high_vol_count} æ¬¡ ({high_vol_count/total_executions*100:.1f}%)
â€¢ ğŸ“Š ä¸­æ³¢å‹•: {medium_vol_count} æ¬¡ ({medium_vol_count/total_executions*100:.1f}%)
â€¢ ğŸ“‰ ä½æ³¢å‹•: {low_vol_count} æ¬¡ ({low_vol_count/total_executions*100:.1f}%)

ğŸ¯ <b>ç­–ç•¥è¡¨ç¾</b>:
â€¢ å¹³å‡ä¿¡å¿ƒåº¦: {avg_confidence:.0%}
â€¢ ç›®æ¨™å‹ç‡: 85%+
â€¢ ç•¶å‰è¡¨ç¾: {'âœ… é”æ¨™' if win_rate >= 85 else 'âš ï¸ éœ€å„ªåŒ–' if win_rate >= 70 else 'âŒ éœ€æª¢æŸ¥'}

ğŸ’¡ <b>æ™ºèƒ½é »ç‡æ§åˆ¶</b>: 
{'ğŸ”¥ é«˜é »æ¨¡å¼' if high_vol_count > total_executions * 0.3 else 'ğŸ“Š æ­£å¸¸æ¨¡å¼'}

<i>ğŸ¤– AImax 85%å‹ç‡ç­–ç•¥é‹è¡Œä¸­</i>
                '''.strip()
                
                return self.send_message(message)
            
            def send_emergency_alert(self, alert_message=''):
                taipei_tz = pytz.timezone('Asia/Taipei')
                now_taipei = datetime.now(taipei_tz)
                
                message = f'''
ğŸš¨ <b>AImax ç·Šæ€¥è­¦å ±</b> ğŸš¨

âš ï¸ <b>è­¦å ±é¡å‹</b>: ç³»çµ±ç•°å¸¸
ğŸ• <b>ç™¼ç”Ÿæ™‚é–“</b>: {now_taipei.strftime('%Y-%m-%d %H:%M:%S')}

ğŸ“‹ <b>è©³ç´°ä¿¡æ¯</b>:
{alert_message if alert_message else 'ç³»çµ±æª¢æ¸¬åˆ°ç•°å¸¸ç‹€æ³ï¼Œè«‹æª¢æŸ¥äº¤æ˜“ç³»çµ±ç‹€æ…‹ã€‚'}

ğŸ”§ <b>å»ºè­°æ“ä½œ</b>:
1. æª¢æŸ¥GitHub Actionsé‹è¡Œç‹€æ…‹
2. é©—è­‰MAX APIé€£æ¥
3. æŸ¥çœ‹ç³»çµ±ç›£æ§æ•¸æ“š
4. å¿…è¦æ™‚åŸ·è¡Œç·Šæ€¥åœæ­¢

ğŸŒ <b>ç›£æ§é¢æ¿</b>: https://winyoulife.github.io/AImax-Trading-System/

<i>âš¡ è«‹ç«‹å³è™•ç†æ­¤è­¦å ±</i>
                '''.strip()
                
                return self.send_message(message)
            
            def send_daily_report(self):
                taipei_tz = pytz.timezone('Asia/Taipei')
                now_taipei = datetime.now(taipei_tz)
                today = now_taipei.strftime('%Y-%m-%d')
                yesterday = (now_taipei - timedelta(days=1)).strftime('%Y-%m-%d')
                
                # è®€å–ä»Šæ—¥å’Œæ˜¨æ—¥æ•¸æ“šé€²è¡Œå°æ¯”
                today_stats = {}
                yesterday_stats = {}
                
                try:
                    today_file = f'data/analytics/daily_stats_{today}.json'
                    if os.path.exists(today_file):
                        with open(today_file, 'r') as f:
                            today_stats = json.load(f)
                except:
                    pass
                
                try:
                    yesterday_file = f'data/analytics/daily_stats_{yesterday}.json'
                    if os.path.exists(yesterday_file):
                        with open(yesterday_file, 'r') as f:
                            yesterday_stats = json.load(f)
                except:
                    pass
                
                today_executions = today_stats.get('total_executions', 0)
                yesterday_executions = yesterday_stats.get('total_executions', 0)
                execution_change = today_executions - yesterday_executions
                
                today_win_rate = today_stats.get('win_rate', 0) * 100
                yesterday_win_rate = yesterday_stats.get('win_rate', 0) * 100
                win_rate_change = today_win_rate - yesterday_win_rate
                
                message = f'''
ğŸ“Š <b>AImax æ¯æ—¥äº¤æ˜“å ±å‘Š</b>

ğŸ“… <b>å ±å‘Šæ—¥æœŸ</b>: {today}
ğŸ• <b>ç”Ÿæˆæ™‚é–“</b>: {now_taipei.strftime('%H:%M:%S')}

ğŸ“ˆ <b>ä»Šæ—¥è¡¨ç¾</b>:
â€¢ åŸ·è¡Œæ¬¡æ•¸: {today_executions} ({'+' if execution_change >= 0 else ''}{execution_change} vs æ˜¨æ—¥)
â€¢ å‹ç‡: {today_win_rate:.1f}% ({'+' if win_rate_change >= 0 else ''}{win_rate_change:.1f}% vs æ˜¨æ—¥)
â€¢ å¹³å‡ä¿¡å¿ƒåº¦: {today_stats.get('average_confidence', 0.85):.0%}

ğŸ¯ <b>ç­–ç•¥åˆ†æ</b>:
â€¢ é«˜æ³¢å‹•åŸ·è¡Œ: {today_stats.get('high_volatility_executions', 0)} æ¬¡
â€¢ æ™ºèƒ½é »ç‡æ§åˆ¶: {'âœ… æœ‰æ•ˆ' if today_stats.get('high_volatility_executions', 0) > 0 else 'ğŸ“Š æ­£å¸¸'}
â€¢ 85%å‹ç‡ç›®æ¨™: {'ğŸ¯ å·²é”æˆ' if today_win_rate >= 85 else 'âš ï¸ æŒçºŒå„ªåŒ–ä¸­'}

ğŸ’¾ <b>ç³»çµ±å¥åº·</b>:
â€¢ GitHub Actions: âœ… æ­£å¸¸
â€¢ æ•¸æ“šå­˜å„²: âœ… æ­£å¸¸  
â€¢ APIé€£æ¥: âœ… æ­£å¸¸

ğŸ”® <b>æ˜æ—¥å±•æœ›</b>:
â€¢ ç¹¼çºŒ85%å‹ç‡ç­–ç•¥
â€¢ æ™ºèƒ½é »ç‡æ§åˆ¶å„ªåŒ–
â€¢ ç³»çµ±ç©©å®šæ€§æå‡

<i>ğŸš€ AImax æŒçºŒç‚ºæ‚¨å‰µé€ åƒ¹å€¼</i>
                '''.strip()
                
                return self.send_message(message)
            
            def send_test_message(self):
                taipei_tz = pytz.timezone('Asia/Taipei')
                now_taipei = datetime.now(taipei_tz)
                
                message = f'''
ğŸ§ª <b>AImax Telegramæ¸¬è©¦</b>

âœ… <b>é€£æ¥ç‹€æ…‹</b>: æ­£å¸¸
ğŸ¤– <b>æ©Ÿå™¨äºº</b>: é‹è¡Œä¸­
ğŸ“± <b>é€šçŸ¥ç³»çµ±</b>: å·²å•Ÿç”¨

ğŸ• <b>æ¸¬è©¦æ™‚é–“</b>: {now_taipei.strftime('%Y-%m-%d %H:%M:%S')}
â˜ï¸ <b>åŸ·è¡Œç’°å¢ƒ</b>: GitHub Actions

ğŸ¯ <b>åŠŸèƒ½æ¸¬è©¦</b>:
â€¢ ç³»çµ±ç‹€æ…‹é€šçŸ¥ âœ…
â€¢ äº¤æ˜“æ‘˜è¦é€šçŸ¥ âœ…  
â€¢ ç·Šæ€¥è­¦å ±é€šçŸ¥ âœ…
â€¢ æ¯æ—¥å ±å‘Šé€šçŸ¥ âœ…

ğŸ’¡ <b>é€šçŸ¥ç³»çµ±å·²æº–å‚™å°±ç·’ï¼</b>

<i>ğŸ”” AImax æ™ºèƒ½é€šçŸ¥ç³»çµ±</i>
                '''.strip()
                
                return self.send_message(message)
        
        # æª¢æŸ¥Telegramé…ç½®
        bot_token = os.environ.get('TELEGRAM_BOT_TOKEN', '')
        chat_id = os.environ.get('TELEGRAM_CHAT_ID', '')
        
        if not bot_token or not chat_id:
            print('âš ï¸ Telegramé…ç½®æœªè¨­ç½®ï¼Œè·³éé€šçŸ¥')
            print('è«‹åœ¨GitHub Secretsä¸­è¨­ç½® TELEGRAM_BOT_TOKEN å’Œ TELEGRAM_CHAT_ID')
            exit(0)
        
        # å‰µå»ºé€šçŸ¥å™¨
        notifier = TelegramNotifier(bot_token, chat_id)
        
        # æ ¹æ“šè¼¸å…¥é¡å‹ç™¼é€é€šçŸ¥
        notification_type = os.environ.get('INPUT_NOTIFICATION_TYPE', 'system_status')
        custom_message = os.environ.get('INPUT_CUSTOM_MESSAGE', '')
        
        print(f'ğŸ“± ç™¼é€é€šçŸ¥é¡å‹: {notification_type}')
        
        success = False
        
        if notification_type == 'system_status':
            success = notifier.send_system_status()
        elif notification_type == 'trading_summary':
            success = notifier.send_trading_summary()
        elif notification_type == 'emergency_alert':
            success = notifier.send_emergency_alert(custom_message)
        elif notification_type == 'daily_report':
            success = notifier.send_daily_report()
        elif notification_type == 'test_message':
            success = notifier.send_test_message()
        else:
            print(f'âŒ æœªçŸ¥çš„é€šçŸ¥é¡å‹: {notification_type}')
            exit(1)
        
        if success:
            print('âœ… Telegramé€šçŸ¥ç™¼é€æˆåŠŸ')
        else:
            print('âŒ Telegramé€šçŸ¥ç™¼é€å¤±æ•—')
            exit(1)
        "
        
    - name: ğŸ“Š è¨˜éŒ„é€šçŸ¥æ­·å²
      if: always()
      run: |
        echo "ğŸ“Š è¨˜éŒ„Telegramé€šçŸ¥æ­·å²..."
        python -c "
        import json
        import os
        from datetime import datetime
        
        # å‰µå»ºé€šçŸ¥è¨˜éŒ„
        notification_record = {
            'timestamp': datetime.now().isoformat(),
            'notification_type': os.environ.get('INPUT_NOTIFICATION_TYPE', 'system_status'),
            'custom_message': os.environ.get('INPUT_CUSTOM_MESSAGE', ''),
            'github_run_id': os.environ.get('GITHUB_RUN_ID', 'unknown'),
            'status': 'completed'
        }
        
        # ä¿å­˜åˆ°é€šçŸ¥æ­·å²
        os.makedirs('data/notifications', exist_ok=True)
        today = datetime.now().strftime('%Y-%m-%d')
        history_file = f'data/notifications/telegram_history_{today}.jsonl'
        
        with open(history_file, 'a', encoding='utf-8') as f:
            f.write(json.dumps(notification_record, ensure_ascii=False) + '\\n')
        
        # æ›´æ–°æœ€æ–°é€šçŸ¥è¨˜éŒ„
        with open('data/notifications/latest_notification.json', 'w', encoding='utf-8') as f:
            json.dump(notification_record, f, indent=2, ensure_ascii=False)
        
        print('ğŸ“ é€šçŸ¥æ­·å²è¨˜éŒ„å·²ä¿å­˜')
        "
        
    - name: ğŸ“¤ ä¿å­˜é€šçŸ¥æ•¸æ“š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: telegram-notifications-${{ github.run_number }}
        path: data/notifications/
        retention-days: 7