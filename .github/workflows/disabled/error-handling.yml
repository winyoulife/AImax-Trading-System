name: ğŸ› ï¸ AImax éŒ¯èª¤è™•ç†å’Œæ•…éšœæ¢å¾©

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/error_handling/**'
      - 'scripts/test_error_handling.py'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/error_handling/**'
  schedule:
    # æ¯6å°æ™‚é‹è¡Œä¸€æ¬¡éŒ¯èª¤è™•ç†æ¸¬è©¦
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'é¸æ“‡æ¸¬è©¦é¡å‹'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - error_handler
        - network
        - rate_limiter
        - transaction
        - system_recovery

jobs:
  error-handling-tests:
    name: ğŸ§ª éŒ¯èª¤è™•ç†æ¸¬è©¦
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install psutil requests
    
    - name: ğŸ› ï¸ é‹è¡ŒéŒ¯èª¤è™•ç†æ¸¬è©¦
      run: |
        python scripts/test_error_handling.py
      continue-on-error: true
    
    - name: ğŸ“Š ä¸Šå‚³æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: error-handling-test-reports
        path: reports/
        retention-days: 30

  network-resilience-test:
    name: ğŸŒ ç¶²è·¯éŸŒæ€§æ¸¬è©¦
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'network' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests psutil
    
    - name: ğŸŒ æ¸¬è©¦ç¶²è·¯é€£æ¥è™•ç†
      run: |
        python -c "
import sys
sys.path.append('.')
from src.error_handling.network_handler import network_handler, check_connectivity
import time

print('ğŸ” æ¸¬è©¦ç¶²è·¯é€£æ¥...')
connectivity = check_connectivity()
print(f'ç¶²è·¯ç‹€æ…‹: {\"âœ… æ­£å¸¸\" if connectivity else \"âŒ ç•°å¸¸\"}')

print('\\nğŸ“Š æ¸¬è©¦å¤šå€‹ç«¯é»...')
test_urls = [
    'https://api.github.com',
    'https://httpbin.org/status/200',
    'https://www.google.com'
]

for url in test_urls:
    result = network_handler.test_specific_endpoint(url)
    status = 'âœ… æˆåŠŸ' if result['success'] else 'âŒ å¤±æ•—'
    print(f'{url}: {status} ({result.get(\"response_time\", 0):.3f}s)')

print('\\nğŸ“ˆ ç¶²è·¯çµ±è¨ˆ:')
stats = network_handler.get_connection_stats()
print(f'ç¸½è«‹æ±‚: {stats[\"total_requests\"]}')
print(f'æˆåŠŸç‡: {stats[\"success_rate\"]:.1f}%')
"
    
    - name: ğŸ”„ æ¸¬è©¦é‡è©¦æ©Ÿåˆ¶
      run: |
        python -c "
import sys
sys.path.append('.')
from src.error_handling.error_handler import with_retry
import random
import time

@with_retry(max_retries=3, base_delay=1.0)
def flaky_network_call():
    if random.random() < 0.7:  # 70% æˆåŠŸç‡
        return 'Network call successful'
    else:
        raise Exception('Network timeout')

print('ğŸ”„ æ¸¬è©¦ç¶²è·¯é‡è©¦æ©Ÿåˆ¶...')
for i in range(5):
    try:
        result = flaky_network_call()
        print(f'å˜—è©¦ {i+1}: âœ… {result}')
    except Exception as e:
        print(f'å˜—è©¦ {i+1}: âŒ {e}')
    time.sleep(1)
"

  rate-limiting-test:
    name: â±ï¸ é »ç‡é™åˆ¶æ¸¬è©¦
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'rate_limiter' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: â±ï¸ æ¸¬è©¦APIé »ç‡é™åˆ¶
      run: |
        python -c "
import sys
sys.path.append('.')
from src.error_handling.rate_limiter import rate_limiter, rate_limited
import time

# è¨­ç½®æ¸¬è©¦APIé™åˆ¶
rate_limiter.set_rate_limit('github_api_test', {
    'requests_per_minute': 3,
    'requests_per_hour': 100
})

@rate_limited('github_api_test')
def mock_github_api_call(call_id):
    print(f'ğŸ“ GitHub API èª¿ç”¨ {call_id}')
    return f'API Response {call_id}'

print('â±ï¸ æ¸¬è©¦GitHub APIé »ç‡é™åˆ¶...')
for i in range(6):
    try:
        result = mock_github_api_call(i+1)
        print(f'  âœ… {result}')
    except Exception as e:
        print(f'  âŒ èª¿ç”¨ {i+1} è¢«é™åˆ¶: {e}')
    
    time.sleep(2)

# é¡¯ç¤ºä½¿ç”¨çµ±è¨ˆ
usage = rate_limiter.get_api_stats('github_api_test')
print(f'\\nğŸ“Š APIä½¿ç”¨çµ±è¨ˆ:')
print(f'ç•¶å‰ä½¿ç”¨: {usage[\"current_usage\"]}')
print(f'ä½¿ç”¨ç‡: {usage[\"usage_percentage\"]}')
"

  transaction-rollback-test:
    name: ğŸ”„ äº¤æ˜“å›æ»¾æ¸¬è©¦
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'transaction' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ”„ æ¸¬è©¦äº¤æ˜“å›æ»¾æ©Ÿåˆ¶
      run: |
        python -c "
import sys
sys.path.append('.')
from src.error_handling.transaction_rollback import transaction_manager
import time

print('ğŸ”„ æ¸¬è©¦äº¤æ˜“å›æ»¾æ©Ÿåˆ¶...')

# å‰µå»ºæ¸¬è©¦äº¤æ˜“
transaction_id = transaction_manager.create_transaction(
    'github_actions_test', 'GitHub Actions äº¤æ˜“å›æ»¾æ¸¬è©¦'
)

# æ·»åŠ äº¤æ˜“æ­¥é©Ÿ
transaction_manager.add_step(
    transaction_id, 'æ¨¡æ“¬è²·å…¥', 'simulate_buy',
    {'symbol': 'BTCUSDT', 'amount': 100},
    'buy_order'
)

transaction_manager.add_step(
    transaction_id, 'æ›´æ–°é¤˜é¡', 'update_balance',
    {'old_balance': 1000, 'new_balance': 900},
    'balance_update'
)

# åŸ·è¡Œäº¤æ˜“
result = transaction_manager.execute_transaction(transaction_id)
print(f'äº¤æ˜“åŸ·è¡Œçµæœ: {result}')

# ç²å–äº¤æ˜“ç‹€æ…‹
status = transaction_manager.get_transaction_status(transaction_id)
print(f'äº¤æ˜“ç‹€æ…‹: {status[\"status\"]}')

# é¡¯ç¤ºçµ±è¨ˆ
stats = transaction_manager.get_statistics()
print(f'\\nğŸ“Š äº¤æ˜“çµ±è¨ˆ:')
print(f'ç¸½äº¤æ˜“: {stats[\"total_transactions\"]}')
print(f'æˆåŠŸç‡: {stats[\"success_rate\"]:.1f}%')
print(f'å›æ»¾ç‡: {stats[\"rollback_rate\"]:.1f}%')
"

  system-recovery-test:
    name: ğŸ”§ ç³»çµ±æ¢å¾©æ¸¬è©¦
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'system_recovery' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install psutil
    
    - name: ğŸ”§ æ¸¬è©¦ç³»çµ±å¥åº·æª¢æŸ¥
      run: |
        python -c "
import sys
sys.path.append('.')
from src.error_handling.system_recovery import system_recovery_manager
import time

print('ğŸ”§ é‹è¡Œç³»çµ±å¥åº·æª¢æŸ¥...')

# é‹è¡Œå¥åº·æª¢æŸ¥
health_results = system_recovery_manager.run_health_checks()

print('\\nğŸ“Š å¥åº·æª¢æŸ¥çµæœ:')
for check_name, result in health_results.items():
    status = result.get('status', 'unknown')
    value = result.get('value', 0)
    status_str = status.value if hasattr(status, 'value') else str(status)
    print(f'  {check_name}: {status_str} ({value})')

# ç²å–ç³»çµ±ç‹€æ…‹
system_status = system_recovery_manager.get_system_status()
print(f'\\nğŸ¥ ç³»çµ±æ•´é«”å¥åº·: {system_status[\"overall_health\"]}')
print(f'å¥åº·æª¢æŸ¥æ•¸é‡: {system_status[\"health_checks_count\"]}')
print(f'æ¢å¾©è¨ˆåŠƒæ•¸é‡: {system_status[\"recovery_plans_count\"]}')
"
    
    - name: ğŸ” æ¸¬è©¦çŸ­æœŸç›£æ§
      run: |
        python -c "
import sys
sys.path.append('.')
from src.error_handling.system_recovery import system_recovery_manager
import time

print('ğŸ” å•Ÿå‹•çŸ­æœŸç³»çµ±ç›£æ§æ¸¬è©¦...')

# å•Ÿå‹•ç›£æ§
system_recovery_manager.start_monitoring()

# é‹è¡Œ30ç§’
print('ç›£æ§é‹è¡Œä¸­...')
time.sleep(30)

# åœæ­¢ç›£æ§
system_recovery_manager.stop_monitoring()

# ç²å–æœ€çµ‚ç‹€æ…‹
final_status = system_recovery_manager.get_system_status()
print(f'\\nâœ… ç›£æ§æ¸¬è©¦å®Œæˆ')
print(f'æœ€çµ‚å¥åº·ç‹€æ…‹: {final_status[\"overall_health\"]}')
print(f'é€£çºŒå¤±æ•—æ¬¡æ•¸: {final_status[\"consecutive_failures\"]}')
"

  integration-test:
    name: ğŸ¯ é›†æˆæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: [error-handling-tests, network-resilience-test, rate-limiting-test, transaction-rollback-test, system-recovery-test]
    if: always()
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install psutil requests
    
    - name: ğŸ¯ é‹è¡Œé›†æˆæ¸¬è©¦
      run: |
        python -c "
import sys
sys.path.append('.')
from src.error_handling.error_handler import error_handler, with_retry, handle_errors
from src.error_handling.network_handler import safe_request
from src.error_handling.rate_limiter import rate_limited
import time

print('ğŸ¯ é‹è¡ŒéŒ¯èª¤è™•ç†é›†æˆæ¸¬è©¦...')

@handle_errors
@with_retry(max_retries=2)
@rate_limited('integration_test')
def integrated_operation():
    print('åŸ·è¡Œé›†æˆæ“ä½œ...')
    
    # æ¨¡æ“¬ç¶²è·¯è«‹æ±‚
    response = safe_request('https://httpbin.org/status/200')
    if not response:
        raise Exception('ç¶²è·¯è«‹æ±‚å¤±æ•—')
    
    return 'é›†æˆæ“ä½œæˆåŠŸ'

try:
    result = integrated_operation()
    print(f'âœ… é›†æˆæ¸¬è©¦æˆåŠŸ: {result}')
except Exception as e:
    print(f'âŒ é›†æˆæ¸¬è©¦å¤±æ•—: {e}')

# é¡¯ç¤ºæœ€çµ‚çµ±è¨ˆ
print('\\nğŸ“Š æœ€çµ‚çµ±è¨ˆ:')
error_stats = error_handler.get_error_statistics()
print(f'éŒ¯èª¤è™•ç†çµ±è¨ˆ: {error_stats}')
"
    
    - name: ğŸ“Š ç”Ÿæˆæœ€çµ‚å ±å‘Š
      run: |
        echo '## ğŸ› ï¸ AImax éŒ¯èª¤è™•ç†æ¸¬è©¦çµæœ' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY
        echo '### âœ… æ¸¬è©¦å®Œæˆé …ç›®' >> $GITHUB_STEP_SUMMARY
        echo '- éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶' >> $GITHUB_STEP_SUMMARY
        echo '- ç¶²è·¯é€£æ¥éŸŒæ€§æ¸¬è©¦' >> $GITHUB_STEP_SUMMARY
        echo '- APIé »ç‡é™åˆ¶æ§åˆ¶' >> $GITHUB_STEP_SUMMARY
        echo '- äº¤æ˜“å›æ»¾æ©Ÿåˆ¶' >> $GITHUB_STEP_SUMMARY
        echo '- ç³»çµ±è‡ªå‹•æ¢å¾©' >> $GITHUB_STEP_SUMMARY
        echo '- é›†æˆæ¸¬è©¦é©—è­‰' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY
        echo '### ğŸ“ˆ æ¸¬è©¦è¦†è“‹ç¯„åœ' >> $GITHUB_STEP_SUMMARY
        echo '- ç¶²è·¯é€£æ¥å¤±æ•—é‡è©¦' >> $GITHUB_STEP_SUMMARY
        echo '- APIé™åˆ¶å’Œé »ç‡æ§åˆ¶' >> $GITHUB_STEP_SUMMARY
        echo '- äº¤æ˜“åŸ·è¡Œå¤±æ•—å›æ»¾' >> $GITHUB_STEP_SUMMARY
        echo '- ç³»çµ±ç•°å¸¸è‡ªå‹•æ¢å¾©' >> $GITHUB_STEP_SUMMARY
        echo '- ç†”æ–·å™¨ä¿è­·æ©Ÿåˆ¶' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY
        echo 'ğŸ‰ æ‰€æœ‰éŒ¯èª¤è™•ç†æ©Ÿåˆ¶æ¸¬è©¦å®Œæˆï¼' >> $GITHUB_STEP_SUMMARY
    
    - name: ğŸ“Š ä¸Šå‚³é›†æˆæ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: error-handling-integration-reports
        path: reports/
        retention-days: 90