name: ğŸ“Š AImax è³‡æºä½¿ç”¨ç›£æ§å’Œå„ªåŒ–

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/monitoring/**'
      - 'scripts/test_resource_monitoring.py'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/monitoring/**'
  schedule:
    # æ¯4å°æ™‚é‹è¡Œä¸€æ¬¡è³‡æºç›£æ§
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      monitoring_type:
        description: 'é¸æ“‡ç›£æ§é¡å‹'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - system_resources
        - github_usage
        - storage_optimization

jobs:
  system-resource-monitoring:
    name: ğŸ–¥ï¸ ç³»çµ±è³‡æºç›£æ§
    runs-on: ubuntu-latest
    if: github.event.inputs.monitoring_type == 'system_resources' || github.event.inputs.monitoring_type == 'all' || github.event.inputs.monitoring_type == ''
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install psutil requests
    
    - name: ğŸ–¥ï¸ ç›£æ§ç³»çµ±è³‡æº
      run: |
        python -c "
import sys
sys.path.append('.')
from src.monitoring.resource_monitor import resource_monitor
import time

print('ğŸ–¥ï¸ ç³»çµ±è³‡æºç›£æ§æ¸¬è©¦...')

# æ”¶é›†ç³»çµ±è³‡æº
usage = resource_monitor._collect_system_resources()
print(f'CPUä½¿ç”¨ç‡: {usage.cpu_percent:.1f}%')
print(f'è¨˜æ†¶é«”ä½¿ç”¨ç‡: {usage.memory_percent:.1f}%')
print(f'ç£ç¢Ÿä½¿ç”¨: {usage.disk_usage_gb:.2f} GB')
print(f'ç£ç¢Ÿå‰©é¤˜: {usage.disk_free_gb:.2f} GB')

# æª¢æŸ¥è³‡æºè­¦å‘Š
stats = resource_monitor.get_resource_statistics()
if 'current_usage' in stats:
    current = stats['current_usage']
    
    # æª¢æŸ¥è­¦å‘Šé–¾å€¼
    if current['cpu_percent'] > 80:
        print(f'âš ï¸ CPUä½¿ç”¨ç‡éé«˜: {current[\"cpu_percent\"]:.1f}%')
    
    if current['memory_percent'] > 85:
        print(f'âš ï¸ è¨˜æ†¶é«”ä½¿ç”¨ç‡éé«˜: {current[\"memory_percent\"]:.1f}%')
    
    if current['disk_free_gb'] < 1:
        print(f'âš ï¸ ç£ç¢Ÿç©ºé–“ä¸è¶³: {current[\"disk_free_gb\"]:.2f} GB')

# ç”Ÿæˆå„ªåŒ–å»ºè­°
recommendations = resource_monitor.generate_optimization_recommendations()
if recommendations:
    print(f'\\nğŸ’¡ å„ªåŒ–å»ºè­° ({len(recommendations)} æ¢):')
    for i, rec in enumerate(recommendations[:3], 1):
        print(f'  {i}. {rec[\"category\"]}: {rec[\"issue\"]}')
else:
    print('\\nâœ… ç³»çµ±è³‡æºä½¿ç”¨æ­£å¸¸')
"
    
    - name: ğŸ§¹ è‡ªå‹•æ¸…ç†è³‡æº
      run: |
        python -c "
import sys
sys.path.append('.')
from src.monitoring.resource_monitor import resource_monitor

print('ğŸ§¹ åŸ·è¡Œè‡ªå‹•è³‡æºæ¸…ç†...')

# æ¸…ç†è‡¨æ™‚æ–‡ä»¶
cleanup_result = resource_monitor.cleanup_temporary_files()
print(f'æ¸…ç†çµæœ: é‡‹æ”¾ {cleanup_result[\"freed_space_mb\"]:.2f} MB ç©ºé–“')

if cleanup_result['freed_space_mb'] > 0:
    print(f'æ¸…ç†ç›®éŒ„: {cleanup_result[\"cleaned_directories\"]}')
"

  github-usage-monitoring:
    name: ğŸš€ GitHub Actionsä½¿ç”¨é‡ç›£æ§
    runs-on: ubuntu-latest
    if: github.event.inputs.monitoring_type == 'github_usage' || github.event.inputs.monitoring_type == 'all' || github.event.inputs.monitoring_type == ''
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests
    
    - name: ğŸš€ ç›£æ§GitHub Actionsä½¿ç”¨é‡
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python -c "
import sys
sys.path.append('.')
from src.monitoring.github_usage_monitor import github_usage_monitor
import os

print('ğŸš€ GitHub Actionsä½¿ç”¨é‡ç›£æ§...')

# æª¢æŸ¥APIè¨ªå•
if not github_usage_monitor.can_access_github_api():
    print('âš ï¸ ç„¡æ³•è¨ªå•GitHub APIï¼Œè«‹æª¢æŸ¥é…ç½®')
    exit(0)

# ç²å–ç•¶å‰é…é¡
quota = github_usage_monitor.get_current_quota()
if quota:
    print(f'ğŸ“Š GitHub Actionsé…é¡:')
    print(f'  ç¸½é…é¡: {quota.total_minutes} åˆ†é˜/æœˆ')
    print(f'  å·²ä½¿ç”¨: {quota.used_minutes} åˆ†é˜ ({quota.usage_percentage:.1f}%)')
    print(f'  å‰©é¤˜: {quota.remaining_minutes} åˆ†é˜')
    
    # æª¢æŸ¥ä½¿ç”¨é‡è­¦å‘Š
    if quota.usage_percentage >= 90:
        print(f'ğŸš¨ GitHub Actionsä½¿ç”¨é‡å±éšª: {quota.usage_percentage:.1f}%')
        print('å»ºè­°ç«‹å³æ¸›å°‘å·¥ä½œæµåŸ·è¡Œé »ç‡')
    elif quota.usage_percentage >= 75:
        print(f'âš ï¸ GitHub Actionsä½¿ç”¨é‡è­¦å‘Š: {quota.usage_percentage:.1f}%')
        print('å»ºè­°å„ªåŒ–å·¥ä½œæµä»¥æ¸›å°‘ä½¿ç”¨é‡')
    else:
        print('âœ… GitHub Actionsä½¿ç”¨é‡æ­£å¸¸')
else:
    print('âŒ ç„¡æ³•ç²å–GitHubé…é¡ä¿¡æ¯')

# ç²å–å·¥ä½œæµé‹è¡Œè¨˜éŒ„
workflow_runs = github_usage_monitor.get_workflow_runs(days=7)
print(f'\\nğŸ“‹ æœ€è¿‘7å¤©å·¥ä½œæµé‹è¡Œ: {len(workflow_runs)} æ¬¡')

if workflow_runs:
    # åˆ†æä½¿ç”¨æ¨¡å¼
    usage_analysis = github_usage_monitor.analyze_usage_patterns()
    if 'error' not in usage_analysis:
        print(f'ç¸½åŸ·è¡Œæ™‚é–“: {usage_analysis[\"total_duration_minutes\"]:.1f} åˆ†é˜')
        print(f'å¹³å‡åŸ·è¡Œæ™‚é–“: {usage_analysis[\"avg_duration_per_run\"]:.1f} åˆ†é˜/æ¬¡')
        print(f'æœ€å¸¸ç”¨å·¥ä½œæµ: {usage_analysis[\"most_used_workflow\"] or \"N/A\"}')

# ç²å–å„ªåŒ–å»ºè­°
suggestions = github_usage_monitor.get_optimization_suggestions()
if suggestions:
    print(f'\\nğŸ’¡ å„ªåŒ–å»ºè­° ({len(suggestions)} æ¢):')
    for i, suggestion in enumerate(suggestions[:3], 1):
        print(f'  {i}. {suggestion[\"category\"]}: {suggestion[\"issue\"]}')
"
    
    - name: ğŸ“Š ç”Ÿæˆä½¿ç”¨é‡å ±å‘Š
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python -c "
import sys
sys.path.append('.')
from src.monitoring.github_usage_monitor import github_usage_monitor

if github_usage_monitor.can_access_github_api():
    print('ğŸ“Š ç”ŸæˆGitHubä½¿ç”¨é‡å ±å‘Š...')
    report = github_usage_monitor.generate_usage_report()
    print(report[:500] + '...' if len(report) > 500 else report)
    
    # ä¿å­˜å ±å‘Š
    data_file = github_usage_monitor.save_usage_data()
    print(f'ğŸ“„ ä½¿ç”¨é‡æ•¸æ“šå·²ä¿å­˜')
"

  storage-optimization:
    name: ğŸ’¾ å­˜å„²ç©ºé–“å„ªåŒ–
    runs-on: ubuntu-latest
    if: github.event.inputs.monitoring_type == 'storage_optimization' || github.event.inputs.monitoring_type == 'all' || github.event.inputs.monitoring_type == ''
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ’¾ æƒæå­˜å„²ä½¿ç”¨æƒ…æ³
      run: |
        python -c "
import sys
sys.path.append('.')
from src.monitoring.storage_optimizer import storage_optimizer

print('ğŸ’¾ æƒæå­˜å„²ä½¿ç”¨æƒ…æ³...')

# æƒæå­˜å„²
storage_info = storage_optimizer.scan_storage_usage()

if 'error' not in storage_info:
    print(f'ğŸ“Š å­˜å„²çµ±è¨ˆ:')
    print(f'  ç¸½å¤§å°: {storage_info[\"total_size_mb\"]:.2f} MB ({storage_info[\"total_size_gb\"]:.2f} GB)')
    print(f'  ç¸½æ–‡ä»¶æ•¸: {storage_info[\"total_files\"]:,}')
    print(f'  æƒææ™‚é–“: {storage_info[\"scan_time_seconds\"]:.2f} ç§’')
    
    # é¡¯ç¤ºæœ€å¤§ç›®éŒ„
    if 'largest_directories' in storage_info:
        print('\\nğŸ“ æœ€å¤§ç›®éŒ„ (å‰5å):')
        for dir_name, size_mb in storage_info['largest_directories'][:5]:
            print(f'  {dir_name}: {size_mb:.2f} MB')
    
    # æª¢æŸ¥å­˜å„²è­¦å‘Š
    if storage_info['total_size_gb'] > 1.0:
        print(f'âš ï¸ é …ç›®å¤§å°éå¤§: {storage_info[\"total_size_gb\"]:.2f} GB')
    
    if storage_info['total_files'] > 10000:
        print(f'âš ï¸ æ–‡ä»¶æ•¸é‡éå¤š: {storage_info[\"total_files\"]:,}')
else:
    print(f'âŒ å­˜å„²æƒæå¤±æ•—: {storage_info[\"error\"]}')
"
    
    - name: ğŸ§¹ åŸ·è¡Œå­˜å„²æ¸…ç†
      run: |
        python -c "
import sys
sys.path.append('.')
from src.monitoring.storage_optimizer import storage_optimizer

print('ğŸ§¹ åŸ·è¡Œå­˜å„²æ¸…ç†...')

# æ¸…ç†æ—¥èªŒæ–‡ä»¶
log_result = storage_optimizer.cleanup_log_files()
if log_result.freed_space_mb > 0:
    print(f'ğŸ“„ æ¸…ç†æ—¥èªŒ: {log_result.cleaned_files} å€‹æ–‡ä»¶ï¼Œé‡‹æ”¾ {log_result.freed_space_mb:.2f} MB')

# æ¸…ç†è‡¨æ™‚æ–‡ä»¶
temp_result = storage_optimizer.cleanup_temporary_files()
if temp_result.freed_space_mb > 0:
    print(f'ğŸ—‚ï¸ æ¸…ç†è‡¨æ™‚æ–‡ä»¶: {temp_result.cleaned_files} å€‹æ–‡ä»¶ï¼Œé‡‹æ”¾ {temp_result.freed_space_mb:.2f} MB')

# æ¸…ç†èˆŠå ±å‘Š
report_result = storage_optimizer.cleanup_old_reports()
if report_result.freed_space_mb > 0:
    print(f'ğŸ“Š æ¸…ç†èˆŠå ±å‘Š: {report_result.cleaned_files} å€‹æ–‡ä»¶ï¼Œé‡‹æ”¾ {report_result.freed_space_mb:.2f} MB')

total_freed = log_result.freed_space_mb + temp_result.freed_space_mb + report_result.freed_space_mb
print(f'\\nâœ… ç¸½å…±é‡‹æ”¾: {total_freed:.2f} MB ç©ºé–“')

# é¡¯ç¤ºéŒ¯èª¤ï¼ˆå¦‚æœæœ‰ï¼‰
all_errors = log_result.errors + temp_result.errors + report_result.errors
if all_errors:
    print(f'\\nâš ï¸ æ¸…ç†éç¨‹ä¸­çš„éŒ¯èª¤:')
    for error in all_errors[:3]:  # åªé¡¯ç¤ºå‰3å€‹éŒ¯èª¤
        print(f'  â€¢ {error}')
"

  comprehensive-monitoring:
    name: ğŸ“‹ ç¶œåˆç›£æ§å ±å‘Š
    runs-on: ubuntu-latest
    needs: [system-resource-monitoring, github-usage-monitoring, storage-optimization]
    if: always()
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install psutil requests
    
    - name: ğŸ“‹ ç”Ÿæˆç¶œåˆç›£æ§å ±å‘Š
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python -c "
import sys
sys.path.append('.')
from src.monitoring.resource_monitor import resource_monitor
from src.monitoring.github_usage_monitor import github_usage_monitor
from src.monitoring.storage_optimizer import storage_optimizer
from datetime import datetime

print('ğŸ“‹ ç”ŸæˆAImaxç¶œåˆç›£æ§å ±å‘Š...')

# æ”¶é›†ç³»çµ±è³‡æºæ•¸æ“š
resource_usage = resource_monitor._collect_system_resources()

# æ”¶é›†å­˜å„²æ•¸æ“š
storage_info = storage_optimizer.scan_storage_usage()

# æ”¶é›†GitHubæ•¸æ“šï¼ˆå¦‚æœå¯ç”¨ï¼‰
github_quota = None
if github_usage_monitor.can_access_github_api():
    github_quota = github_usage_monitor.get_current_quota()

# ç”Ÿæˆå ±å‘Š
report = f'''
ğŸ“Š AImax è³‡æºç›£æ§ç¶œåˆå ±å‘Š (GitHub Actions)
{'='*60}

ğŸ–¥ï¸ ç³»çµ±è³‡æºç‹€æ…‹:
   CPUä½¿ç”¨ç‡: {resource_usage.cpu_percent:.1f}%
   è¨˜æ†¶é«”ä½¿ç”¨ç‡: {resource_usage.memory_percent:.1f}%
   ç£ç¢Ÿä½¿ç”¨: {resource_usage.disk_usage_gb:.2f} GB
   ç£ç¢Ÿå‰©é¤˜: {resource_usage.disk_free_gb:.2f} GB
   æ–‡ä»¶æ•¸é‡: {resource_usage.file_count:,}
'''

if 'error' not in storage_info:
    report += f'''
ğŸ’¾ å­˜å„²ç©ºé–“ç‹€æ…‹:
   ç¸½å¤§å°: {storage_info['total_size_mb']:.2f} MB ({storage_info['total_size_gb']:.2f} GB)
   ç¸½æ–‡ä»¶æ•¸: {storage_info['total_files']:,}
'''

if github_quota:
    report += f'''
ğŸš€ GitHub Actionsç‹€æ…‹:
   ä½¿ç”¨ç‡: {github_quota.usage_percentage:.1f}%
   å·²ç”¨åˆ†é˜: {github_quota.used_minutes}
   å‰©é¤˜åˆ†é˜: {github_quota.remaining_minutes}
'''

report += f'''
{'='*60}
å ±å‘Šç”Ÿæˆæ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
GitHub Actions Runner: ubuntu-latest
'''

print(report)

# æª¢æŸ¥è­¦å‘Šæ¢ä»¶
warnings = []

if resource_usage.cpu_percent > 80:
    warnings.append(f'CPUä½¿ç”¨ç‡éé«˜: {resource_usage.cpu_percent:.1f}%')

if resource_usage.memory_percent > 85:
    warnings.append(f'è¨˜æ†¶é«”ä½¿ç”¨ç‡éé«˜: {resource_usage.memory_percent:.1f}%')

if resource_usage.disk_free_gb < 1:
    warnings.append(f'ç£ç¢Ÿç©ºé–“ä¸è¶³: {resource_usage.disk_free_gb:.2f} GB')

if github_quota and github_quota.usage_percentage > 80:
    warnings.append(f'GitHub Actionsä½¿ç”¨é‡éé«˜: {github_quota.usage_percentage:.1f}%')

if 'error' not in storage_info and storage_info['total_size_gb'] > 1:
    warnings.append(f'é …ç›®å¤§å°éå¤§: {storage_info[\"total_size_gb\"]:.2f} GB')

if warnings:
    print('\\nâš ï¸ ç™¼ç¾ä»¥ä¸‹è­¦å‘Š:')
    for warning in warnings:
        print(f'  â€¢ {warning}')
else:
    print('\\nâœ… æ‰€æœ‰è³‡æºä½¿ç”¨æ­£å¸¸')
"
    
    - name: ğŸ“Š ç”ŸæˆGitHub Step Summary
      run: |
        echo '## ğŸ“Š AImax è³‡æºç›£æ§çµæœ' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY
        echo '### âœ… ç›£æ§å®Œæˆé …ç›®' >> $GITHUB_STEP_SUMMARY
        echo '- ç³»çµ±è³‡æºç›£æ§ (CPUã€è¨˜æ†¶é«”ã€ç£ç¢Ÿ)' >> $GITHUB_STEP_SUMMARY
        echo '- GitHub Actionsä½¿ç”¨é‡ç›£æ§' >> $GITHUB_STEP_SUMMARY
        echo '- å­˜å„²ç©ºé–“å„ªåŒ–å’Œæ¸…ç†' >> $GITHUB_STEP_SUMMARY
        echo '- è‡ªå‹•è³‡æºæ¸…ç†å’Œå„ªåŒ–' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY
        echo '### ğŸ“ˆ ç›£æ§ç¯„åœ' >> $GITHUB_STEP_SUMMARY
        echo '- GitHub Actionså…è²»é¡åº¦ä½¿ç”¨é‡' >> $GITHUB_STEP_SUMMARY
        echo '- é …ç›®å­˜å„²ç©ºé–“ä½¿ç”¨çµ±è¨ˆ' >> $GITHUB_STEP_SUMMARY
        echo '- ç³»çµ±æ€§èƒ½æŒ‡æ¨™ç›£æ§' >> $GITHUB_STEP_SUMMARY
        echo '- è‡ªå‹•æ¸…ç†å’Œå„ªåŒ–å»ºè­°' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY
        echo 'ğŸ‰ è³‡æºç›£æ§å’Œå„ªåŒ–å®Œæˆï¼' >> $GITHUB_STEP_SUMMARY
    
    - name: ğŸ“Š ä¸Šå‚³ç›£æ§å ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: resource-monitoring-reports
        path: reports/
        retention-days: 30