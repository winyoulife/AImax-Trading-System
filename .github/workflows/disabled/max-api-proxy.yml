name: AImax MAX API æ•¸æ“šä»£ç†æœå‹™

on:
  schedule:
    # æ¯åˆ†é˜ç²å–ä¸€æ¬¡MAX APIæ•¸æ“š
    - cron: '* * * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼·åˆ¶æ›´æ–°æ•¸æ“š'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.10'
  
jobs:
  max-api-proxy:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ è¨­ç½®Pythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install requests pytz
        
    - name: ğŸ“¡ ç²å–MAX APIæ•¸æ“šä¸¦ç”Ÿæˆéœæ…‹æ–‡ä»¶
      run: |
        echo "ğŸ“¡ ç²å–MAX APIæ•¸æ“š..."
        python -c "
        import json
        import os
        import requests
        from datetime import datetime
        import pytz
        
        def fetch_max_api_data():
            taipei_tz = pytz.timezone('Asia/Taipei')
            now = datetime.now()
            now_taipei = now.astimezone(taipei_tz)
            
            api_data = {
                'timestamp': now.isoformat(),
                'taipei_time': now_taipei.isoformat(),
                'success': False,
                'data': {},
                'meta': {
                    'source': 'MAX API v2',
                    'fetch_method': 'github_actions_direct',
                    'data_age_seconds': 0,
                    'api_response_time_ms': 0
                },
                'status': {
                    'message': 'unknown',
                    'consecutive_failures': 0
                }
            }
            
            try:
                print('ğŸ“¡ ç›´æ¥èª¿ç”¨MAX API...')
                start_time = datetime.now()
                
                response = requests.get(
                    'https://max-api.maicoin.com/api/v2/tickers/btctwd',
                    timeout=10,
                    headers={'User-Agent': 'AImax-Trading-System/1.0'}
                )
                
                end_time = datetime.now()
                response_time = (end_time - start_time).total_seconds() * 1000
                
                if response.status_code == 200:
                    data = response.json()
                    
                    # è™•ç†å’Œå¢å¼·æ•¸æ“š
                    enhanced_data = {
                        'price': float(data.get('last', 0)),
                        'buy_price': float(data.get('buy', 0)),
                        'sell_price': float(data.get('sell', 0)),
                        'volume': float(data.get('vol', 0)),
                        'high_24h': float(data.get('high', 0)),
                        'low_24h': float(data.get('low', 0)),
                        'open_24h': float(data.get('open', 0)),
                        'formatted_price': f'NT\${float(data.get(\"last\", 0)):,.0f}',
                        'price_change_24h': 0,
                        'price_change_percent_24h': 0
                    }
                    
                    # è¨ˆç®—24å°æ™‚è®ŠåŒ–
                    if enhanced_data['open_24h'] > 0:
                        price_change = enhanced_data['price'] - enhanced_data['open_24h']
                        price_change_percent = (price_change / enhanced_data['open_24h']) * 100
                        enhanced_data['price_change_24h'] = price_change
                        enhanced_data['price_change_percent_24h'] = price_change_percent
                    
                    api_data['success'] = True
                    api_data['data'] = enhanced_data
                    api_data['meta']['api_response_time_ms'] = round(response_time, 2)
                    api_data['status']['message'] = 'success'
                    
                    print(f'âœ… MAX APIèª¿ç”¨æˆåŠŸ')
                    print(f'ğŸ’° BTCåƒ¹æ ¼: {enhanced_data[\"formatted_price\"]}')
                    print(f'ğŸ“Š 24å°æ™‚è®ŠåŒ–: {enhanced_data[\"price_change_percent_24h\"]:.2f}%')
                    print(f'â±ï¸ éŸ¿æ‡‰æ™‚é–“: {response_time:.0f}ms')
                    
                else:
                    api_data['status']['message'] = f'APIéŸ¿æ‡‰éŒ¯èª¤: {response.status_code}'
                    print(f'âŒ MAX APIéŸ¿æ‡‰éŒ¯èª¤: {response.status_code}')
                    
            except Exception as e:
                api_data['status']['message'] = f'APIèª¿ç”¨å¤±æ•—: {str(e)}'
                print(f'âŒ MAX APIèª¿ç”¨å¤±æ•—: {str(e)}')
            
            return api_data
        
        # ç²å–æ•¸æ“š
        result = fetch_max_api_data()
        
        # å‰µå»ºéœæ…‹APIæ–‡ä»¶ç›®éŒ„
        os.makedirs('static/api', exist_ok=True)
        
        # ä¿å­˜ç‚ºéœæ…‹APIæ–‡ä»¶
        with open('static/api/btc-price.json', 'w', encoding='utf-8') as f:
            json.dump(result, f, indent=2, ensure_ascii=False)
        
        # ä¿å­˜æ­·å²æ•¸æ“šï¼ˆç”¨æ–¼è¶¨å‹¢åˆ†æï¼‰
        history_file = 'static/api/price-history.jsonl'
        if result['success']:
            history_entry = {
                'timestamp': result['timestamp'],
                'price': result['data']['price'],
                'volume': result['data']['volume'],
                'change_24h': result['data']['price_change_percent_24h']
            }
            
            with open(history_file, 'a', encoding='utf-8') as f:
                f.write(json.dumps(history_entry, ensure_ascii=False) + '\\n')
            
            # ä¿æŒæ­·å²æ–‡ä»¶å¤§å°ï¼ˆåªä¿ç•™æœ€è¿‘1000æ¢è¨˜éŒ„ï¼‰
            try:
                with open(history_file, 'r', encoding='utf-8') as f:
                    lines = f.readlines()
                
                if len(lines) > 1000:
                    with open(history_file, 'w', encoding='utf-8') as f:
                        f.writelines(lines[-1000:])
                    print('ğŸ“ æ­·å²æ•¸æ“šå·²æ¸…ç†ï¼Œä¿ç•™æœ€è¿‘1000æ¢è¨˜éŒ„')
            except:
                pass
        
        # å‰µå»ºCORSå‹å¥½çš„éŸ¿æ‡‰é ­æ–‡ä»¶
        cors_headers = '''Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, OPTIONS
Access-Control-Allow-Headers: Content-Type
Cache-Control: no-cache, no-store, must-revalidate
Pragma: no-cache
Expires: 0'''
        
        with open('static/api/.htaccess', 'w') as f:
            f.write(cors_headers)
        
        print('âœ… éœæ…‹APIæ–‡ä»¶å·²ç”Ÿæˆ')
        print(f'ğŸ“ æ–‡ä»¶ä½ç½®: static/api/btc-price.json')
        "
        
    - name: ğŸ“Š æ›´æ–°ç³»çµ±ç‹€æ…‹
      run: |
        echo "ğŸ“Š æ›´æ–°ç³»çµ±ç‹€æ…‹..."
        python -c "
        import json
        import os
        from datetime import datetime
        
        # è®€å–å‰›ç”Ÿæˆçš„APIæ•¸æ“š
        api_data = {}
        try:
            with open('static/api/btc-price.json', 'r', encoding='utf-8') as f:
                api_data = json.load(f)
        except:
            pass
        
        # æ›´æ–°ç³»çµ±ç‹€æ…‹
        if api_data.get('success'):
            # æ›´æ–°äº¤æ˜“æ•¸æ“šç®¡ç†å™¨çš„åƒ¹æ ¼æ•¸æ“š
            os.makedirs('data/monitoring', exist_ok=True)
            
            price_data = {
                'price': api_data['data']['price'],
                'timestamp': api_data['timestamp'],
                'source': 'github_actions_max_api',
                'formatted_price': api_data['data']['formatted_price'],
                'change_24h': api_data['data']['price_change_percent_24h']
            }
            
            with open('data/monitoring/last_price.json', 'w', encoding='utf-8') as f:
                json.dump(price_data, f, indent=2, ensure_ascii=False)
            
            print('âœ… ç³»çµ±ç‹€æ…‹å·²æ›´æ–°')
            print(f'ğŸ’° ç•¶å‰åƒ¹æ ¼: {price_data[\"formatted_price\"]}')
        else:
            print('âš ï¸ APIæ•¸æ“šç²å–å¤±æ•—ï¼Œè·³éç‹€æ…‹æ›´æ–°')
        "
        
    - name: ğŸ“¤ æäº¤æ›´æ–°çš„éœæ…‹æ–‡ä»¶
      run: |
        git config --local user.email \"action@github.com\"
        git config --local user.name \"GitHub Action\"
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --quiet static/api/btc-price.json; then
          echo \"ğŸ“Š åƒ¹æ ¼æ•¸æ“šç„¡è®ŠåŒ–ï¼Œè·³éæäº¤\"
        else
          git add static/api/
          git add data/monitoring/ || true
          git commit -m \"ğŸ“Š è‡ªå‹•æ›´æ–°MAX APIæ•¸æ“š - $(date +'%Y-%m-%d %H:%M:%S')\" || echo \"ç„¡éœ€æäº¤\"
          git push || echo \"æ¨é€å¤±æ•—ï¼Œå¯èƒ½ç„¡è®Šæ›´\"
          echo \"âœ… éœæ…‹APIæ•¸æ“šå·²æ›´æ–°\"
        fi