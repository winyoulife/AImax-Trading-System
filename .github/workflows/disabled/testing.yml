name: ğŸ§ª AImax è‡ªå‹•åŒ–æ¸¬è©¦å¥—ä»¶

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2é»é‹è¡Œå®Œæ•´æ¸¬è©¦
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'é¸æ“‡è¦é‹è¡Œçš„æ¸¬è©¦å¥—ä»¶'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - unit
        - integration
        - e2e
        - simulation

jobs:
  test-setup:
    name: ğŸ”§ æ¸¬è©¦ç’°å¢ƒè¨­ç½®
    runs-on: ubuntu-latest
    outputs:
      test-matrix: ${{ steps.setup.outputs.test-matrix }}
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-html pytest-xdist
    
    - name: ğŸ”§ è¨­ç½®æ¸¬è©¦çŸ©é™£
      id: setup
      run: |
        if [ "${{ github.event.inputs.test_suite }}" = "unit" ]; then
          echo "test-matrix=[\"unit_tests\"]" >> $GITHUB_OUTPUT
        elif [ "${{ github.event.inputs.test_suite }}" = "integration" ]; then
          echo "test-matrix=[\"integration_tests\"]" >> $GITHUB_OUTPUT
        elif [ "${{ github.event.inputs.test_suite }}" = "e2e" ]; then
          echo "test-matrix=[\"e2e_tests\"]" >> $GITHUB_OUTPUT
        elif [ "${{ github.event.inputs.test_suite }}" = "simulation" ]; then
          echo "test-matrix=[\"simulation_tests\"]" >> $GITHUB_OUTPUT
        else
          echo "test-matrix=[\"unit_tests\",\"integration_tests\",\"e2e_tests\",\"simulation_tests\"]" >> $GITHUB_OUTPUT
        fi

  unit-tests:
    name: ğŸ§ª å–®å…ƒæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: test-setup
    if: contains(needs.test-setup.outputs.test-matrix, 'unit_tests')
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-html
    
    - name: ğŸ§ª é‹è¡Œå–®å…ƒæ¸¬è©¦
      run: |
        python -m pytest tests/unit_tests.py -v --html=reports/unit_test_report.html --self-contained-html
      continue-on-error: true
    
    - name: ğŸ“Š ä¸Šå‚³æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: unit-test-reports
        path: reports/
        retention-days: 30

  integration-tests:
    name: ğŸ”— é›†æˆæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: test-setup
    if: contains(needs.test-setup.outputs.test-matrix, 'integration_tests')
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ”— é‹è¡Œé›†æˆæ¸¬è©¦
      run: |
        python tests/integration_tests.py
      continue-on-error: true
    
    - name: ğŸ“Š ä¸Šå‚³æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-reports
        path: reports/
        retention-days: 30

  e2e-tests:
    name: ğŸ¯ ç«¯åˆ°ç«¯æ¸¬è©¦
    runs-on: ubuntu-latest
    needs: test-setup
    if: contains(needs.test-setup.outputs.test-matrix, 'e2e_tests')
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ¯ é‹è¡Œç«¯åˆ°ç«¯æ¸¬è©¦
      run: |
        python tests/e2e_tests.py
      continue-on-error: true
    
    - name: ğŸ“Š ä¸Šå‚³æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: e2e-test-reports
        path: reports/
        retention-days: 30

  simulation-tests:
    name: ğŸ® æ¨¡æ“¬äº¤æ˜“æ¸¬è©¦
    runs-on: ubuntu-latest
    needs: test-setup
    if: contains(needs.test-setup.outputs.test-matrix, 'simulation_tests')
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ® é‹è¡Œæ¨¡æ“¬äº¤æ˜“æ¸¬è©¦
      run: |
        python tests/simulation_tests.py
      continue-on-error: true
    
    - name: ğŸ“Š ä¸Šå‚³æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: simulation-test-reports
        path: reports/
        retention-days: 30

  comprehensive-test:
    name: ğŸ“‹ ç¶œåˆæ¸¬è©¦å ±å‘Š
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, simulation-tests]
    if: always()
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ“¥ ä¸‹è¼‰æ‰€æœ‰æ¸¬è©¦å ±å‘Š
      uses: actions/download-artifact@v3
      with:
        path: downloaded-reports/
    
    - name: ğŸ“‹ é‹è¡Œç¶œåˆæ¸¬è©¦
      run: |
        python run_all_tests.py
      continue-on-error: true
    
    - name: ğŸ“Š ç”Ÿæˆæœ€çµ‚å ±å‘Š
      run: |
        echo "## ğŸ§ª AImax æ¸¬è©¦å¥—ä»¶åŸ·è¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "reports/complete_test_report_*.json" ]; then
          echo "### ğŸ“Š æ¸¬è©¦æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          python -c "
import json, glob
files = glob.glob('reports/complete_test_report_*.json')
if files:
    with open(files[0], 'r', encoding='utf-8') as f:
        report = json.load(f)
    summary = report['summary']
    print(f'- ç¸½æ¸¬è©¦å¥—ä»¶: {summary[\"total_test_suites\"]}')
    print(f'- é€šéå¥—ä»¶: {summary[\"passed_suites\"]} âœ…')
    print(f'- å¤±æ•—å¥—ä»¶: {summary[\"failed_suites\"]} âŒ')
    print(f'- æˆåŠŸç‡: {summary[\"success_rate\"]:.1f}%')
    print(f'- ç¸½è€—æ™‚: {summary[\"total_duration\"]:.2f}ç§’')
    print(f'- æ•´é«”ç‹€æ…‹: {summary[\"overall_status\"]}')
" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ ç„¡æ³•æ‰¾åˆ°æ¸¬è©¦å ±å‘Šæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ğŸ“Š ä¸Šå‚³æœ€çµ‚å ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: comprehensive-test-reports
        path: reports/
        retention-days: 90
    
    - name: ğŸ“„ éƒ¨ç½²æ¸¬è©¦å ±å‘Šåˆ° GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./reports
        destination_dir: test-reports
        keep_files: true

  notify-results:
    name: ğŸ“¢ é€šçŸ¥æ¸¬è©¦çµæœ
    runs-on: ubuntu-latest
    needs: [comprehensive-test]
    if: always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ ä¸‹è¼‰æ¸¬è©¦å ±å‘Š
      uses: actions/download-artifact@v3
      with:
        name: comprehensive-test-reports
        path: reports/
    
    - name: ğŸ“¢ ç™¼é€ Telegram é€šçŸ¥
      if: ${{ secrets.TELEGRAM_BOT_TOKEN && secrets.TELEGRAM_CHAT_ID }}
      run: |
        if [ -f "reports/complete_test_report_*.json" ]; then
          python -c "
import json, glob, requests, os
files = glob.glob('reports/complete_test_report_*.json')
if files:
    with open(files[0], 'r', encoding='utf-8') as f:
        report = json.load(f)
    summary = report['summary']
    
    status_emoji = 'âœ…' if summary['overall_status'] == 'PASSED' else 'âŒ'
    message = f'''
{status_emoji} AImax è‡ªå‹•åŒ–æ¸¬è©¦å ±å‘Š
    
ğŸ“Š æ¸¬è©¦æ‘˜è¦:
â€¢ ç¸½æ¸¬è©¦å¥—ä»¶: {summary['total_test_suites']}
â€¢ é€šé: {summary['passed_suites']} âœ…
â€¢ å¤±æ•—: {summary['failed_suites']} âŒ
â€¢ æˆåŠŸç‡: {summary['success_rate']:.1f}%
â€¢ ç¸½è€—æ™‚: {summary['total_duration']:.2f}ç§’
â€¢ ç‹€æ…‹: {summary['overall_status']}

ğŸ”— æŸ¥çœ‹è©³ç´°å ±å‘Š: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    '''
    
    bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
    chat_id = os.environ.get('TELEGRAM_CHAT_ID')
    
    if bot_token and chat_id:
        url = f'https://api.telegram.org/bot{bot_token}/sendMessage'
        data = {'chat_id': chat_id, 'text': message, 'parse_mode': 'HTML'}
        requests.post(url, data=data)
"
        fi
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

  cleanup:
    name: ğŸ§¹ æ¸…ç†
    runs-on: ubuntu-latest
    needs: [notify-results]
    if: always()
    
    steps:
    - name: ğŸ§¹ æ¸…ç†å·¥ä½œç©ºé–“
      run: |
        echo "æ¸…ç†å®Œæˆ"
        df -h