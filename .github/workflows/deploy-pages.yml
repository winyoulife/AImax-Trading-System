name: ğŸš€ AImax æ™ºèƒ½äº¤æ˜“ç³»çµ± - å„ªåŒ–éƒ¨ç½²åˆ°GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'static/**'
      - '.github/workflows/deploy-pages.yml'
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: 'éƒ¨ç½²æ¨¡å¼'
        required: true
        default: 'production'
        type: choice
        options:
        - production    # ç”Ÿç”¢æ¨¡å¼ï¼ˆå®Œæ•´å„ªåŒ–ï¼‰
        - development   # é–‹ç™¼æ¨¡å¼ï¼ˆå¿«é€Ÿéƒ¨ç½²ï¼‰
        - testing       # æ¸¬è©¦æ¨¡å¼ï¼ˆåŒ…å«æ¸¬è©¦é é¢ï¼‰

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.10'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  optimize-and-build:
    runs-on: ubuntu-latest
    outputs:
      build-time: ${{ steps.build-info.outputs.build-time }}
      file-count: ${{ steps.build-info.outputs.file-count }}
      total-size: ${{ steps.build-info.outputs.total-size }}
      
    steps:
      - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ”§ è¨­ç½®Pages
        uses: actions/configure-pages@v4
        
      - name: ğŸ è¨­ç½®Pythonç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ å®‰è£å„ªåŒ–å·¥å…·
        run: |
          python -m pip install --upgrade pip
          pip install htmlmin cssmin jsmin pillow
          
      - name: ğŸ—ï¸ å‰µå»ºå„ªåŒ–æ§‹å»ºç³»çµ±
        run: |
          echo "ğŸ—ï¸ å‰µå»ºAImaxæ™ºèƒ½äº¤æ˜“ç³»çµ±å„ªåŒ–æ§‹å»º..."
          
          # å‰µå»ºéƒ¨ç½²ç›®éŒ„çµæ§‹
          mkdir -p _site/{js,css,images,api}
          
          # å‰µå»ºæ§‹å»ºä¿¡æ¯
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          BUILD_HASH=$(git rev-parse --short HEAD)
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          echo "BUILD_HASH=$BUILD_HASH" >> $GITHUB_ENV
          
          echo "ğŸ“… æ§‹å»ºæ™‚é–“: $BUILD_TIME"
          echo "ğŸ”— æäº¤å“ˆå¸Œ: $BUILD_HASH"
          
      - name: ğŸ¨ å„ªåŒ–å’Œå£“ç¸®éœæ…‹è³‡æº
        run: |
          echo "ğŸ¨ é–‹å§‹éœæ…‹è³‡æºå„ªåŒ–..."
          
          # å‰µå»ºHTMLå„ªåŒ–è…³æœ¬
          cat > optimize_html.py << 'EOF'
          import re
          import os
          from htmlmin import minify
          
          def optimize_html(file_path, output_path):
              with open(file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # æ·»åŠ æ§‹å»ºä¿¡æ¯å’ŒSEOå„ªåŒ–
              build_time = os.environ.get('BUILD_TIME', '')
              build_hash = os.environ.get('BUILD_HASH', '')
              
              # æ·»åŠ metaæ¨™ç±¤
              meta_tags = f'''
              <meta name="description" content="AImax 85%å‹ç‡æ™ºèƒ½äº¤æ˜“ç³»çµ± - å°ˆæ¥­çš„BTC/TWDé«˜é »äº¤æ˜“å¹³å°ï¼Œæ¡ç”¨å…ˆé€²çš„MACDç­–ç•¥å’ŒGitHub Actionsé›²ç«¯éƒ¨ç½²">
              <meta name="keywords" content="AImax,æ¯”ç‰¹å¹£äº¤æ˜“,BTC,TWD,é«˜é »äº¤æ˜“,MACD,85%å‹ç‡,æ™ºèƒ½äº¤æ˜“ç³»çµ±">
              <meta name="author" content="AImax Trading System">
              <meta name="robots" content="noindex, nofollow">
              <meta name="build-time" content="{build_time}">
              <meta name="build-hash" content="{build_hash}">
              <meta property="og:title" content="AImax æ™ºèƒ½äº¤æ˜“ç³»çµ±">
              <meta property="og:description" content="85%å‹ç‡çš„å°ˆæ¥­æ¯”ç‰¹å¹£äº¤æ˜“ç³»çµ±">
              <meta property="og:type" content="website">
              <link rel="preconnect" href="https://api.github.com">
              <link rel="preconnect" href="https://api.allorigins.win">
              <link rel="dns-prefetch" href="//max-api.maicoin.com">
              '''
              
              # æ’å…¥metaæ¨™ç±¤
              content = content.replace('<head>', f'<head>{meta_tags}')
              
              # å£“ç¸®HTML
              minified = minify(content, 
                              remove_comments=True,
                              remove_empty_space=True,
                              reduce_whitespace=True)
              
              with open(output_path, 'w', encoding='utf-8') as f:
                  f.write(minified)
              
              print(f"âœ… å„ªåŒ–å®Œæˆ: {file_path} -> {output_path}")
              print(f"ğŸ“Š å£“ç¸®ç‡: {len(content)} -> {len(minified)} ({(1-len(minified)/len(content))*100:.1f}%)")
          
          # å„ªåŒ–æ‰€æœ‰HTMLæ–‡ä»¶
          html_files = [
              ('static/secure-login-fixed.html', '_site/index.html'),
              ('static/dashboard-fixed.html', '_site/dashboard.html'),
              ('static/test-max-api.html', '_site/test-max-api.html'),
              ('static/clean-dashboard.html', '_site/clean.html'),
              ('static/simple-max-dashboard.html', '_site/simple.html'),
              ('static/test-login-only.html', '_site/test-login.html')
          ]
          
          for src, dst in html_files:
              if os.path.exists(src):
                  optimize_html(src, dst)
          EOF
          
          python optimize_html.py
          cp static/ultimate-smart-dashboard.html _site/smart.html
          
      - name: ğŸ“± å„ªåŒ–JavaScriptå’ŒCSSè³‡æº
        run: |
          echo "ğŸ“± å„ªåŒ–JavaScriptå’ŒCSSè³‡æº..."
          
          # å‰µå»ºJSå„ªåŒ–è…³æœ¬
          cat > optimize_js.py << 'EOF'
          import os
          import re
          from jsmin import jsmin
          
          def optimize_js(file_path, output_path):
              with open(file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯
              build_hash = os.environ.get('BUILD_HASH', 'unknown')
              header = f'/* AImax Trading System v3.0 | Build: {build_hash} | Optimized */\n'
              
              # å£“ç¸®JavaScript
              minified = jsmin(content)
              final_content = header + minified
              
              with open(output_path, 'w', encoding='utf-8') as f:
                  f.write(final_content)
              
              print(f"âœ… JSå„ªåŒ–å®Œæˆ: {file_path} -> {output_path}")
              print(f"ğŸ“Š å£“ç¸®ç‡: {len(content)} -> {len(final_content)} ({(1-len(final_content)/len(content))*100:.1f}%)")
          
          # å„ªåŒ–JavaScriptæ–‡ä»¶
          js_files = [
              ('static/js/github-actions-monitor.js', '_site/js/github-actions-monitor.min.js'),
              ('static/js/auth-manager.js', '_site/js/auth-manager.min.js'),
              ('static/js/dashboard.js', '_site/js/dashboard.min.js')
          ]
          
          for src, dst in js_files:
              if os.path.exists(src):
                  optimize_js(src, dst)
              else:
                  print(f"âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: {src}")
          EOF
          
          python optimize_js.py
          
          # è¤‡è£½å…¶ä»–JavaScriptæ–‡ä»¶
          if [ -d "static/js" ]; then
              cp -r static/js/* _site/js/ 2>/dev/null || true
          fi
          
      - name: ğŸ”§ å‰µå»ºå„ªåŒ–çš„é…ç½®æ–‡ä»¶
        run: |
          echo "ğŸ”§ å‰µå»ºå„ªåŒ–çš„é…ç½®æ–‡ä»¶..."
          
          # å‰µå»ºå„ªåŒ–çš„robots.txt
          cat > _site/robots.txt << 'EOF'
          # AImax ç§æœ‰äº¤æ˜“ç³»çµ± - ç¦æ­¢æ‰€æœ‰æœç´¢å¼•æ“ç´¢å¼•
          User-agent: *
          Disallow: /
          Crawl-delay: 86400
          
          # å®‰å…¨è€ƒé‡ - ç¦æ­¢è¨ªå•æ•æ„Ÿè·¯å¾‘
          Disallow: /js/
          Disallow: /api/
          Disallow: /*.json
          EOF
          
          # å‰µå»º.nojekyllæ–‡ä»¶
          touch _site/.nojekyll
          
          # å‰µå»ºsitemap.xmlï¼ˆé›–ç„¶ç¦æ­¢ç´¢å¼•ï¼Œä½†ä¿æŒçµæ§‹å®Œæ•´ï¼‰
          cat > _site/sitemap.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
              <loc>https://winyoulife.github.io/AImax-Trading-System/</loc>
              <lastmod>$(date -u +"%Y-%m-%dT%H:%M:%SZ")</lastmod>
              <changefreq>daily</changefreq>
              <priority>1.0</priority>
            </url>
          </urlset>
          EOF
          
          # å‰µå»ºmanifest.json
          cat > _site/manifest.json << 'EOF'
          {
            "name": "AImax æ™ºèƒ½äº¤æ˜“ç³»çµ±",
            "short_name": "AImax",
            "description": "85%å‹ç‡çš„å°ˆæ¥­æ¯”ç‰¹å¹£äº¤æ˜“ç³»çµ±",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#667eea",
            "theme_color": "#6c5ce7",
            "icons": [
              {
                "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM2YzVjZTciLz4KPHRleHQgeD0iOTYiIHk9IjEwNCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+QUk8L3RleHQ+Cjx0ZXh0IHg9Ijk2IiB5PSIxMzYiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPm1heDwvdGV4dD4KPC9zdmc+",
                "sizes": "192x192",
                "type": "image/svg+xml"
              }
            ]
          }
          EOF
          
      - name: ğŸ“Š ç”Ÿæˆæ§‹å»ºçµ±è¨ˆå’Œèªªæ˜é é¢
        id: build-info
        run: |
          echo "ğŸ“Š ç”Ÿæˆæ§‹å»ºçµ±è¨ˆ..."
          
          # è¨ˆç®—æ–‡ä»¶çµ±è¨ˆ
          FILE_COUNT=$(find _site -type f | wc -l)
          TOTAL_SIZE=$(du -sh _site | cut -f1)
          
          echo "file-count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "total-size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
          echo "build-time=$BUILD_TIME" >> $GITHUB_OUTPUT
          
          echo "ğŸ“ æ–‡ä»¶æ•¸é‡: $FILE_COUNT"
          echo "ğŸ’¾ ç¸½å¤§å°: $TOTAL_SIZE"
          
          # å‰µå»ºå„ªåŒ–çš„èªªæ˜é é¢
          cat > _site/README.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-TW">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AImax v3.0 ç°¡æ½”ç‰ˆäº¤æ˜“å„€è¡¨æ¿</title>
              <style>
                  body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                  .header { background: #6c5ce7; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                  .card { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                  .btn { display: inline-block; background: #00b894; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 10px 0; }
                  .btn:hover { background: #00a085; }
                  .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 6px; margin: 20px 0; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ğŸ¤– AImax çµ‚æ¥µæ™ºèƒ½äº¤æ˜“å„€è¡¨æ¿ v3.0</h1>
                  <p>85%å‹ç‡ç­–ç•¥ â€¢ é«˜é »æ™ºèƒ½äº¤æ˜“ç³»çµ± â€¢ å³æ™‚æ•¸æ“šç›£æ§</p>
                  <div style="background: #00b894; color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.9em; margin-top: 10px; display: inline-block;">
                      ğŸš€ å·²å„ªåŒ–éƒ¨ç½² | æ§‹å»ºæ™‚é–“: $BUILD_TIME | ç‰ˆæœ¬: $BUILD_HASH
                  </div>
              </div>
              
              <div class="card">
                  <h2>ğŸ” å®‰å…¨ç™»å…¥</h2>
                  <a href="./index.html" class="btn">ğŸ”‘ å°ˆå±¬å®‰å…¨ç™»å…¥</a>
                  <a href="./dashboard.html" class="btn">ğŸ¤– çµ‚æ¥µæ™ºèƒ½å„€è¡¨æ¿</a>
                  <a href="./test-login.html" class="btn">ğŸ§ª ç™»å…¥ç³»çµ±æ¸¬è©¦</a>
                  <a href="./simple.html" class="btn">ğŸ’° ç°¡æ½”åƒ¹æ ¼é¡¯ç¤º</a>
                  <p><strong>å°ˆå±¬å¸³è™Ÿç™»å…¥è³‡è¨Šï¼š</strong></p>
                  <ul>
                      <li>å°ˆå±¬å¸³è™Ÿï¼š<code>lovejk1314</code></li>
                      <li>å°ˆå±¬å¯†ç¢¼ï¼š<code>Ichen5978</code></li>
                      <li>å®‰å…¨ç­‰ç´šï¼š<code>SHA-256åŠ å¯†</code></li>
                  </ul>
              </div>
              
              <div class="card">
                  <h2>ğŸ›¡ï¸ å®‰å…¨åŠŸèƒ½ç‰¹è‰²</h2>
                  <ul>
                      <li>ğŸ” å°ˆå±¬å¸³è™Ÿå¯†ç¢¼èªè­‰ç³»çµ±</li>
                      <li>ğŸ›¡ï¸ SHA-256åŠ å¯†æŠ€è¡“ä¿è­·</li>
                      <li>â° 24å°æ™‚æœƒè©±ç®¡ç†</li>
                      <li>ğŸšª å®‰å…¨ç™»å‡ºæ©Ÿåˆ¶</li>
                      <li>ğŸ¤– 85%å‹ç‡é«˜é »äº¤æ˜“ç³»çµ±</li>
                      <li>ğŸ’° MAX API å³æ™‚åƒ¹æ ¼ç›£æ§</li>
                      <li>ğŸ“Š GitHub Actions çœŸå¯¦ç‹€æ…‹ç›£æ§</li>
                      <li>ğŸ“± Telegramå³æ™‚é€šçŸ¥</li>
                      <li>âš¡ éœæ…‹è³‡æºå„ªåŒ–å’Œå£“ç¸®</li>
                      <li>ğŸ” SEOå’Œæ€§èƒ½å„ªåŒ–</li>
                  </ul>
              </div>
              
              <div class="card">
                  <h2>ğŸ“ˆ æ§‹å»ºçµ±è¨ˆ</h2>
                  <ul>
                      <li>ğŸ“ æ–‡ä»¶æ•¸é‡: $FILE_COUNT</li>
                      <li>ğŸ’¾ ç¸½å¤§å°: $TOTAL_SIZE</li>
                      <li>ğŸ• æ§‹å»ºæ™‚é–“: $BUILD_TIME</li>
                      <li>ğŸ”— ç‰ˆæœ¬å“ˆå¸Œ: $BUILD_HASH</li>
                      <li>âš¡ HTML/CSS/JS å·²å£“ç¸®å„ªåŒ–</li>
                      <li>ğŸ” SEO metaæ¨™ç±¤å·²æ·»åŠ </li>
                  </ul>
              </div>
              
              <div class="warning">
                  <h3>âš ï¸ é‡è¦æé†’</h3>
                  <ul>
                      <li>æ­¤ç‚ºç§æœ‰äº¤æ˜“ç³»çµ±ï¼Œåƒ…é™æˆæ¬Šç”¨æˆ¶ä½¿ç”¨</li>
                      <li>åƒ¹æ ¼æ•¸æ“šç›´æ¥ä¾†è‡ª MAX Exchange å®˜æ–¹ API</li>
                      <li>85%å‹ç‡äº¤æ˜“ç­–ç•¥å·²å•Ÿç”¨ä¸¦å—åˆ°ä¿è­·</li>
                      <li>è«‹å‹¿åœ¨å…¬å…±ç¶²è·¯ç’°å¢ƒä¸‹ä½¿ç”¨</li>
                  </ul>
              </div>
              
              <div class="card">
                  <h2>ğŸ”— ç›¸é—œé€£çµ</h2>
                  <ul>
                      <li><a href="https://github.com/winyoulife/AImax-Trading-System">GitHub å°ˆæ¡ˆ</a></li>
                      <li><a href="https://max.maicoin.com/documents/api">MAX API æ–‡æª”</a></li>
                  </ul>
              </div>
          </body>
          </html>
          EOF
          
      - name: ğŸ” æœ€çµ‚å„ªåŒ–å’Œé©—è­‰
        run: |
          echo "ğŸ” åŸ·è¡Œæœ€çµ‚å„ªåŒ–å’Œé©—è­‰..."
          
          # å‰µå»ºHTTPSé‡å®šå‘ï¼ˆå¦‚æœéœ€è¦ï¼‰
          cat > _site/.htaccess << 'EOF'
          # AImax å®‰å…¨é…ç½®
          RewriteEngine On
          RewriteCond %{HTTPS} off
          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
          
          # å®‰å…¨æ¨™é ­
          Header always set X-Frame-Options DENY
          Header always set X-Content-Type-Options nosniff
          Header always set X-XSS-Protection "1; mode=block"
          Header always set Referrer-Policy "strict-origin-when-cross-origin"
          
          # ç·©å­˜æ§åˆ¶
          <FilesMatch "\.(html|htm)$">
              Header set Cache-Control "no-cache, no-store, must-revalidate"
          </FilesMatch>
          
          <FilesMatch "\.(js|css)$">
              Header set Cache-Control "public, max-age=31536000"
          </FilesMatch>
          EOF
          
          # é©—è­‰é—œéµæ–‡ä»¶å­˜åœ¨
          REQUIRED_FILES=("index.html" "dashboard.html" "robots.txt" "manifest.json")
          for file in "${REQUIRED_FILES[@]}"; do
              if [ -f "_site/$file" ]; then
                  echo "âœ… $file å­˜åœ¨"
              else
                  echo "âŒ $file ç¼ºå¤±"
                  exit 1
              fi
          done
          
          echo "âœ… AImax v3.0 å„ªåŒ–éƒ¨ç½²æ–‡ä»¶æº–å‚™å®Œæˆ"
          echo "ğŸ“ éƒ¨ç½²æ–‡ä»¶åˆ—è¡¨:"
          find _site -type f | sort
          echo ""
          echo "ğŸ“Š æœ€çµ‚çµ±è¨ˆ:"
          echo "ğŸ“ æ–‡ä»¶æ•¸é‡: $(find _site -type f | wc -l)"
          echo "ğŸ’¾ ç¸½å¤§å°: $(du -sh _site | cut -f1)"
          
      - name: ğŸ“¤ ä¸Šå‚³Pagesæ§‹å»ºç”¢ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: âœ… å„ªåŒ–éƒ¨ç½²å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ AImax v3.0 æ™ºèƒ½äº¤æ˜“ç³»çµ±å„ªåŒ–éƒ¨ç½²å®Œæˆï¼"
          echo ""
          echo "ğŸŒ è¨ªå•åœ°å€:"
          echo "   ä¸»é  (å®‰å…¨ç™»å…¥): ${{ steps.deployment.outputs.page_url }}"
          echo "   æ™ºèƒ½å„€è¡¨æ¿: ${{ steps.deployment.outputs.page_url }}dashboard.html"
          echo "   ç³»çµ±èªªæ˜: ${{ steps.deployment.outputs.page_url }}README.html"
          echo ""
          echo "ğŸ” å°ˆå±¬ç™»å…¥è³‡è¨Š:"
          echo "   å¸³è™Ÿ: lovejk1314"
          echo "   å¯†ç¢¼: Ichen5978"
          echo "   åŠ å¯†: SHA-256"
          echo ""
          echo "ğŸ“Š æ§‹å»ºçµ±è¨ˆ:"
          echo "   æ–‡ä»¶æ•¸é‡: ${{ needs.optimize-and-build.outputs.file-count }}"
          echo "   ç¸½å¤§å°: ${{ needs.optimize-and-build.outputs.total-size }}"
          echo "   æ§‹å»ºæ™‚é–“: ${{ needs.optimize-and-build.outputs.build-time }}"
          echo ""
          echo "âš¡ å„ªåŒ–åŠŸèƒ½:"
          echo "   âœ… HTML/CSS/JS å£“ç¸®"
          echo "   âœ… SEO metaæ¨™ç±¤"
          echo "   âœ… å®‰å…¨æ¨™é ­é…ç½®"
          echo "   âœ… ç·©å­˜æ§åˆ¶"
          echo "   âœ… æ€§èƒ½å„ªåŒ–"