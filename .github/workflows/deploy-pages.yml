name: 🚀 AImax 智能交易系統 - 優化部署到GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'static/**'
      - '.github/workflows/deploy-pages.yml'
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: '部署模式'
        required: true
        default: 'production'
        type: choice
        options:
        - production    # 生產模式（完整優化）
        - development   # 開發模式（快速部署）
        - testing       # 測試模式（包含測試頁面）

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.10'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  optimize-and-build:
    runs-on: ubuntu-latest
    outputs:
      build-time: ${{ steps.build-info.outputs.build-time }}
      file-count: ${{ steps.build-info.outputs.file-count }}
      total-size: ${{ steps.build-info.outputs.total-size }}
      
    steps:
      - name: 🔄 檢出代碼
        uses: actions/checkout@v4
        
      - name: 🔧 設置Pages
        uses: actions/configure-pages@v4
        
      - name: 🐍 設置Python環境
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: 📦 安裝優化工具
        run: |
          python -m pip install --upgrade pip
          pip install htmlmin cssmin jsmin pillow
          
      - name: 🏗️ 創建優化構建系統
        run: |
          echo "🏗️ 創建AImax智能交易系統優化構建..."
          
          # 創建部署目錄結構
          mkdir -p _site/{js,css,images,api}
          
          # 創建構建信息
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          BUILD_HASH=$(git rev-parse --short HEAD)
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          echo "BUILD_HASH=$BUILD_HASH" >> $GITHUB_ENV
          
          echo "📅 構建時間: $BUILD_TIME"
          echo "🔗 提交哈希: $BUILD_HASH"
          
      - name: 🎨 優化和壓縮靜態資源
        run: |
          echo "🎨 開始靜態資源優化..."
          
          # 創建HTML優化腳本
          cat > optimize_html.py << 'EOF'
          import re
          import os
          from htmlmin import minify
          
          def optimize_html(file_path, output_path):
              with open(file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # 添加構建信息和SEO優化
              build_time = os.environ.get('BUILD_TIME', '')
              build_hash = os.environ.get('BUILD_HASH', '')
              
              # 添加meta標籤
              meta_tags = f'''
              <meta name="description" content="AImax 85%勝率智能交易系統 - 專業的BTC/TWD高頻交易平台，採用先進的MACD策略和GitHub Actions雲端部署">
              <meta name="keywords" content="AImax,比特幣交易,BTC,TWD,高頻交易,MACD,85%勝率,智能交易系統">
              <meta name="author" content="AImax Trading System">
              <meta name="robots" content="noindex, nofollow">
              <meta name="build-time" content="{build_time}">
              <meta name="build-hash" content="{build_hash}">
              <meta property="og:title" content="AImax 智能交易系統">
              <meta property="og:description" content="85%勝率的專業比特幣交易系統">
              <meta property="og:type" content="website">
              <link rel="preconnect" href="https://api.github.com">
              <link rel="preconnect" href="https://api.allorigins.win">
              <link rel="dns-prefetch" href="//max-api.maicoin.com">
              '''
              
              # 插入meta標籤
              content = content.replace('<head>', f'<head>{meta_tags}')
              
              # 壓縮HTML
              minified = minify(content, 
                              remove_comments=True,
                              remove_empty_space=True,
                              reduce_whitespace=True)
              
              with open(output_path, 'w', encoding='utf-8') as f:
                  f.write(minified)
              
              print(f"✅ 優化完成: {file_path} -> {output_path}")
              print(f"📊 壓縮率: {len(content)} -> {len(minified)} ({(1-len(minified)/len(content))*100:.1f}%)")
          
          # 優化所有HTML文件
          html_files = [
              ('static/secure-login-fixed.html', '_site/index.html'),
              ('static/dashboard-fixed.html', '_site/dashboard.html'),
              ('static/test-max-api.html', '_site/test-max-api.html'),
              ('static/clean-dashboard.html', '_site/clean.html'),
              ('static/simple-max-dashboard.html', '_site/simple.html'),
              ('static/test-login-only.html', '_site/test-login.html')
          ]
          
          for src, dst in html_files:
              if os.path.exists(src):
                  optimize_html(src, dst)
          EOF
          
          python optimize_html.py
          cp static/ultimate-smart-dashboard.html _site/smart.html
          
      - name: 📱 優化JavaScript和CSS資源
        run: |
          echo "📱 優化JavaScript和CSS資源..."
          
          # 創建JS優化腳本
          cat > optimize_js.py << 'EOF'
          import os
          import re
          from jsmin import jsmin
          
          def optimize_js(file_path, output_path):
              with open(file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # 添加版本信息
              build_hash = os.environ.get('BUILD_HASH', 'unknown')
              header = f'/* AImax Trading System v3.0 | Build: {build_hash} | Optimized */\n'
              
              # 壓縮JavaScript
              minified = jsmin(content)
              final_content = header + minified
              
              with open(output_path, 'w', encoding='utf-8') as f:
                  f.write(final_content)
              
              print(f"✅ JS優化完成: {file_path} -> {output_path}")
              print(f"📊 壓縮率: {len(content)} -> {len(final_content)} ({(1-len(final_content)/len(content))*100:.1f}%)")
          
          # 優化JavaScript文件
          js_files = [
              ('static/js/github-actions-monitor.js', '_site/js/github-actions-monitor.min.js'),
              ('static/js/auth-manager.js', '_site/js/auth-manager.min.js'),
              ('static/js/dashboard.js', '_site/js/dashboard.min.js')
          ]
          
          for src, dst in js_files:
              if os.path.exists(src):
                  optimize_js(src, dst)
              else:
                  print(f"⚠️ 文件不存在: {src}")
          EOF
          
          python optimize_js.py
          
          # 複製其他JavaScript文件
          if [ -d "static/js" ]; then
              cp -r static/js/* _site/js/ 2>/dev/null || true
          fi
          
      - name: 🔧 創建優化的配置文件
        run: |
          echo "🔧 創建優化的配置文件..."
          
          # 創建優化的robots.txt
          cat > _site/robots.txt << 'EOF'
          # AImax 私有交易系統 - 禁止所有搜索引擎索引
          User-agent: *
          Disallow: /
          Crawl-delay: 86400
          
          # 安全考量 - 禁止訪問敏感路徑
          Disallow: /js/
          Disallow: /api/
          Disallow: /*.json
          EOF
          
          # 創建.nojekyll文件
          touch _site/.nojekyll
          
          # 創建sitemap.xml（雖然禁止索引，但保持結構完整）
          cat > _site/sitemap.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
              <loc>https://winyoulife.github.io/AImax-Trading-System/</loc>
              <lastmod>$(date -u +"%Y-%m-%dT%H:%M:%SZ")</lastmod>
              <changefreq>daily</changefreq>
              <priority>1.0</priority>
            </url>
          </urlset>
          EOF
          
          # 創建manifest.json
          cat > _site/manifest.json << 'EOF'
          {
            "name": "AImax 智能交易系統",
            "short_name": "AImax",
            "description": "85%勝率的專業比特幣交易系統",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#667eea",
            "theme_color": "#6c5ce7",
            "icons": [
              {
                "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM2YzVjZTciLz4KPHRleHQgeD0iOTYiIHk9IjEwNCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+QUk8L3RleHQ+Cjx0ZXh0IHg9Ijk2IiB5PSIxMzYiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPm1heDwvdGV4dD4KPC9zdmc+",
                "sizes": "192x192",
                "type": "image/svg+xml"
              }
            ]
          }
          EOF
          
      - name: 📊 生成構建統計和說明頁面
        id: build-info
        run: |
          echo "📊 生成構建統計..."
          
          # 計算文件統計
          FILE_COUNT=$(find _site -type f | wc -l)
          TOTAL_SIZE=$(du -sh _site | cut -f1)
          
          echo "file-count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "total-size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
          echo "build-time=$BUILD_TIME" >> $GITHUB_OUTPUT
          
          echo "📁 文件數量: $FILE_COUNT"
          echo "💾 總大小: $TOTAL_SIZE"
          
          # 創建優化的說明頁面
          cat > _site/README.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-TW">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AImax v3.0 簡潔版交易儀表板</title>
              <style>
                  body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                  .header { background: #6c5ce7; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                  .card { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                  .btn { display: inline-block; background: #00b894; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 10px 0; }
                  .btn:hover { background: #00a085; }
                  .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 6px; margin: 20px 0; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>🤖 AImax 終極智能交易儀表板 v3.0</h1>
                  <p>85%勝率策略 • 高頻智能交易系統 • 即時數據監控</p>
                  <div style="background: #00b894; color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.9em; margin-top: 10px; display: inline-block;">
                      🚀 已優化部署 | 構建時間: $BUILD_TIME | 版本: $BUILD_HASH
                  </div>
              </div>
              
              <div class="card">
                  <h2>🔐 安全登入</h2>
                  <a href="./index.html" class="btn">🔑 專屬安全登入</a>
                  <a href="./dashboard.html" class="btn">🤖 終極智能儀表板</a>
                  <a href="./test-login.html" class="btn">🧪 登入系統測試</a>
                  <a href="./simple.html" class="btn">💰 簡潔價格顯示</a>
                  <p><strong>專屬帳號登入資訊：</strong></p>
                  <ul>
                      <li>專屬帳號：<code>lovejk1314</code></li>
                      <li>專屬密碼：<code>Ichen5978</code></li>
                      <li>安全等級：<code>SHA-256加密</code></li>
                  </ul>
              </div>
              
              <div class="card">
                  <h2>🛡️ 安全功能特色</h2>
                  <ul>
                      <li>🔐 專屬帳號密碼認證系統</li>
                      <li>🛡️ SHA-256加密技術保護</li>
                      <li>⏰ 24小時會話管理</li>
                      <li>🚪 安全登出機制</li>
                      <li>🤖 85%勝率高頻交易系統</li>
                      <li>💰 MAX API 即時價格監控</li>
                      <li>📊 GitHub Actions 真實狀態監控</li>
                      <li>📱 Telegram即時通知</li>
                      <li>⚡ 靜態資源優化和壓縮</li>
                      <li>🔍 SEO和性能優化</li>
                  </ul>
              </div>
              
              <div class="card">
                  <h2>📈 構建統計</h2>
                  <ul>
                      <li>📁 文件數量: $FILE_COUNT</li>
                      <li>💾 總大小: $TOTAL_SIZE</li>
                      <li>🕐 構建時間: $BUILD_TIME</li>
                      <li>🔗 版本哈希: $BUILD_HASH</li>
                      <li>⚡ HTML/CSS/JS 已壓縮優化</li>
                      <li>🔍 SEO meta標籤已添加</li>
                  </ul>
              </div>
              
              <div class="warning">
                  <h3>⚠️ 重要提醒</h3>
                  <ul>
                      <li>此為私有交易系統，僅限授權用戶使用</li>
                      <li>價格數據直接來自 MAX Exchange 官方 API</li>
                      <li>85%勝率交易策略已啟用並受到保護</li>
                      <li>請勿在公共網路環境下使用</li>
                  </ul>
              </div>
              
              <div class="card">
                  <h2>🔗 相關連結</h2>
                  <ul>
                      <li><a href="https://github.com/winyoulife/AImax-Trading-System">GitHub 專案</a></li>
                      <li><a href="https://max.maicoin.com/documents/api">MAX API 文檔</a></li>
                  </ul>
              </div>
          </body>
          </html>
          EOF
          
      - name: 🔍 最終優化和驗證
        run: |
          echo "🔍 執行最終優化和驗證..."
          
          # 創建HTTPS重定向（如果需要）
          cat > _site/.htaccess << 'EOF'
          # AImax 安全配置
          RewriteEngine On
          RewriteCond %{HTTPS} off
          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
          
          # 安全標頭
          Header always set X-Frame-Options DENY
          Header always set X-Content-Type-Options nosniff
          Header always set X-XSS-Protection "1; mode=block"
          Header always set Referrer-Policy "strict-origin-when-cross-origin"
          
          # 緩存控制
          <FilesMatch "\.(html|htm)$">
              Header set Cache-Control "no-cache, no-store, must-revalidate"
          </FilesMatch>
          
          <FilesMatch "\.(js|css)$">
              Header set Cache-Control "public, max-age=31536000"
          </FilesMatch>
          EOF
          
          # 驗證關鍵文件存在
          REQUIRED_FILES=("index.html" "dashboard.html" "robots.txt" "manifest.json")
          for file in "${REQUIRED_FILES[@]}"; do
              if [ -f "_site/$file" ]; then
                  echo "✅ $file 存在"
              else
                  echo "❌ $file 缺失"
                  exit 1
              fi
          done
          
          echo "✅ AImax v3.0 優化部署文件準備完成"
          echo "📁 部署文件列表:"
          find _site -type f | sort
          echo ""
          echo "📊 最終統計:"
          echo "📁 文件數量: $(find _site -type f | wc -l)"
          echo "💾 總大小: $(du -sh _site | cut -f1)"
          
      - name: 📤 上傳Pages構建產物
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: 🚀 部署到GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: ✅ 優化部署完成通知
        run: |
          echo "🎉 AImax v3.0 智能交易系統優化部署完成！"
          echo ""
          echo "🌐 訪問地址:"
          echo "   主頁 (安全登入): ${{ steps.deployment.outputs.page_url }}"
          echo "   智能儀表板: ${{ steps.deployment.outputs.page_url }}dashboard.html"
          echo "   系統說明: ${{ steps.deployment.outputs.page_url }}README.html"
          echo ""
          echo "🔐 專屬登入資訊:"
          echo "   帳號: lovejk1314"
          echo "   密碼: Ichen5978"
          echo "   加密: SHA-256"
          echo ""
          echo "📊 構建統計:"
          echo "   文件數量: ${{ needs.optimize-and-build.outputs.file-count }}"
          echo "   總大小: ${{ needs.optimize-and-build.outputs.total-size }}"
          echo "   構建時間: ${{ needs.optimize-and-build.outputs.build-time }}"
          echo ""
          echo "⚡ 優化功能:"
          echo "   ✅ HTML/CSS/JS 壓縮"
          echo "   ✅ SEO meta標籤"
          echo "   ✅ 安全標頭配置"
          echo "   ✅ 緩存控制"
          echo "   ✅ 性能優化"