name: ç²å– MAX API æ•¸æ“šä¸¦éƒ¨ç½²

on:
  schedule:
    # æ¯5åˆ†é˜åŸ·è¡Œä¸€æ¬¡
    - cron: '*/5 * * * *'
  workflow_dispatch:
    # å…è¨±æ‰‹å‹•è§¸ç™¼
  push:
    branches: [ main ]
    paths:
      - 'scripts/fetch_max_data.py'
      - '.github/workflows/fetch-max-api.yml'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "max-api-fetch"
  cancel-in-progress: true

jobs:
  fetch-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: ğŸ“¦ å®‰è£ Python ä¾è³´
        run: |
          echo "ğŸ“¦ å®‰è£ Python ä¾è³´..."
          pip install -r requirements-github-actions.txt
          
      - name: ğŸ“¡ ç²å– MAX API æ•¸æ“š
        run: |
          echo "ğŸ“¡ é–‹å§‹ç²å– MAX API æ•¸æ“š..."
          python scripts/fetch_max_data.py
          
          # æª¢æŸ¥æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          if [ -f "static/api/btc-price.json" ]; then
            echo "âœ… æ•¸æ“šæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(du -h static/api/btc-price.json | cut -f1)"
            echo "ğŸ” æ•¸æ“šé è¦½:"
            head -20 static/api/btc-price.json
          else
            echo "âŒ æ•¸æ“šæ–‡ä»¶ç”Ÿæˆå¤±æ•—"
            exit 1
          fi
          
      - name: ğŸ“ æ›´æ–°æ™‚é–“æˆ³æ–‡ä»¶
        run: |
          echo "ğŸ“ æ›´æ–°éƒ¨ç½²æ™‚é–“æˆ³..."
          mkdir -p static/api
          echo "{\"last_deployment\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\", \"commit_sha\": \"${{ github.sha }}\", \"run_id\": \"${{ github.run_id }}\"}" > static/api/deployment-info.json
          
      - name: ğŸ”§ è¨­ç½® Git é…ç½®
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
      - name: ğŸ’¾ æäº¤æ•¸æ“šæ›´æ–°
        run: |
          echo "ğŸ’¾ æª¢æŸ¥æ˜¯å¦æœ‰æ•¸æ“šæ›´æ–°..."
          
          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if git diff --quiet static/api/; then
            echo "ğŸ“Š æ•¸æ“šæ²’æœ‰è®ŠåŒ–ï¼Œè·³éæäº¤"
          else
            echo "ğŸ“Š æª¢æ¸¬åˆ°æ•¸æ“šè®ŠåŒ–ï¼Œæº–å‚™æäº¤..."
            git add static/api/
            
            # å¾ JSON æ–‡ä»¶ä¸­æå–åƒ¹æ ¼ä¿¡æ¯ç”¨æ–¼æäº¤ä¿¡æ¯
            PRICE=$(python -c "import json; data=json.load(open('static/api/btc-price.json')); print(data['data']['formatted_price'])")
            TIMESTAMP=$(python -c "import json; data=json.load(open('static/api/btc-price.json')); print(data['data']['timestamp'][:19])")
            
            git commit -m "ğŸ“Š æ›´æ–° BTC/TWD åƒ¹æ ¼æ•¸æ“š: ${PRICE}
            
            ğŸ• æ›´æ–°æ™‚é–“: ${TIMESTAMP}
            ğŸ¤– è‡ªå‹•æ›´æ–° via GitHub Actions
            ğŸ“ˆ æ•¸æ“šä¾†æº: MAX API v2
            ğŸ”„ é‹è¡Œ ID: ${{ github.run_id }}"
            
            echo "âœ… æ•¸æ“šæ›´æ–°å·²æäº¤"
          fi
          
      - name: ğŸš€ æ¨é€æ›´æ–°
        run: |
          echo "ğŸš€ æ¨é€æ•¸æ“šæ›´æ–°åˆ°å€‰åº«..."
          git push origin main || echo "âš ï¸ æ²’æœ‰æ–°çš„æäº¤éœ€è¦æ¨é€"
          
      - name: ğŸ“¤ æº–å‚™ Pages éƒ¨ç½²
        run: |
          echo "ğŸ“¤ æº–å‚™ GitHub Pages éƒ¨ç½²æ–‡ä»¶..."
          
          # å‰µå»ºéƒ¨ç½²ç›®éŒ„
          mkdir -p _site
          
          # è¤‡è£½éœæ…‹æ–‡ä»¶
          cp -r static/* _site/
          
          # å‰µå»º API ç´¢å¼•é é¢
          cat > _site/api/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-TW">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AImax API ç«¯é»</title>
              <style>
                  body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                  .endpoint { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; }
                  .url { font-family: monospace; background: #e9ecef; padding: 5px; border-radius: 4px; }
                  pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
              </style>
          </head>
          <body>
              <h1>ğŸ¤– AImax API ç«¯é»</h1>
              
              <div class="endpoint">
                  <h3>ğŸ’° BTC/TWD å³æ™‚åƒ¹æ ¼</h3>
                  <p><strong>ç«¯é»ï¼š</strong> <span class="url">GET /api/btc-price.json</span></p>
                  <p><strong>æè¿°ï¼š</strong> ç²å– MAX Exchange BTC/TWD å³æ™‚åƒ¹æ ¼æ•¸æ“š</p>
                  <p><strong>æ›´æ–°é »ç‡ï¼š</strong> æ¯ 5 åˆ†é˜</p>
                  <p><strong>æ•¸æ“šä¾†æºï¼š</strong> MAX API v2</p>
                  <a href="btc-price.json" target="_blank">ğŸ“Š æŸ¥çœ‹ç•¶å‰æ•¸æ“š</a>
              </div>
              
              <div class="endpoint">
                  <h3>ğŸ“‹ éƒ¨ç½²ä¿¡æ¯</h3>
                  <p><strong>ç«¯é»ï¼š</strong> <span class="url">GET /api/deployment-info.json</span></p>
                  <p><strong>æè¿°ï¼š</strong> ç²å–æœ€å¾Œéƒ¨ç½²æ™‚é–“å’Œç‰ˆæœ¬ä¿¡æ¯</p>
                  <a href="deployment-info.json" target="_blank">ğŸ” æŸ¥çœ‹éƒ¨ç½²ä¿¡æ¯</a>
              </div>
              
              <h2>ğŸ“– ä½¿ç”¨ç¤ºä¾‹</h2>
              <pre><code>// JavaScript ç¤ºä¾‹
fetch('https://winyoulife.github.io/AImax-Trading-System/api/btc-price.json')
  .then(response => response.json())
  .then(data => {
    console.log('BTC/TWD åƒ¹æ ¼:', data.data.formatted_price);
    console.log('æ›´æ–°æ™‚é–“:', data.data.timestamp);
  });</code></pre>
          </body>
          </html>
          EOF
          
          # å‰µå»º robots.txt
          echo "User-agent: *" > _site/robots.txt
          echo "Disallow: /" >> _site/robots.txt
          
          # å‰µå»º .nojekyll
          touch _site/.nojekyll
          
          echo "âœ… Pages éƒ¨ç½²æ–‡ä»¶æº–å‚™å®Œæˆ"
          echo "ğŸ“ éƒ¨ç½²æ–‡ä»¶åˆ—è¡¨:"
          find _site -type f | head -20
          
      - name: ğŸ”§ è¨­ç½® Pages
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¤ ä¸Šå‚³ Pages æ§‹å»ºç”¢ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
          
      - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: âœ… éƒ¨ç½²å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ MAX API æ•¸æ“šç²å–å’Œéƒ¨ç½²å®Œæˆï¼"
          echo "ğŸŒ API ç«¯é»: ${{ steps.deployment.outputs.page_url }}api/btc-price.json"
          echo "ğŸ“Š API æ–‡æª”: ${{ steps.deployment.outputs.page_url }}api/"
          
          # é©—è­‰éƒ¨ç½²
          if [ -f "static/api/btc-price.json" ]; then
            PRICE=$(python -c "import json; data=json.load(open('static/api/btc-price.json')); print(data['data']['formatted_price'])")
            echo "ğŸ’° ç•¶å‰ BTC/TWD åƒ¹æ ¼: ${PRICE}"
          fi
          
      - name: ğŸ” éƒ¨ç½²å¾Œé©—è­‰
        run: |
          echo "ğŸ” ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆä¸¦é€²è¡Œé©—è­‰..."
          sleep 30
          
          # å˜—è©¦è¨ªå•éƒ¨ç½²çš„ API
          API_URL="${{ steps.deployment.outputs.page_url }}api/btc-price.json"
          echo "ğŸ“¡ æ¸¬è©¦ API ç«¯é»: ${API_URL}"
          
          # ä½¿ç”¨ curl æ¸¬è©¦ï¼ˆå¦‚æœå¤±æ•—ä¸ä¸­æ–·å·¥ä½œæµï¼‰
          curl -f -s "${API_URL}" > /dev/null && echo "âœ… API ç«¯é»å¯è¨ªå•" || echo "âš ï¸ API ç«¯é»æš«æ™‚ä¸å¯è¨ªå•ï¼ˆå¯èƒ½éœ€è¦æ›´å¤šæ™‚é–“ç”Ÿæ•ˆï¼‰"