name: AImax ç³»çµ±ä¿æ´»æ©Ÿåˆ¶ - é˜²æ­¢é›²ç«¯ä¼‘çœ 

on:
  schedule:
    # æ¯10åˆ†é˜åŸ·è¡Œä¸€æ¬¡ä¿æ´»æª¢æŸ¥
    - cron: '*/10 * * * *'
  workflow_dispatch:
    inputs:
      wake_up_mode:
        description: 'å–šé†’æ¨¡å¼'
        required: true
        default: 'gentle'
        type: choice
        options:
        - gentle      # æº«å’Œæ¨¡å¼
        - aggressive  # ç©æ¥µæ¨¡å¼
        - emergency   # ç·Šæ€¥æ¨¡å¼

env:
  KEEP_ALIVE_MODE: active
  PYTHON_VERSION: '3.10'
  
jobs:
  keep-alive-check:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­ç½®Pythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install requests pytz
        
    - name: ğŸ’“ ç³»çµ±ä¿æ´»æª¢æŸ¥
      id: keep_alive
      run: |
        echo "ğŸ’“ åŸ·è¡ŒAImaxç³»çµ±ä¿æ´»æª¢æŸ¥..."
        python -c "
        import json
        import os
        import requests
        from datetime import datetime, timedelta
        import pytz
        
        def keep_alive_check():
            taipei_tz = pytz.timezone('Asia/Taipei')
            now_taipei = datetime.now(taipei_tz)
            
            keep_alive_result = {
                'timestamp': datetime.now().isoformat(),
                'taipei_time': now_taipei.isoformat(),
                'system_status': 'active',
                'last_activity': None,
                'needs_wake_up': False,
                'wake_up_reason': '',
                'btc_price_check': False,
                'github_actions_active': True
            }
            
            print(f'ğŸ’“ ç³»çµ±ä¿æ´»æª¢æŸ¥ - {now_taipei.strftime(\"%H:%M:%S\")}')
            
            # æª¢æŸ¥æœ€å¾Œæ´»å‹•æ™‚é–“
            if os.path.exists('data/monitoring/frequency_control.json'):
                with open('data/monitoring/frequency_control.json', 'r') as f:
                    last_control = json.load(f)
                    last_activity = datetime.fromisoformat(last_control['timestamp'])
                    time_since_activity = (datetime.now() - last_activity).total_seconds()
                    
                    keep_alive_result['last_activity'] = last_control['timestamp']
                    
                    # å¦‚æœè¶…é30åˆ†é˜æ²’æœ‰æ´»å‹•ï¼Œéœ€è¦å–šé†’
                    if time_since_activity > 1800:  # 30åˆ†é˜
                        keep_alive_result['needs_wake_up'] = True
                        keep_alive_result['wake_up_reason'] = f'ç³»çµ±é–’ç½®{time_since_activity/60:.0f}åˆ†é˜'
                        print(f'âš ï¸ ç³»çµ±é–’ç½®{time_since_activity/60:.0f}åˆ†é˜ï¼Œéœ€è¦å–šé†’')
                    else:
                        print(f'âœ… ç³»çµ±æ´»èºï¼Œæœ€å¾Œæ´»å‹•: {time_since_activity/60:.1f}åˆ†é˜å‰')
            else:
                keep_alive_result['needs_wake_up'] = True
                keep_alive_result['wake_up_reason'] = 'æ‰¾ä¸åˆ°æ´»å‹•è¨˜éŒ„'
                print('âš ï¸ æ‰¾ä¸åˆ°ç³»çµ±æ´»å‹•è¨˜éŒ„ï¼ŒåŸ·è¡Œå–šé†’')
            
            # åŸ·è¡ŒBTCåƒ¹æ ¼æª¢æŸ¥ï¼ˆä¿æŒAPIæ´»èºï¼‰
            try:
                print('ğŸ“¡ åŸ·è¡ŒBTCåƒ¹æ ¼æª¢æŸ¥...')
                response = requests.get('https://max-api.maicoin.com/api/v2/tickers/btctwd', timeout=5)
                if response.status_code == 200:
                    data = response.json()
                    btc_price = float(data.get('last', 0))
                    keep_alive_result['btc_price_check'] = True
                    keep_alive_result['current_btc_price'] = btc_price
                    print(f'ğŸ’° BTCåƒ¹æ ¼æª¢æŸ¥æˆåŠŸ: NT\${btc_price:,.0f}')
                    
                    # ä¿å­˜åƒ¹æ ¼æ•¸æ“šï¼ˆä¿æŒæ–‡ä»¶ç³»çµ±æ´»èºï¼‰
                    os.makedirs('data/keep_alive', exist_ok=True)
                    price_data = {
                        'price': btc_price,
                        'timestamp': datetime.now().isoformat(),
                        'check_type': 'keep_alive'
                    }
                    with open('data/keep_alive/latest_price.json', 'w') as f:
                        json.dump(price_data, f)
                else:
                    print(f'âš ï¸ BTCåƒ¹æ ¼æª¢æŸ¥å¤±æ•—: {response.status_code}')
            except Exception as e:
                print(f'âŒ BTCåƒ¹æ ¼æª¢æŸ¥éŒ¯èª¤: {str(e)}')
            
            # æª¢æŸ¥GitHub ActionsåŸ·è¡Œç‹€æ…‹
            try:
                # æª¢æŸ¥æœ€è¿‘çš„å·¥ä½œæµåŸ·è¡Œ
                if os.path.exists('data/monitoring/daily_executions_' + now_taipei.strftime('%Y-%m-%d') + '.json'):
                    with open('data/monitoring/daily_executions_' + now_taipei.strftime('%Y-%m-%d') + '.json', 'r') as f:
                        daily_data = json.load(f)
                        executions_today = daily_data.get('count', 0)
                        
                        if executions_today == 0:
                            keep_alive_result['needs_wake_up'] = True
                            keep_alive_result['wake_up_reason'] = 'ä»Šæ—¥ç„¡äº¤æ˜“åŸ·è¡Œè¨˜éŒ„'
                            print('âš ï¸ ä»Šæ—¥ç„¡äº¤æ˜“åŸ·è¡Œè¨˜éŒ„ï¼Œéœ€è¦å–šé†’ç³»çµ±')
                        else:
                            print(f'âœ… ä»Šæ—¥å·²åŸ·è¡Œ{executions_today}æ¬¡äº¤æ˜“æª¢æŸ¥')
            except Exception as e:
                print(f'â“ åŸ·è¡Œç‹€æ…‹æª¢æŸ¥å¤±æ•—: {str(e)}')
            
            return keep_alive_result
        
        # åŸ·è¡Œä¿æ´»æª¢æŸ¥
        result = keep_alive_check()
        
        # ä¿å­˜ä¿æ´»è¨˜éŒ„
        os.makedirs('data/keep_alive', exist_ok=True)
        with open('data/keep_alive/keep_alive_log.json', 'w') as f:
            json.dump(result, f, indent=2)
        
        print(f'ğŸ’“ ä¿æ´»æª¢æŸ¥å®Œæˆ')
        print(f'ğŸ”‹ ç³»çµ±ç‹€æ…‹: {result[\"system_status\"]}')
        print(f'âš¡ éœ€è¦å–šé†’: {\"æ˜¯\" if result[\"needs_wake_up\"] else \"å¦\"}')
        
        if result['needs_wake_up']:
            print(f'ğŸš¨ å–šé†’åŸå› : {result[\"wake_up_reason\"]}')
        
        # è¨­ç½®GitHub Actionsè¼¸å‡º
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f'needs_wake_up={str(result[\"needs_wake_up\"]).lower()}\\n')
            f.write(f'system_status={result[\"system_status\"]}\\n')
        "
        
    - name: ğŸš¨ ç³»çµ±å–šé†’æ“ä½œ
      if: steps.keep_alive.outputs.needs_wake_up == 'true'
      run: |
        echo "ğŸš¨ åŸ·è¡Œç³»çµ±å–šé†’æ“ä½œ..."
        
        # è§¸ç™¼é«˜é »äº¤æ˜“å·¥ä½œæµ
        echo "ğŸ”„ å˜—è©¦è§¸ç™¼é«˜é »äº¤æ˜“å·¥ä½œæµ..."
        
        # å‰µå»ºå–šé†’æ¨™è¨˜æ–‡ä»¶
        mkdir -p data/keep_alive
        python -c "
        import json
        from datetime import datetime
        
        wake_up_record = {
            'timestamp': datetime.now().isoformat(),
            'action': 'system_wake_up',
            'trigger': 'keep_alive_mechanism',
            'status': 'executed'
        }
        
        with open('data/keep_alive/wake_up_record.json', 'w') as f:
            json.dump(wake_up_record, f, indent=2)
        
        print('ğŸš¨ ç³»çµ±å–šé†’è¨˜éŒ„å·²å‰µå»º')
        "
        
        # åŸ·è¡Œä¸€æ¬¡å¿«é€Ÿçš„BTCåƒ¹æ ¼ç²å–ï¼ˆä¿æŒç³»çµ±æ´»èºï¼‰
        echo "ğŸ’° åŸ·è¡Œå¿«é€ŸBTCåƒ¹æ ¼æ›´æ–°..."
        python -c "
        import requests
        import json
        import os
        from datetime import datetime
        
        try:
            response = requests.get('https://max-api.maicoin.com/api/v2/tickers/btctwd', timeout=5)
            if response.status_code == 200:
                data = response.json()
                btc_price = float(data.get('last', 0))
                
                # å¼·åˆ¶æ›´æ–°åƒ¹æ ¼æ–‡ä»¶
                os.makedirs('data/monitoring', exist_ok=True)
                with open('data/monitoring/last_price.json', 'w') as f:
                    json.dump({
                        'price': btc_price, 
                        'timestamp': datetime.now().isoformat(),
                        'source': 'keep_alive_wake_up'
                    }, f)
                
                print(f'ğŸ’° å–šé†’åƒ¹æ ¼æ›´æ–°æˆåŠŸ: NT\${btc_price:,.0f}')
            else:
                print(f'âš ï¸ å–šé†’åƒ¹æ ¼æ›´æ–°å¤±æ•—: {response.status_code}')
        except Exception as e:
            print(f'âŒ å–šé†’åƒ¹æ ¼æ›´æ–°éŒ¯èª¤: {str(e)}')
        "
        
    - name: ğŸ“Š ä¿æ´»çµ±è¨ˆæ›´æ–°
      run: |
        echo "ğŸ“Š æ›´æ–°ä¿æ´»çµ±è¨ˆ..."
        python -c "
        import json
        import os
        from datetime import datetime
        
        # æ›´æ–°ä¿æ´»çµ±è¨ˆ
        today = datetime.now().strftime('%Y-%m-%d')
        stats_file = f'data/keep_alive/daily_keep_alive_{today}.json'
        
        if os.path.exists(stats_file):
            with open(stats_file, 'r') as f:
                stats = json.load(f)
        else:
            stats = {
                'date': today,
                'keep_alive_checks': 0,
                'wake_up_actions': 0,
                'last_check': None,
                'system_uptime_checks': 0
            }
        
        stats['keep_alive_checks'] += 1
        stats['system_uptime_checks'] += 1
        stats['last_check'] = datetime.now().isoformat()
        
        # å¦‚æœåŸ·è¡Œäº†å–šé†’æ“ä½œ
        if '${{ steps.keep_alive.outputs.needs_wake_up }}' == 'true':
            stats['wake_up_actions'] += 1
        
        with open(stats_file, 'w') as f:
            json.dump(stats, f, indent=2)
        
        print(f'ğŸ“ˆ ä»Šæ—¥ä¿æ´»æª¢æŸ¥: {stats[\"keep_alive_checks\"]}æ¬¡')
        print(f'ğŸš¨ ä»Šæ—¥å–šé†’æ“ä½œ: {stats[\"wake_up_actions\"]}æ¬¡')
        "
        
    - name: ğŸ“¤ ä¿å­˜ä¿æ´»æ•¸æ“š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: keep-alive-data-${{ github.run_number }}
        path: data/keep_alive/
        retention-days: 3