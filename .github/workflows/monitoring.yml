name: AImax ç³»çµ±ç›£æ§å’Œå¥åº·æª¢æŸ¥

on:
  schedule:
    # æ¯5åˆ†é˜åŸ·è¡Œå¥åº·æª¢æŸ¥
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æª¢æŸ¥é¡å‹'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - quick

env:
  MONITORING_MODE: active
  PYTHON_VERSION: '3.10'
  
jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­ç½®Pythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy
        
    - name: ğŸ” åŸ·è¡Œç³»çµ±å¥åº·æª¢æŸ¥
      id: health_check
      run: |
        echo "ğŸ” åŸ·è¡ŒAImaxç³»çµ±å¥åº·æª¢æŸ¥..."
        python -c "
        import json
        import os
        import requests
        from datetime import datetime
        
        def check_system_health():
            health_status = {
                'timestamp': datetime.now().isoformat(),
                'overall_status': 'healthy',
                'checks': {},
                'issues': [],
                'btc_price': 0
            }
            
            print('ğŸ” é–‹å§‹ç³»çµ±å¥åº·æª¢æŸ¥...')
            
            # æª¢æŸ¥MAX APIé€£æ¥æ€§
            try:
                print('ğŸ“¡ æª¢æŸ¥MAX APIé€£æ¥æ€§...')
                response = requests.get('https://max-api.maicoin.com/api/v2/tickers/btctwd', timeout=10)
                if response.status_code == 200:
                    health_status['checks']['max_api'] = 'healthy'
                    data = response.json()
                    health_status['btc_price'] = float(data.get('last', 0))
                    print(f'âœ… MAX APIæ­£å¸¸ï¼ŒBTCåƒ¹æ ¼: NT\${health_status[\"btc_price\"]:,.0f}')
                else:
                    health_status['checks']['max_api'] = 'warning'
                    health_status['issues'].append(f'MAX APIå›æ‡‰ç•°å¸¸: {response.status_code}')
            except Exception as e:
                health_status['checks']['max_api'] = 'error'
                health_status['issues'].append(f'MAX APIé€£æ¥å¤±æ•—: {str(e)}')
            
            # æª¢æŸ¥ç£ç›¤ä½¿ç”¨
            try:
                import shutil
                total, used, free = shutil.disk_usage('.')
                disk_usage_percent = (used / total) * 100
                
                if disk_usage_percent > 90:
                    health_status['checks']['disk_usage'] = 'warning'
                    health_status['issues'].append(f'ç£ç›¤ä½¿ç”¨ç‡è¼ƒé«˜: {disk_usage_percent:.1f}%')
                else:
                    health_status['checks']['disk_usage'] = 'healthy'
                    
                print(f'ğŸ’¾ ç£ç›¤ä½¿ç”¨ç‡: {disk_usage_percent:.1f}%')
            except Exception as e:
                health_status['checks']['disk_usage'] = 'unknown'
            
            # ç¶œåˆè©•ä¼°
            error_count = sum(1 for check in health_status['checks'].values() if check == 'error')
            warning_count = sum(1 for check in health_status['checks'].values() if check == 'warning')
            
            if error_count > 0:
                health_status['overall_status'] = 'critical'
            elif warning_count > 0:
                health_status['overall_status'] = 'warning'
            else:
                health_status['overall_status'] = 'healthy'
            
            return health_status
        
        # åŸ·è¡Œå¥åº·æª¢æŸ¥
        health_result = check_system_health()
        
        # ä¿å­˜çµæœ
        os.makedirs('data/monitoring', exist_ok=True)
        with open('data/monitoring/health_status.json', 'w') as f:
            json.dump(health_result, f, indent=2)
        
        print(f'âœ… å¥åº·æª¢æŸ¥å®Œæˆï¼Œç‹€æ…‹: {health_result[\"overall_status\"]}')
        if health_result['issues']:
            print('âš ï¸ ç™¼ç¾å•é¡Œ:')
            for issue in health_result['issues']:
                print(f'  - {issue}')
        
        # è¨­ç½®è¼¸å‡º
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f'overall_status={health_result[\"overall_status\"]}\\n')
            f.write(f'btc_price={health_result[\"btc_price\"]}\\n')
        "
        
    - name: ğŸ“Š ç”Ÿæˆç›£æ§å ±å‘Š
      run: |
        echo "ğŸ“Š === AImax ç³»çµ±ç›£æ§å ±å‘Š ==="
        echo "ğŸ• æª¢æŸ¥æ™‚é–“: $(date)"
        echo "ğŸ¤– ç³»çµ±: AImax æ™ºèƒ½äº¤æ˜“ç³»çµ±"
        echo "â˜ï¸ ç’°å¢ƒ: GitHub Actions"
        echo "ğŸ“ˆ ç‹€æ…‹: ${{ steps.health_check.outputs.overall_status }}"
        echo "ğŸ’° BTCåƒ¹æ ¼: NT\$${{ steps.health_check.outputs.btc_price }}"
        echo "âœ… ç›£æ§æª¢æŸ¥å®Œæˆ"
        echo "ğŸ”„ ä¸‹æ¬¡æª¢æŸ¥: 5åˆ†é˜å¾Œ"
        
    - name: ğŸ“¤ ä¿å­˜ç›£æ§æ•¸æ“š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: monitoring-data-${{ github.run_number }}
        path: data/monitoring/
        retention-days: 3